<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carbon Emission Management System - EMS (Enhanced)</title>
    <link rel="stylesheet" href="variables.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="animations.css">
    <link rel="stylesheet" href="ai-assistant.css">
    <link rel="stylesheet" href="improvements.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        
        <nav class="navbar">
            <div class="nav-brand">
                <i class="fas fa-leaf"></i>
                <span>Carbon Emission Management System (Enhanced)</span>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" data-module="upload">Document Upload</button>
                <button class="nav-tab" data-module="kanban">Kanban Analysis</button>
                <button class="nav-tab" data-module="lean">Lean Optimization</button>
                <button class="nav-tab" data-module="scrum">Scrum Execution</button>
            </div>
        </nav>

        
        <main class="main-content">
            
            <div id="upload-module" class="module active">
                <div class="module-header">
                    <h2><i class="fas fa-upload"></i> Product Design Proposal Upload</h2>
                    <p>Upload your product design proposal, the system will automatically analyze carbon emissions and optimize production processes</p>

                </div>
                
                <div class="upload-section">
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>Drag files here or click to upload</h3>
                        <p>Supports PDF, DOC, DOCX, TXT formats</p>
                        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt" hidden>
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            Select File
                        </button>
                    </div>
                    
                    <div class="uploaded-files" id="uploadedFiles" style="display: none;">
                        <h4>Uploaded Files</h4>
                        <div class="file-list" id="fileList"></div>
                    </div>
                </div>

                
                <div class="ai-supplement" id="aiSupplement" style="display: none;">
                    
                    <div class="ai-status-panel" id="aiStatusPanel">
                        <div class="status-header">
                            <i class="fas fa-robot"></i>
                            <span>AI Document Analysis Assistant</span>
                            <div class="status-indicator" id="statusIndicator">
                                <span class="status-dot analyzing"></span>
                                <span class="status-text">Analyzing...</span>
                            </div>
                        </div>
                        <div class="analysis-progress" id="analysisProgress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="progressText">Starting document analysis...</div>
                        </div>
                    </div>

                    
                    <div class="analysis-results-panel" id="analysisResultsPanel" style="display: none;">
                        <div class="results-header">
                            <i class="fas fa-chart-line"></i>
                            <span>Analysis Results</span>
                        </div>
                        <div class="analysis-summary" id="analysisSummary"></div>
                    </div>

                    
                    <div class="supplement-panel" id="supplementPanel" style="display: none;">
                        <div class="supplement-header">
                            <i class="fas fa-edit"></i>
                            <span>Information Supplement</span>
                            
                            <div class="supplement-mode-toggle" style="display: none;">
                                <button class="mode-btn active" id="autoModeBtn" onclick="switchToAutoMode()">
                                    <i class="fas fa-magic"></i> Auto Complete
                                </button>
                                <button class="mode-btn" id="manualModeBtn" onclick="switchToManualMode()">
                                    <i class="fas fa-comments"></i> Manual Q&A
                                </button>
                            </div>
                        </div>
                        
                        
                        <div class="auto-mode" id="autoMode">
                            <div class="auto-mode-content">
                                <div class="auto-description">
                                    <i class="fas fa-wand-magic-sparkles"></i>
                                    <h4>AI One-Click Complete</h4>
                                    <p>Let AI automatically fill in all missing information based on document analysis</p>
                                </div>
                                <div class="missing-fields-preview" id="missingFieldsPreview"></div>
                                <button class="btn btn-primary btn-large" id="autoCompleteBtn" onclick="autoCompleteAllFields()">
                                    <i class="fas fa-magic"></i> Start Auto Complete
                                </button>
                            </div>
                        </div>

                        
                        <div class="manual-mode" id="manualMode" style="display: none !important;">
                            <div class="manual-description">
                                <i class="fas fa-comments"></i>
                                <h4>Manual Q&A Mode</h4>
                                <p>Answer questions step by step for more precise control</p>
                            </div>
                            <div class="chat-container">
                                <div class="chat-messages" id="chatMessages"></div>
                                <div class="chat-input">
                                    <input type="text" id="chatInput" placeholder="Type your answer here...">
                                    <button class="btn btn-primary" onclick="sendMessage()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    
                    <div class="completion-results-panel" id="completionResultsPanel" style="display: none;">
                        <div class="results-header">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Information Completed</span>
                        </div>
                        <div class="completed-data" id="completedData"></div>
                    </div>

                    
                    <div class="action-panel">
                        <div class="action-buttons">
                            <button class="btn btn-success btn-large" id="startAnalysis" onclick="startAnalysis()" disabled
                                    style="background: linear-gradient(135deg, #34C759 0%, #2FB954 100%) !important; 
                                           color: #FFFFFF !important; 
                                           border: none !important;
                                           display: none !important; 
                                           padding: 12px 24px !important;
                                           font-size: 16px !important;
                                           font-weight: 600 !important;
                                           border-radius: 12px !important;
                                           min-width: 180px !important;
                                           align-items: center !important;
                                           gap: 8px !important;
                                           cursor: pointer !important;
                                           opacity: 1 !important;">
                                <i class="fas fa-play" style="color: #FFFFFF !important;"></i> Start Carbon Analysis
                            </button>
                            <button class="btn btn-secondary" id="downloadBtn" onclick="downloadCompletedDocument()" style="display: none;">
                                <i class="fas fa-download"></i> Download Report
                            </button>
                            <button class="btn btn-outline" id="resetBtn" onclick="resetAssistant()" style="display: none;">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            
            <div id="kanban-module" class="module">
                <div class="module-header">
                    <h2><i class="fas fa-chart-line"></i> Kanban Carbon Emission Analysis</h2>
                    <p>Product lifecycle carbon emission prediction and reverse timeline display</p>

                </div>
                
                <div class="timeline-container">
                    <div class="reverse-timeline" id="reverseTimeline">
                        
                    </div>
                </div>
                
                <div class="emission-analysis">
                    <h3>Carbon Emission Analysis by Stage</h3>
                    <div class="emission-cards" id="emissionCards">
                        
                    </div>
                </div>
            </div>

            
            <div id="lean-module" class="module">
                <div class="module-header">
                    <h2><i class="fas fa-lightbulb"></i> Lean Optimization Analysis</h2>
                    <p>In-depth analysis of high emission causes and optimization recommendations</p>

                </div>
                
                <div class="analysis-content" id="leanAnalysis">
                    
                </div>
            </div>

            
            <div id="scrum-module" class="module">
                <div class="module-header">
                    <h2><i class="fas fa-tasks"></i> Scrum Execution Tracking</h2>
                    <p>Task allocation and progress monitoring for all departments</p>

                </div>
                
                

                
                <div class="scrum-content" id="scrumContent">
                    
                    <div class="scrum-view" id="gantt-view" style="display: block;">
                        <div class="gantt-container">
                            <div class="gantt-header">
                                <h3><i class="fas fa-chart-gantt"></i> Project Gantt Chart</h3>
                                <div class="gantt-controls">
                                    <button class="btn btn-primary" onclick="adjustGanttZoom('day')">Day View</button>
                                    <button class="btn btn-secondary" onclick="adjustGanttZoom('week')">Week View</button>
                                </div>
                            </div>
                            <div class="gantt-chart" id="ganttChart">
                                
                            </div>
                            <div id="scrumDebugPanel" class="scrum-debug" style="display:none; margin-top:10px; background:#fff3cd; border:1px solid #ffeaa7; padding:8px; border-radius:6px;"></div>
                        </div>
                    </div>


                </div>


            </div>
        </main>
    </div>

    
    <div class="modal" id="aiModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-robot"></i> AI Analysis Assistant</h3>
                <button class="close-btn" onclick="closeAiModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="selected-data" id="selectedData"></div>
                <div class="ai-question">
                    <label for="aiQuestion">Please enter your question:</label>
                    <textarea id="aiQuestion" placeholder="For example: Why is the emission level so high in this stage?"></textarea>
                    <button class="btn btn-primary" onclick="askAI()">Ask AI</button>
                </div>
                <div class="ai-response" id="aiResponse" style="display: none;"></div>
            </div>
        </div>
    </div>

    
    <div id="bottomAIChat" class="bottom-ai-chat" style="display:none;">
        <div class="bottom-ai-header">
            <div class="bottom-ai-title"><i class="fas fa-robot"></i> Intelligent Assistant</div>
            <div class="bottom-ai-actions">
                <button class="bottom-ai-btn" id="pinBottomAI">Pin</button>
                <button class="bottom-ai-btn" id="collapseBottomAI">Collapse</button>
            </div>
        </div>
        <div class="bottom-ai-body">
            <div class="bottom-ai-messages" id="bottomAIMessages"></div>
            <div class="bottom-ai-input">
                <textarea id="bottomAIInput" placeholder="Ask AI (Enter to send, Shift+Enter for new line)"></textarea>
                <button class="btn btn-primary" id="bottomAISend">Send</button>
            </div>
        </div>
    </div>

    
    <div id="askAISelectionBubble" class="ask-ai-bubble" style="display:none;">
        <i class="fas fa-robot"></i>
        Ask AI
    </div>

    
    <script src="https://unpkg.com/mammoth@1.4.21/mammoth.browser.min.js"></script>
    
    
    <script>
        // Pre-rewrite selectSolutionArea function
        window.selectSolutionArea = async function(area) {
            console.log('Rewritten selectSolutionArea called:', area);
            
            // Save currently selected area
            if (window.currentSelectedArea !== undefined) {
                window.currentSelectedArea = area;
            }

            // Highlight selected item
            document.querySelectorAll('.solution-area-card').forEach(item => {
                item.classList.remove('selected');
            });
            const selectedCard = document.querySelector(`[data-area="${area}"]`);
            if (selectedCard) selectedCard.classList.add('selected');
            
            // Show analysis area
            const selectedAnalysis = document.getElementById('selectedAnalysis');
            const optimizationSection = document.getElementById('optimizationSection');
            if (selectedAnalysis) selectedAnalysis.style.display = 'block';
            if (optimizationSection) optimizationSection.style.display = 'block';
            
            // Show loading state
            const suggestionsDiv = document.getElementById('suggestionsContent');
            if (suggestionsDiv) {
                suggestionsDiv.innerHTML = '<div class="loading-suggestions"><i class="fas fa-spinner fa-spin"></i> AI is analyzing, generating personalized recommendations...</div>';
            }
            
            // Directly call AI generation function
            try {
                console.log('Starting to call AI generation function');
                if (typeof window.generatePersonalizedSuggestions === 'function') {
                    await window.generatePersonalizedSuggestions(area);
                } else {
                    console.error('generatePersonalizedSuggestions function not defined');
                }
            } catch (error) {
                console.error('AI generation failed:', error);
            }
        };
    </script>
    
    <script src="config.js"></script>
    <script src="script.js"></script>
    <script>
        // Carbon emission management system improvement features
        
        // Global variables - Fix adoption status persistence issue
        // Use window object to avoid variable conflicts with script.js
        if (!window.acceptedSuggestions) {
            // Clear cache, reset state
            localStorage.removeItem('acceptedSuggestions');
            localStorage.removeItem('acceptedSuggestionsByArea');
            window.acceptedSuggestions = [];
        }
        if (!window.hasAcceptedSuggestions) {
            window.hasAcceptedSuggestions = false;
        }
        if (!window.acceptedSuggestionsByArea) {
            window.acceptedSuggestionsByArea = {};
        }
        if (!window.currentSelectedArea) {
            window.currentSelectedArea = null;
        }
        
        // Initialize global variables
        if (!window.acceptedSuggestions) {
            // Clear cache, reset state
            localStorage.removeItem('acceptedSuggestions');
            localStorage.removeItem('acceptedSuggestionsByArea');
            window.acceptedSuggestions = [];
        }
        if (!window.hasAcceptedSuggestions) {
            window.hasAcceptedSuggestions = false;
        }
        if (!window.acceptedSuggestionsByArea) {
            window.acceptedSuggestionsByArea = {};
        }
        if (!window.lastSuggestionsCache) {
            window.lastSuggestionsCache = {};
        }
        if (!window.currentSelectedArea) {
            window.currentSelectedArea = null;
        }

        // Initialize analysis data
        if (!window.analysisData) {
            window.analysisData = {
                emissions: {
                    procurement: { value: 80, originalValue: 80 },
                    manufacturing: { value: 120, originalValue: 120 },
                    logistics: { value: 45, originalValue: 45 },
                    usage: { value: 200, originalValue: 200 },
                    recycling: { value: 25, originalValue: 25 },
                    decomposition: { value: 10, originalValue: 10 }
                },
                timeline: {
                    procurement: { duration: 30, originalDuration: 30, unit: 'days' },
                    manufacturing: { duration: 45, originalDuration: 45, unit: 'days' },
                    logistics: { duration: 7, originalDuration: 7, unit: 'days' },
                    usage: { duration: 730, originalDuration: 730, unit: 'days' },
                    recycling: { duration: 60, originalDuration: 60, unit: 'days' },
                    decomposition: { duration: 1825, originalDuration: 1825, unit: 'days' }
                }
            };
        }

        // Apply cumulative improvement effects after page load
        document.addEventListener('DOMContentLoaded', function() {
            // If there are adopted suggestions, apply cumulative effects
            if (window.acceptedSuggestions && window.acceptedSuggestions.length > 0) {
                setTimeout(() => {
                    if (typeof window.updateAllDataCards === 'function') {
                        window.updateAllDataCards();
                    }
                }, 500);
            }
            
            // Render data cards
            if (typeof renderDataCards === 'function') {
                renderDataCards();
            }
        });

        // Improvement 1: AI assistant refresh functionality
        function refreshFieldContent(fieldName) {
            const fieldElement = document.querySelector(`[data-field="${fieldName}"] .field-value`);
            if (!fieldElement) return;
            
            // Show loading state
            fieldElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI regenerating...';
            
            // Simulate AI content regeneration
            setTimeout(() => {
                const newContent = generateSmartFieldContent(fieldName);
                fieldElement.textContent = newContent;
                fieldElement.setAttribute('data-original', newContent);
                
                // Update stored data
                if (window.supplementData) {
                    window.supplementData[fieldName] = newContent;
                }
                
                // Show success message
                addAIMessage(`🔄 "${fieldName}"has been regenerated: ${newContent}`);
            }, 1500);
        }

        // Generate intelligent content based on field type
        function generateSmartFieldContent(fieldName) {
            const documentType = window.currentAnalysis?.documentType || 'general';
            
            const smartContentGenerators = {
                'Supplier Geographical Location Information': () => {
                    const locations = ['Jiangsu Suzhou', 'Guangdong Shenzhen', 'Zhejiang Hangzhou', 'Shandong Qingdao', 'Hebei Shijiazhuang', 'Hubei Wuhan'];
                    const selected = locations[Math.floor(Math.random() * locations.length)];
                    return `${selected} (Based on ${getDocumentTypeName(documentType)} industry cluster analysis)`;
                },
                'Raw Material Specifications and Sources': () => {
                    const materials = {
                        electronics: ['Chip-TSMC', 'Metal Shell-Foxconn', 'Battery-CATL'],
                        textile: ['Organic Cotton-Xinjiang', 'Eco-friendly Dye-BASF Germany', 'Recycled Fiber-Toray Japan'],
                        automotive: ['Steel-Baosteel Group', 'Rubber-Michelin', 'Battery-BYD'],
                        general: ['Steel-Baosteel Group', 'Plastic-Sinopec', 'Electronic Components-Foxconn']
                    };
                    const typeMatrials = materials[documentType] || materials.general;
                    return typeMatrials.join(', ');
                },
                'Detailed Production Process Flow': () => {
                    const processes = {
                        electronics: 'Chip Packaging→Circuit Board Assembly→Shell Assembly→System Testing→Quality Inspection',
                        textile: 'Fiber Processing→Spinning and Weaving→Dyeing and Printing→Cutting and Sewing→Quality Testing',
                        automotive: 'Stamping Forming→Welding Assembly→Coating Treatment→Final Assembly and Debugging→Road Testing',
                        general: 'Raw Material Preprocessing→Precision Machining→Quality Testing→Assembly Integration→Packaging and Storage'
                    };
                    return processes[documentType] || processes.general;
                },
                'Logistics Transportation Methods and Routes': () => {
                    const logistics = [
                        'Mainly road transport, average distance ' + (Math.floor(Math.random() * 200) + 200) + 'km',
                        'Railway+road combined transport, green logistics ratio ' + (Math.floor(Math.random() * 30) + 20) + '%',
                        'Multimodal transport, sea+land combined, cost optimization ' + (Math.floor(Math.random() * 15) + 10) + '%'
                    ];
                    return logistics[Math.floor(Math.random() * logistics.length)];
                },
                'Product Usage Scenarios and Lifecycle': () => {
                    const scenarios = {
                        electronics: `Consumer electronics, typical lifespan ${Math.floor(Math.random() * 5) + 3}-${Math.floor(Math.random() * 3) + 8} years`,
                        textile: `Daily clothing, recommended wearing cycle ${Math.floor(Math.random() * 24) + 12} months`,
                        automotive: `Transportation vehicle, lifespan ${Math.floor(Math.random() * 5) + 8}-${Math.floor(Math.random() * 5) + 12} years`,
                        general: `General product, typical lifespan ${Math.floor(Math.random() * 3) + 3}-${Math.floor(Math.random() * 3) + 6} years`
                    };
                    return scenarios[documentType] || scenarios.general;
                }
            };
            
            const generator = smartContentGenerators[fieldName];
            if (generator) {
                return generator();
            }
            
            // Default generation
            return `${fieldName} information regenerated based on ${getDocumentTypeName(documentType)} industry characteristics`;
        }

        // 改进2: 对话记录功能
        if (!window.aiChatHistory) {
            window.aiChatHistory = {
                kanban: [],
                lean: []
            };
        }

        // 立即重写函数，不等待DOM加载
        (function() {
            // 重写displayAutoCompletedData函数以添加刷新按钮
            const originalDisplayAutoCompletedData = window.displayAutoCompletedData;
            
            if (originalDisplayAutoCompletedData) {
                window.displayAutoCompletedData = function(data) {
                    const chatMessages = document.getElementById('chatMessages');
                    const autoCompletedDiv = document.createElement('div');
                    autoCompletedDiv.className = 'message ai auto-completed-data';
                    autoCompletedDiv.id = 'autoCompletedData';
                    
                    let content = '<div class="auto-completed-header"><i class="fas fa-magic"></i> <strong>AI Auto-completion Results:</strong></div>';
                    
                    Object.entries(data).forEach(([key, value]) => {
                        content += `
                            <div class="auto-completed-item" data-field="${key}">
                                <div class="field-label"><strong>${key}:</strong></div>
                                <div class="field-value" contenteditable="true" data-original="${value}">${value}</div>
                                <div class="field-actions">
                                    <button class="btn-mini btn-edit" onclick="editField('${key}')" title="Edit Field">
                                        <i class="fas fa-edit"></i>
                                    </button>

                                    <button class="btn-mini btn-reset" onclick="resetField('${key}')" title="Reset to Recommended Value">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    autoCompletedDiv.innerHTML = content;
                    chatMessages.appendChild(autoCompletedDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                };
            }

            // 增强的AI对话模态框
            const originalOpenAIModal = window.openAIModal;
            if (originalOpenAIModal) {
                window.openAIModal = function(emissionType, emissionData) {
                    selectedEmissionData = { type: emissionType, data: emissionData };
                    
                    const modal = document.getElementById('aiModal');
                    const selectedDataDiv = document.getElementById('selectedData');
                    
                    const typeNames = {
                        procurement: 'Raw Material Procurement',
                        manufacturing: 'Manufacturing',
                        logistics: 'Logistics Transportation',
                        usage: 'Product Usage',
                        recycling: 'Recycling Processing',
                        decomposition: 'Natural Decomposition'
                    };
                    
                    // 确定当前模块
                    const currentModule = document.querySelector('.nav-tab.active')?.dataset.module || 'kanban';

                    // 在Kanban模块中不弹出AI Analysis Assistant
                    if (currentModule === 'kanban') {
                        return;
                    }
                    
                    selectedDataDiv.innerHTML = `
                        <h4>Selected Data: ${typeNames[emissionType]}</h4>
                        <p>Carbon Emission Value: <strong>${emissionData.value}</strong></p>
                        <p>Emission Level: <strong>${emissionData.level === 'high' ? 'High' : emissionData.level === 'medium' ? 'Medium' : 'Low'}</strong></p>
                        
                        <div class="chat-history" id="chatHistory">
                            <h5><i class="fas fa-history"></i> Chat History</h5>
                            <div class="history-messages" id="historyMessages">
                                ${renderChatHistory(currentModule, emissionType)}
                            </div>
                        </div>
                    `;
                    
                    // 设置当前模块类型
                    modal.setAttribute('data-module', currentModule);
                    modal.setAttribute('data-emission-type', emissionType);
                    
                    modal.style.display = 'flex';
                };
            }

            // 增强的AI询问功能
            const originalAskAI = window.askAI;
            if (originalAskAI) {
                window.askAI = async function() {
                    const questionInput = document.getElementById('aiQuestion');
                    if (!questionInput) {
                        alert('Cannot find question input box');
                        return;
                    }
                    
                    const question = questionInput.value.trim();
                    if (!question) {
                        alert('Please enter your question');
                        return;
                    }
                    
                    const modal = document.getElementById('aiModal');
                    if (!modal) {
                        alert('Cannot find AI dialog box');
                        return;
                    }
                    
                    const moduleType = modal.getAttribute('data-module') || 'kanban';
                    const emissionType = modal.getAttribute('data-emission-type');
                    const mode = modal.getAttribute('data-mode');
                    
                    const responseDiv = document.getElementById('aiResponse');
                    if (responseDiv) {
                        responseDiv.style.display = 'block';
                        responseDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI is analyzing...';
                    }
                    
                    try {
                        let response;
                        if (mode === 'suggestion-consult') {
                            // 深度分析AI助手模式
                            response = await callSuggestionAI(question, window.currentConsultSuggestion);
                        } else {
                            // 普通AI分析模式
                            response = await callAI(question, selectedEmissionData);
                        }
                        
                        // 保存对话记录
                        saveAIChatHistory(moduleType, emissionType, question, response);
                        
                        responseDiv.innerHTML = `
                            <h4><i class="fas fa-lightbulb"></i> AI Analysis Result</h4>
                            <div class="ai-analysis">${response}</div>
                            <div class="action-buttons" style="margin-top: 1rem;">
                                <button class="btn btn-secondary" onclick="continueConversation()" style="margin-right: 0.5rem;">
                                    <i class="fas fa-comments"></i> Continue Inquiry
                                </button>
                                <button class="btn btn-primary" onclick="closeAiModal()">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        `;
                        
                        // 更新对话历史显示
                        updateChatHistoryDisplay(moduleType, emissionType);
                        
                    } catch (error) {
                        console.error('AI analysis failed:', error);
                        responseDiv.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> AI service is temporarily unavailable, please try again later.</div>`;
                    }
                };
            }

            // 使用新设计的Lean渲染（避免旧逻辑覆盖）
            window.__leanNewDesign = true;
            // 重写Lean模块的渲染函数以支持个性化建议和状态持久化
            const originalRenderLeanModule = window.renderLeanModule;
            if (originalRenderLeanModule && !window.__leanNewDesign) {
                window.renderLeanModule = function() {
                    const leanContent = document.getElementById('leanAnalysis');
                    
                    // 获取实际方案内容分析结果
                    const solutionAnalysis = getSolutionAnalysisResults();
                    
                    // 获取碳排放卡片数据
                    const emissionCardsHtml = generateEmissionCardsForLean();
                    
                    leanContent.innerHTML = `
                        <div class="solution-analysis-section">
                            <h3><i class="fas fa-file-alt"></i> Solution Content Analysis</h3>
                            <div class="solution-analysis-results">
                                ${solutionAnalysis.map(analysis => {
                                    const classMap = {
                                        'Material Selection': 'material-optimization',
                                        'Production Process': 'process-improvement', 
                                        'Supply Chain Management': 'management-enhancement',
                                        'Product Design': 'tech-innovation',
                                        'Packaging Solution': 'material-optimization'
                                    };
                                    const isSelected = window.currentSelectedArea === analysis.area;
                                    // 移除has-accepted样式，方案内容分析区域不因采纳建议而变色
                                    return `
                                    <div class="solution-area-card ${classMap[analysis.area] || 'tech-innovation'} ${isSelected ? 'selected' : ''}" onclick="selectSolutionArea('${analysis.area}')" data-area="${analysis.area}">
                                        <h4>
                                            <i class="${analysis.icon} area-icon"></i>
                                            ${analysis.area}
                                        </h4>
                                        <p>${analysis.currentStatus}</p>
                                        <div class="improvement-potential">Improvement Potential: ${analysis.improvementPotential}</div>
                                    </div>
                                `}).join('')}
                            </div>
                            <div class="selection-hint">
                                <i class="fas fa-hand-pointer"></i> Click any solution domain for in-depth analysis
                            </div>
                        </div>
                        
                        <div class="analysis-section" id="selectedAnalysis" style="display: ${window.currentSelectedArea ? 'block' : 'none'};">
                            <h3><i class="fas fa-search"></i> Solution Domain In-depth Analysis</h3>
                            <div id="optimizationSection">
                                <h3><i class="fas fa-lightbulb"></i> Optimization Suggestions</h3>
                                <div class="suggestions" id="suggestionsContent">
                                    ${window.currentSelectedArea ? '<div class="loading-suggestions"><i class="fas fa-spinner fa-spin"></i> Loading suggestions...</div>' : ''}
                                </div>
                            </div>
                        </div>

                        
                        <div class="detailed-data-section">
                            <h3><i class="fas fa-chart-bar"></i> Time and Carbon Emission Data</h3>
                            <div class="data-container">
                                <div class="emission-data-block">
                                    <h4><i class="fas fa-leaf"></i> Carbon Emission Data</h4>
                                    <div class="emission-cards-lean">
                                        ${emissionCardsHtml}
                                    </div>
                                </div>
                                <div class="timeline-data-block">
                                    <h4><i class="fas fa-clock"></i> Time Data</h4>
                                    <div class="timeline-cards-lean">
                                        ${generateTimelineCardsHtml()}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="lean-to-scrum-action-section">
                            <h3><i class="fas fa-arrow-right"></i> Next Step: Enter Scrum Execution</h3>
                            <p>After completing Lean optimization analysis, you can convert adopted suggestions into Scrum tasks for project execution and tracking.</p>
                            <button class="btn btn-primary btn-large" onclick="goToScrumExecution()">
                                <i class="fas fa-tasks"></i> Go to Scrum Execution
                            </button>
                        </div>
                    `;
                    
                    // 如果有选中的领域，异步加载建议内容
                    if (window.currentSelectedArea) {
                        // 如果有缓存的建议，直接渲染
                        if (window.lastSuggestionsCache && window.lastSuggestionsCache[window.currentSelectedArea]) {
                            window.renderSuggestions(window.currentSelectedArea, window.lastSuggestionsCache[window.currentSelectedArea]);
                        } else {
                            // 否则重新生成建议
                            setTimeout(() => {
                                if (typeof window.generatePersonalizedSuggestions === 'function') {
                                    window.generatePersonalizedSuggestions(window.currentSelectedArea);
                                }
                            }, 100);
                        }
                    }
                };
            }



                    // 重写选择方案领域函数
        const originalSelectSolutionArea = window.selectSolutionArea;
        if (originalSelectSolutionArea) {
            window.selectSolutionArea = async function(area) {
                console.log('Selected solution domain:', area);
                
                // 保存当前选中领域
                window.currentSelectedArea = area;

                // 高亮选中的项目
                document.querySelectorAll('.solution-area-card').forEach(item => {
                    item.classList.remove('selected');
                });
                const selectedCard = document.querySelector(`[data-area="${area}"]`);
                if (selectedCard) selectedCard.classList.add('selected');
                
                // 显示分析区域
                const selectedAnalysis = document.getElementById('selectedAnalysis');
                const optimizationSection = document.getElementById('optimizationSection');
                if (selectedAnalysis) selectedAnalysis.style.display = 'block';
                if (optimizationSection) optimizationSection.style.display = 'block';
                

                
                // Show loading state
                const suggestionsDiv = document.getElementById('suggestionsContent');
                if (suggestionsDiv) {
                    // 若有缓存则直接渲染，不再显示加载与重新生成
                    if (window.lastSuggestionsCache && window.lastSuggestionsCache[area]) {
                        window.renderSuggestions(area, window.lastSuggestionsCache[area]);
                        return; // 使用缓存并保持采纳状态
                    } else {
                        suggestionsDiv.innerHTML = '<div class="loading-suggestions"><i class="fas fa-spinner fa-spin"></i> AI正在分析中，生成个性化建议...</div>';
                    }
                }
                
                // Directly call AI generation function
                try {
                    console.log('Starting to call AI generation function');
                    await window.generatePersonalizedSuggestions(area);
                } catch (error) {
                    console.error('AI generation failed:', error);
                    const suggestionsDiv = document.getElementById('suggestionsContent');
                    if (suggestionsDiv) {
                        suggestionsDiv.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> AI service is temporarily unavailable, please try again later.</div>';
                    }
                }
            };
        }

            // 重写采纳建议函数以支持状态持久化
            const originalAcceptSuggestion = window.acceptSuggestion;
            if (originalAcceptSuggestion) {
                window.acceptSuggestion = function(suggestionTitle, event) {
                    // 添加到已采纳建议列表
                    if (!window.acceptedSuggestions.includes(suggestionTitle)) {
                        window.acceptedSuggestions.push(suggestionTitle);
                        window.hasAcceptedSuggestions = true;
                        // 按领域存储已采纳建议
                        if (window.currentSelectedArea) {
                            if (!window.acceptedSuggestionsByArea[window.currentSelectedArea]) {
                                window.acceptedSuggestionsByArea[window.currentSelectedArea] = [];
                            }
                            window.acceptedSuggestionsByArea[window.currentSelectedArea].push(suggestionTitle);
                        }
                        // 持久化存储
                        localStorage.setItem('acceptedSuggestions', JSON.stringify(window.acceptedSuggestions));
                        localStorage.setItem('acceptedSuggestionsByArea', JSON.stringify(window.acceptedSuggestionsByArea));
                        
                        // 使用累积计算更新所有数据卡片（确保时间与碳排先写入数据，再统一刷新UI）
                        if (typeof window.updateAllDataCards === 'function') {
                            window.updateAllDataCards();
                        } else if (typeof window.refreshLeanTimelineData === 'function') {
                            // 兜底：仅刷新时间卡片
                            window.refreshLeanTimelineData();
                        }

                        
                        // 更新当前建议卡片的显示状态
                        updateSuggestionCardStatus(suggestionTitle);
                    }
                    
                    // Show success message
                    const button = event ? event.target : window.event?.target;
                    if (button) {
                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check"></i> 已采纳';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-secondary');
                        button.disabled = true;
                    }
                    
                    // 显示一键执行按钮
                    showExecuteAllButton();
                };
            }

            // 更新建议卡片状态的函数
            function updateSuggestionCardStatus(suggestionTitle) {
                const suggestionCard = document.querySelector(`[data-suggestion-title="${suggestionTitle}"]`);
                if (suggestionCard) {
                    suggestionCard.classList.add('accepted');
                    const button = suggestionCard.querySelector('.btn-success');
                    if (button) {
                        button.innerHTML = '<i class="fas fa-check"></i> 已采纳';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-secondary');
                        button.disabled = true;
                    }
                }
            }



            // 重写咨询AI建议函数
            const originalConsultAIForSuggestion = window.consultAIForSuggestion;
            if (originalConsultAIForSuggestion) {
                window.consultAIForSuggestion = function(suggestionTitle, suggestionDesc) {
                    // 设置当前咨询的建议信息
                    window.currentConsultSuggestion = {
                        title: suggestionTitle,
                        description: suggestionDesc
                    };
                    
                    // 复用现有的AI模态框
                    const modal = document.getElementById('aiModal');
                    const selectedDataDiv = document.getElementById('selectedData');
                    
                    // 设置建议咨询的内容
                    selectedDataDiv.innerHTML = `
                        <div class="suggestion-consult-header">
                            <h4><i class="fas fa-lightbulb text-warning"></i> Suggestion Consultation: ${suggestionTitle}</h4>
                            <div class="suggestion-description">
                                <p><strong>Suggestion Content:</strong></p>
                                <p class="text-muted">${suggestionDesc}</p>
                            </div>
                        </div>
                        
                        <div class="ai-consult-guide">
                            <h5><i class="fas fa-robot text-primary"></i> AI Assistant can help you:</h5>
                            <ul class="consult-options">
                                <li><i class="fas fa-check-circle text-success"></i> Analyze feasibility and risks of the suggestion</li>
                                <li><i class="fas fa-list-ol text-info"></i> Provide detailed implementation steps</li>
                                <li><i class="fas fa-chart-line text-warning"></i> Evaluate expected improvement effects</li>
                                <li><i class="fas fa-star text-primary"></i> Recommend related best practices</li>
                            </ul>
                        </div>
                        
                        <div class="chat-history" id="chatHistory">
                            <h5><i class="fas fa-comments"></i> Consultation Dialogue</h5>
                            <div class="history-messages" id="historyMessages">
                                <div class="ai-welcome-message">
                                    <div class="message-avatar ai-avatar">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="message-content">
                                        Hello! I'm the AI assistant. Regarding the suggestion "${suggestionTitle}", please tell me what you would like to know? I will provide you with professional analysis and recommendations.
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 设置模态框属性
                    modal.setAttribute('data-mode', 'suggestion-consult');
                    modal.setAttribute('data-suggestion-title', suggestionTitle);
                    modal.setAttribute('data-module', 'lean');
                    modal.setAttribute('data-emission-type', 'suggestion');
                    
                    // 显示模态框
                    modal.style.display = 'flex';
                    
                    // 清空并聚焦问题输入框
                    const questionInput = document.getElementById('aiQuestion');
                    questionInput.value = '';
                    questionInput.placeholder = 'Please enter your question about this suggestion...';
                    setTimeout(() => {
                        questionInput.focus();
                    }, 300);
                };
            }
        })();

        // 生成个性化建议函数 - 使用真实AI API
        window.generatePersonalizedSuggestions = async function(area) {
            console.log('Starting to generate personalized suggestions:', area);
            
            const suggestionsDiv = document.getElementById('suggestionsContent');
            if (!suggestionsDiv) {
                console.error('Cannot find suggestionsContent element');
                return;
            }

            // Show loading state
            suggestionsDiv.innerHTML = `
                <div class="loading-suggestions">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>AI is analyzing the ${area} domain, generating personalized optimization suggestions...</p>
                </div>
            `;

            try {
                // 获取当前文档和产品信息
                const documentContent = window.documentAIContent?.content || '';
                const supplementData = window.supplementData || {};
                const productType = window.currentAnalysis?.documentType || 'general';
                const productTypeName = getDocumentTypeName(productType);
                
                console.log('Product information:', {
                    productType,
                    productTypeName,
                    documentContentLength: documentContent.length,
                    supplementDataKeys: Object.keys(supplementData)
                });

                // 准备子模块映射与基线（来自全局analysisData）
                const analysisData = window.analysisData || {};
                const carbonMapCN = {
                    procurement: 'Raw Material Procurement',
                    manufacturing: 'Manufacturing',
                    logistics: 'Logistics',
                    usage: 'Product Usage',
                    recycling: 'Recycling Processing',
                    decomposition: 'Natural Decomposition'
                };
                const timeMapCN = {
                    procurement: 'Raw Material Procurement',
                    manufacturing: 'Manufacturing',
                    logistics: 'Logistics',
                    usage: 'Product Usage',
                    recycling: 'Recycling Processing',
                    decomposition: 'Natural Decomposition'
                };
                const carbonBaseline = {
                    procurement: analysisData?.emissions?.procurement?.value ?? null,
                    manufacturing: analysisData?.emissions?.manufacturing?.value ?? null,
                    logistics: analysisData?.emissions?.logistics?.value ?? null,
                    usage: analysisData?.emissions?.usage?.value ?? null,
                    recycling: analysisData?.emissions?.recycling?.value ?? null,
                    decomposition: analysisData?.emissions?.decomposition?.value ?? null
                };
                const timeBaseline = {
                    procurement: analysisData?.timeline?.procurement?.duration ?? null,
                    manufacturing: analysisData?.timeline?.manufacturing?.duration ?? null,
                    logistics: analysisData?.timeline?.logistics?.duration ?? null,
                    usage: analysisData?.timeline?.usage?.duration ?? null,
                    recycling: analysisData?.timeline?.recycling?.duration ?? null,
                    decomposition: analysisData?.timeline?.decomposition?.duration ?? null
                };

                // 构建AI提示词 - 明确子模块与基线，并要求返回实施后的新值（更严格的数值规范、且不返回人类可读浓缩字段）
                const prompt = `As a carbon emission management and lean production expert, please generate 3 specific optimization suggestions for the ${area} domain of ${productTypeName} products.

【Product Information】:
Product Type: ${productTypeName}
Document Content: ${documentContent.substring(0, 300)}...
Supplementary Information: ${Object.entries(supplementData).map(([key, value]) => `${key}: ${value}`).join(', ')}

【Optimization Domain】: ${area}

【Sub-modules (Key→English Name)】
Carbon Emissions: ${JSON.stringify(carbonMapCN)}
Time: ${JSON.stringify(timeMapCN)}

【Current Baseline (Strictly Unified Units)】
Carbon Emissions (kgCO2e): ${JSON.stringify(carbonBaseline)}
Time (days): ${JSON.stringify(timeBaseline)}

Please provide the following information for each suggestion (JSON format):
{
  "suggestions": [
    {
      "icon": "Corresponding FontAwesome icon class name",
      "title": "Suggestion title",
      "desc": "Detailed suggestion description (no need to return any human-readable summary fields)",
      "subProject": "Sub-project name",
      // Required: New values after implementation (must include all keys; units consistent with baseline)
      "carbonAfter": { "procurement": 0, "manufacturing": 0, "logistics": 0, "usage": 0, "recycling": 0, "decomposition": 0 },
      "timeAfter": { "procurement": 0, "manufacturing": 0, "logistics": 0, "usage": 0, "recycling": 0, "decomposition": 0 },
      // Optional: If providing improvements, must be strictly consistent with after values (system will verify), otherwise don't return improvements
      "carbonImprovements": { "procurement": 0, "manufacturing": 0, "logistics": 0, "usage": 0, "recycling": 0, "decomposition": 0 },
      "timeImprovements": { "procurement": 0, "manufacturing": 0, "logistics": 0, "usage": 0, "recycling": 0, "decomposition": 0 }
    }
  ]
}

Requirements (must strictly comply):
1) Sub-modules and units: All after values must correspond one-to-one with baseline keys, units strictly consistent (carbon=kgCO2e, time=days).
2) Data validity:
   - timeAfter keys must be positive integers (>=1); no negative numbers/0/percentages/strings.
   - carbonAfter keys must be non-negative numbers (>=0), can retain 1 decimal place; no negative numbers/percentages/strings.
   - For unaffected keys, set after to the same value as baseline.
3) Reasonable range (please make conservative estimates based on baseline and avoid unreasonable values):
   - timeAfter[k] should be within [max(1, round(baseline[k]*0.5)), round(baseline[k]*1.3)] range.
   - carbonAfter[k] should be within [0, baseline[k]*1.3] range.
4) Calculation consistency (if providing improvements):
   - Use formula after = round(baseline * (1 - improvement/100)) (time rounded to days, carbon rounded to 1 decimal place).
   - improvement>0 indicates reduction (improvement), <0 indicates increase (trade-off).
   - Please ensure improvements are consistent with after (e.g., improvement=20, then after≈baseline*0.8).
5) Only return valid JSON; do not return the following human-readable summary fields: timeImprovement, carbonReduction (these are automatically calculated by the system through before/after comparison).
6) Please ensure carbonImprovements and timeImprovements keys correspond exactly to "Sub-modules (Key→English Name)", the system will display "Module name: Reduce/Increase X%" accordingly.
7) If lacking evidence, please set after to baseline values rather than speculation.
8) In titles and description text, please prioritize using three-stage terminology to express impact: "Production Stage"(procurement+manufacturing), "Distribution Stage"(logistics+usage), "End-of-life Stage"(recycling+decomposition); but JSON keys still strictly use six-stage key names.`;

                console.log('AI prompt:', prompt);

                // 调用真实AI API
                console.log('Starting AI API call...');
                const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.AI_API_KEY || 'YOUR_API_KEY_HERE'}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-v3',
                        messages: [{
                            role: 'user',
                            content: prompt
                        }],
                        max_tokens: 1500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    console.error('AI API response error:', response.status, response.statusText);
                    throw new Error('AI API调用失败');
                }

                const data = await response.json();
                console.log('AI API response data:', data);
                const aiResponse = data.choices[0].message.content;
                console.log('AI response content:', aiResponse);

                // 解析AI返回的JSON
                let suggestions;
                try {
                    // 尝试提取JSON部分
                    const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        console.log('Extracted JSON:', jsonMatch[0]);
                        suggestions = JSON.parse(jsonMatch[0]);
                        console.log('Parsed suggestions:', suggestions);
                        
                        // 验证数据格式
                        if (suggestions.suggestions && Array.isArray(suggestions.suggestions)) {
                            suggestions.suggestions.forEach((suggestion, index) => {
                                // 确保有改进百分比数据
                                if (!suggestion.carbonImprovements || !suggestion.timeImprovements) {
                                    console.warn(`Suggestion ${index + 1} lacks improvement percentage data, using default values`);
                                    suggestion.carbonImprovements = {
                                        procurement: 10,
                                        manufacturing: 15,
                                        logistics: 8,
                                        usage: 20,
                                        recycling: 5,
                                        decomposition: 2
                                    };
                                    suggestion.timeImprovements = {
                                        procurement: 10,
                                        manufacturing: 15,
                                        logistics: 5,
                                        usage: 8,
                                        recycling: 12,
                                        decomposition: 5
                                    };
                                }
                                
                                // 验证百分比范围
                                Object.keys(suggestion.carbonImprovements).forEach(phase => {
                                    if (suggestion.carbonImprovements[phase] < -50 || suggestion.carbonImprovements[phase] > 100) {
                                        suggestion.carbonImprovements[phase] = Math.max(-50, Math.min(100, suggestion.carbonImprovements[phase]));
                                    }
                                });
                                
                                Object.keys(suggestion.timeImprovements).forEach(phase => {
                                    if (suggestion.timeImprovements[phase] < -50 || suggestion.timeImprovements[phase] > 100) {
                                        suggestion.timeImprovements[phase] = Math.max(-50, Math.min(100, suggestion.timeImprovements[phase]));
                                    }
                                });
                            });
                        }
                    } else {
                        console.error('JSON format content not found');
                        throw new Error('Unable to parse AI returned JSON');
                    }
                } catch (parseError) {
                    console.error('AI response content parsing failed:', parseError);
                    console.error('AI response content:', aiResponse);
                    throw parseError;
                }

                // 渲染建议
                console.log('Starting to render suggestions:', area, suggestions);
                
                // 缓存建议供后续使用
                if (!window.lastSuggestionsCache) window.lastSuggestionsCache = {};
                window.lastSuggestionsCache[area] = suggestions.suggestions || suggestions;
                
                renderSuggestions(area, suggestions.suggestions || suggestions);

            } catch (error) {
                console.error('AI API call failed:', error);
                const suggestionsDiv = document.getElementById('suggestionsContent');
                if (suggestionsDiv) {
                    suggestionsDiv.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i> AI service is temporarily unavailable, please try again later.</div>';
                }
            }
        }

        // 计算时间变化（基于AI结果）
        function computeTimeChangeSummary(suggestion) {
            const analysisData = window.analysisData || {};
            const timeline = analysisData.timeline || {};
            const keys = ['procurement','manufacturing','logistics','usage','recycling','decomposition'];
            // 以"当前值"为基线进行对比，而不是 originalDuration，避免受到历史采纳影响
            const beforeTotal = keys.reduce((sum, k) => sum + (timeline[k]?.duration || 0), 0);
            if (!beforeTotal) {
                return { isImprovement: true, displayText: 'Time: No Change' };
            }
            // 优先使用 timeAfter
            let afterTotal = 0;
            let hasAfter = suggestion && suggestion.timeAfter && typeof suggestion.timeAfter === 'object';
            if (hasAfter) {
                afterTotal = keys.reduce((sum, k) => {
                    const base = timeline[k]?.duration || 0;
                    const raw = suggestion.timeAfter[k];
                    let normalized;
                    if (typeof raw === 'number') {
                        if (raw > 0) {
                            // 视为"新值（绝对值）"
                            normalized = raw;
                        } else if (raw === 0) {
                            // 不变
                            normalized = base;
                        } else {
                            // 负数：视为"相对变化（天）"
                            normalized = Math.max(1, base + raw);
                        }
                    } else {
                        normalized = base;
                    }
                    return sum + normalized;
                }, 0);
            } else if (suggestion && suggestion.timeImprovements && typeof suggestion.timeImprovements === 'object') {
                afterTotal = keys.reduce((sum, k) => {
                    const base = timeline[k]?.duration || 0;
                    const pct = suggestion.timeImprovements[k];
                    if (typeof pct === 'number') {
                        const factor = 1 - (pct / 100);
                        return sum + Math.max(1, Math.round(base * factor));
                    }
                    return sum + base;
                }, 0);
            } else {
                return { isImprovement: true, displayText: 'Time: No Change' };
            }
            const delta = Math.round(beforeTotal - afterTotal);
            if (delta > 0) {
                return { isImprovement: true, displayText: `Time: Reduce ${delta} days` };
            } else if (delta < 0) {
                return { isImprovement: false, displayText: `Time: Increase ${Math.abs(delta)} days` };
            }
            return { isImprovement: true, displayText: 'Time: No Change' };
        }

        // 计算碳排放变化（基于AI结果）
        function computeCarbonChangeSummary(suggestion) {
            const analysisData = window.analysisData || {};
            const emissions = analysisData.emissions || {};
            const keys = ['procurement','manufacturing','logistics','usage','recycling','decomposition'];
            // 以"当前值"为基线进行对比
            const beforeTotal = keys.reduce((sum, k) => sum + (emissions[k]?.value || 0), 0);
            if (!beforeTotal) {
                return { isImprovement: true, displayText: 'Carbon Emissions: No Change' };
            }
            // 优先使用 carbonAfter
            let afterTotal = 0;
            const hasAfter = suggestion && suggestion.carbonAfter && typeof suggestion.carbonAfter === 'object';
            if (hasAfter) {
                afterTotal = keys.reduce((sum, k) => {
                    const base = emissions[k]?.value || 0;
                    const raw = suggestion.carbonAfter[k];
                    let normalized;
                    if (typeof raw === 'number') {
                        if (raw > 0) {
                            // 视为"新值（绝对值kgCO2e）"
                            normalized = Math.max(0, raw);
                        } else if (raw === 0) {
                            // 不变
                            normalized = base;
                        } else {
                            // 负数：视为"相对变化（kgCO2e）"，base + delta
                            normalized = Math.max(0, base + raw);
                        }
                    } else {
                        normalized = base;
                    }
                    return sum + normalized;
                }, 0);
            } else if (suggestion && suggestion.carbonImprovements && typeof suggestion.carbonImprovements === 'object') {
                afterTotal = keys.reduce((sum, k) => {
                    const base = emissions[k]?.value || 0;
                    const pct = suggestion.carbonImprovements[k];
                    if (typeof pct === 'number') {
                        const factor = 1 - (pct / 100);
                        return sum + Math.max(0, Math.round(base * factor));
                    }
                    return sum + base;
                }, 0);
            } else {
                return { isImprovement: true, displayText: 'Carbon Emissions: No Change' };
            }
            const deltaPct = beforeTotal > 0 ? Math.round(((beforeTotal - afterTotal) / beforeTotal) * 100) : 0;
            if (deltaPct > 0) {
                return { isImprovement: true, displayText: `Carbon Emissions: Reduce ${deltaPct}%` };
            } else if (deltaPct < 0) {
                return { isImprovement: false, displayText: `Carbon Emissions: Increase ${Math.abs(deltaPct)}%` };
            }
            return { isImprovement: true, displayText: 'Carbon Emissions: No Change' };
        }

        // 逐板块变化明细（碳排与时间）
        function computePhaseChangeDetails(suggestion) {
            const analysisData = window.analysisData || {};
            const emissions = analysisData.emissions || {};
            const timeline = analysisData.timeline || {};
            const carbonKeys = ['procurement','manufacturing','logistics','usage','recycling','decomposition'];
            const timeKeys = ['procurement','manufacturing','logistics','usage','recycling','decomposition'];
            const carbonLabel = {procurement:'Raw Material Procurement',manufacturing:'Manufacturing',logistics:'Logistics',usage:'Product Usage',recycling:'Recycling Processing',decomposition:'Natural Decomposition'};
            const timeLabel = {procurement:'Raw Material Procurement',manufacturing:'Manufacturing',logistics:'Logistics',usage:'Product Usage',recycling:'Recycling Processing',decomposition:'Natural Decomposition'};

            const carbonItems = carbonKeys.map(k => {
                const base = emissions[k]?.value ?? 0;
                let after;
                if (suggestion?.carbonAfter && typeof suggestion.carbonAfter[k] === 'number') {
                    const raw = suggestion.carbonAfter[k];
                    after = raw > 0 ? raw : raw === 0 ? base : Math.max(0, base + raw);
                } else if (suggestion?.carbonImprovements && typeof suggestion.carbonImprovements[k] === 'number') {
                    const pct = suggestion.carbonImprovements[k];
                    after = Math.max(0, Math.round(base * (1 - pct / 100)));
                } else {
                    after = base;
                }
                const deltaPct = base > 0 ? Math.round(((base - after) / base) * 100) : 0;
                const arrow = deltaPct > 0 ? '↓' : (deltaPct < 0 ? '↑' : '');
                const pctText = deltaPct === 0 ? '0%' : `${arrow}${Math.abs(deltaPct)}%`;
                return `${carbonLabel[k]}: ${base}→${after} (${pctText})`;
            });

            const timeItems = timeKeys.map(k => {
                const base = timeline[k]?.duration ?? 0;
                let after;
                if (suggestion?.timeAfter && typeof suggestion.timeAfter[k] === 'number') {
                    const raw = suggestion.timeAfter[k];
                    after = raw > 0 ? raw : raw === 0 ? base : Math.max(1, base + raw);
                } else if (suggestion?.timeImprovements && typeof suggestion.timeImprovements[k] === 'number') {
                    const pct = suggestion.timeImprovements[k];
                    after = Math.max(1, Math.round(base * (1 - pct / 100)));
                } else {
                    after = base;
                }
                const deltaPct = base > 0 ? Math.round(((base - after) / base) * 100) : 0;
                const arrow = deltaPct > 0 ? '↓' : (deltaPct < 0 ? '↑' : '');
                const pctText = deltaPct === 0 ? '0%' : `${arrow}${Math.abs(deltaPct)}%`;
                return `${timeLabel[k]}: ${base}→${after} (${pctText})`;
            });

            return {
                carbonHtml: carbonItems.join('、 '),
                timeHtml: timeItems.join('、 ')
            };
        }

        // 渲染建议函数
        window.renderSuggestions = function(area, suggestions) {
            console.log('Starting to render suggestions:', area, suggestions);
            
            const suggestionsDiv = document.getElementById('suggestionsContent');
            if (!suggestionsDiv) {
                console.error('Cannot find suggestionsContent element');
                return;
            }

            if (!suggestions || suggestions.length === 0) {
                suggestionsDiv.innerHTML = '<div class="no-suggestions">No optimization suggestions available</div>';
                return;
            }

            const suggestionsHTML = suggestions.map((suggestion, index) => {
                const isAccepted = window.acceptedSuggestions.includes(suggestion.title);
                
                // 计算时间改进（基于AI结果对比基线）
                const timeEffect = computeTimeChangeSummary(suggestion);
                const carbonEffect = computeCarbonChangeSummary(suggestion);
                const phaseDetails = computePhaseChangeDetails(suggestion);
                
                return `
                    <div class="suggestion-card ${isAccepted ? 'accepted' : ''}" data-index="${index}" data-suggestion-title="${suggestion.title}">
                        <div class="suggestion-header">
                            <div class="suggestion-icon">
                                <i class="${suggestion.icon}"></i>
                            </div>
                            <div class="suggestion-title">
                                <h4>${suggestion.title}</h4>
                                <div class="improvement-metrics">
                                    <div class="metric time-metric ${timeEffect.isImprovement ? 'improvement' : 'tradeoff'}">
                                        <i class="fas fa-clock"></i>
                                        <span>${timeEffect.displayText}</span>
                                    </div>
                                    <div class="metric carbon-metric ${carbonEffect.isImprovement ? 'improvement' : 'tradeoff'}">
                                        <i class="fas fa-leaf"></i>
                                        <span>${carbonEffect.displayText}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="suggestion-content">
                            <p class="suggestion-desc">${suggestion.desc}</p>
                            <div class="suggestion-details">
                                <span class="sub-project">Sub-project: ${suggestion.subProject}</span>
                                <div class="phase-details" style="margin-top:8px; font-size: 12px; color:#4b5563; line-height:1.6;">
                                    <div><strong>Carbon Emissions</strong>: ${phaseDetails.carbonHtml}</div>
                                    <div><strong>Time</strong>: ${phaseDetails.timeHtml}</div>
                                </div>
                            </div>
                        </div>
                        <div class="suggestion-actions">
                            ${isAccepted ? 
                                '<div class="accepted-status"><i class="fas fa-check"></i> Adopted</div>' :
                                `<button class="btn btn-success btn-sm" onclick="acceptSuggestion('${suggestion.title}', event)">
                                    <i class="fas fa-check"></i> Accept Suggestion
                                </button>`
                            }
                            <button class="btn btn-primary btn-sm" onclick="askAI('${suggestion.title}', '${area}')">
                                <i class="fas fa-robot"></i> Ask AI
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            suggestionsDiv.innerHTML = suggestionsHTML;
            console.log('Suggestion rendering completed');
        };

        // 解析改进效果字符串
        function parseImprovementEffect(effectString, type) {
            if (!effectString) {
                return { 
                    isImprovement: true, 
                    value: '0%',
                    displayText: type === 'time' ? 'Time: No Change' : 'Carbon Emissions: No Change'
                };
            }
            
            // 检查是否包含"减少"或"增加"
            const isImprovement = effectString.includes('减少') || effectString.includes('降低');
            const isTradeoff = effectString.includes('增加') || effectString.includes('提高');
            
            // 提取数值和单位
            const match = effectString.match(/(\d+(?:\.\d+)?)([%个月天小时])/);
            if (match) {
                const value = parseFloat(match[1]);
                const unit = match[2];
                
                // 如果数值为负数，自动转换为"增加"
                if (value < 0) {
                    const absValue = Math.abs(value);
                    const displayText = type === 'time' ? 
                        `Time: Increase ${absValue}${unit}` : 
                        `Carbon Emissions: Increase ${absValue}${unit}`;
                    
                    return {
                        isImprovement: false,
                        value: absValue + unit,
                        displayText: displayText
                    };
                } else {
                    const displayText = type === 'time' ? 
                        `Time: Reduce ${value}${unit}` : 
                        `Carbon Emissions: Reduce ${value}${unit}`;
                    
                    return {
                        isImprovement: true,
                        value: value + unit,
                        displayText: displayText
                    };
                }
            }
            
            // 如果没有匹配到数值，尝试从文本中提取信息
            let displayText = '';
            if (type === 'time') {
                if (isImprovement) {
                    displayText = `Time: ${effectString}`;
                } else if (isTradeoff) {
                    displayText = `Time: ${effectString}`;
                } else {
                    displayText = `Time: ${effectString}`;
                }
            } else {
                if (isImprovement) {
                    displayText = `Carbon Emissions: ${effectString}`;
                } else if (isTradeoff) {
                    displayText = `Carbon Emissions: ${effectString}`;
                } else {
                    displayText = `Carbon Emissions: ${effectString}`;
                }
            }
            
            return { 
                isImprovement: isImprovement || !isTradeoff, 
                value: effectString,
                displayText: displayText
            };
        }

        // 备用建议生成函数 - 增加改进百分比字段
        window.getFallbackSuggestions = function(area, productTypeName) {
            const fallbackSuggestions = {
                'Material Selection': [
                    {
                        icon: 'fas fa-seedling',
                        title: `${productTypeName} Bio-based Material Substitution`,
                        timeImprovement: 'Reduce 25% processing time',
                        carbonReduction: 'Reduce 60% material emissions',
                        desc: `Based on ${productTypeName} characteristics, adopt biodegradable materials to replace traditional materials, reducing chemical processing steps and environmental impact`,
                        subProject: 'Bio-based Material Selection',
                        carbonImprovements: {
                            procurement: 20,
                            manufacturing: 15,
                            logistics: 10,
                            usage: 30,
                            recycling: 8,
                            decomposition: 5
                        },
                        timeImprovements: {
                            procurement: 15,
                            manufacturing: 20,
                            logistics: 5,
                            usage: 10,
                            recycling: 12,
                            decomposition: 8
                        }
                    },
                    {
                        icon: 'fas fa-recycle',
                        title: `${productTypeName} Circular Material Application`,
                        timeImprovement: 'Save 30% preparation time',
                        carbonReduction: 'Reduce 50% raw material emissions',
                        desc: `Establish ${productTypeName} closed-loop material circulation system, achieve waste reuse, reduce raw material procurement costs`,
                        subProject: 'Recycled Material Application',
                        carbonImprovements: {
                            procurement: 25,
                            manufacturing: 10,
                            logistics: 5,
                            usage: 15,
                            recycling: 20,
                            decomposition: 3
                        },
                        timeImprovements: {
                            procurement: 18,
                            manufacturing: 12,
                            logistics: 5,
                            usage: 8,
                            recycling: 25,
                            decomposition: 5
                        }
                    },
                    {
                        icon: 'fas fa-feather-alt',
                        title: `${productTypeName} Lightweight Design`,
                        timeImprovement: 'Shorten 20% transportation time',
                        carbonReduction: 'Reduce 40% logistics emissions',
                        desc: `Adopt lightweight materials and structural design to reduce ${productTypeName} transportation costs and emissions`,
                        subProject: 'Lightweight Structural Design',
                        carbonImprovements: {
                            procurement: 5,
                            manufacturing: 8,
                            logistics: 25,
                            usage: 10,
                            recycling: 5,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 5,
                            manufacturing: 5,
                            logistics: 20,
                            usage: 5,
                            recycling: 8,
                            decomposition: 3
                        }
                    }
                ],
                'Production Process': [
                    {
                        icon: 'fas fa-cogs',
                        title: `${productTypeName} Lean Production Process`,
                        timeImprovement: 'Reduce 35% production cycle',
                        carbonReduction: 'Reduce 40% process emissions',
                        desc: `Implement lean production concepts tailored to ${productTypeName} characteristics, eliminate waste and redundant processes`,
                        subProject: 'Lean Production Process',
                        carbonImprovements: {
                            procurement: 10,
                            manufacturing: 35,
                            logistics: 8,
                            usage: 15,
                            recycling: 5,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 12,
                            manufacturing: 30,
                            logistics: 5,
                            usage: 8,
                            recycling: 10,
                            decomposition: 3
                        }
                    },
                    {
                        icon: 'fas fa-bolt',
                        title: `${productTypeName} Clean Energy Conversion`,
                        timeImprovement: 'Reduce 15% energy consumption time',
                        carbonReduction: 'Reduce 70% energy emissions',
                        desc: `Adopt clean energy such as solar and wind power to replace traditional energy for ${productTypeName} production`,
                        subProject: 'Clean Energy Conversion',
                        carbonImprovements: {
                            procurement: 5,
                            manufacturing: 60,
                            logistics: 10,
                            usage: 20,
                            recycling: 8,
                            decomposition: 3
                        },
                        timeImprovements: {
                            procurement: 5,
                            manufacturing: 15,
                            logistics: 3,
                            usage: 5,
                            recycling: 8,
                            decomposition: 2
                        }
                    },
                    {
                        icon: 'fas fa-fire',
                        title: `${productTypeName} Waste Heat Recovery System`,
                        timeImprovement: 'Improve 30% energy efficiency',
                        carbonReduction: 'Reduce 35% heat energy loss',
                        desc: `Install ${productTypeName} waste heat recovery system to improve energy utilization efficiency`,
                        subProject: 'Waste Heat Recovery System',
                        carbonImprovements: {
                            procurement: 3,
                            manufacturing: 25,
                            logistics: 5,
                            usage: 10,
                            recycling: 8,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 3,
                            manufacturing: 20,
                            logistics: 2,
                            usage: 5,
                            recycling: 10,
                            decomposition: 2
                        }
                    }
                ],
                'Supply Chain Management': [
                    {
                        icon: 'fas fa-map',
                        title: `${productTypeName} Local Procurement Strategy`,
                        timeImprovement: 'Reduce 40% transportation time',
                        carbonReduction: 'Reduce 45% logistics emissions',
                        desc: `Prioritize local suppliers for ${productTypeName} to reduce transportation distance and time`,
                        subProject: 'Local Procurement Strategy',
                        carbonImprovements: {
                            procurement: 15,
                            manufacturing: 5,
                            logistics: 40,
                            usage: 8,
                            recycling: 5,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 25,
                            manufacturing: 5,
                            logistics: 40,
                            usage: 5,
                            recycling: 8,
                            decomposition: 2
                        }
                    },
                    {
                        icon: 'fas fa-chart-line',
                        title: `${productTypeName} Digital Management Platform`,
                        timeImprovement: 'Improve 50% decision efficiency',
                        carbonReduction: 'Reduce 35% management emissions',
                        desc: `Establish ${productTypeName} digital management platform to achieve data-driven decision making`,
                        subProject: 'Digital Management Platform',
                        carbonImprovements: {
                            procurement: 20,
                            manufacturing: 15,
                            logistics: 25,
                            usage: 10,
                            recycling: 8,
                            decomposition: 3
                        },
                        timeImprovements: {
                            procurement: 30,
                            manufacturing: 25,
                            logistics: 20,
                            usage: 15,
                            recycling: 20,
                            decomposition: 5
                        }
                    },
                    {
                        icon: 'fas fa-users',
                        title: `${productTypeName} Agile Team Collaboration`,
                        timeImprovement: 'Reduce 45% communication time',
                        carbonReduction: 'Reduce 30% coordination costs',
                        desc: `Adopt agile working methods to improve ${productTypeName} team collaboration efficiency`,
                        subProject: 'Agile Team Collaboration',
                        carbonImprovements: {
                            procurement: 10,
                            manufacturing: 12,
                            logistics: 8,
                            usage: 5,
                            recycling: 5,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 20,
                            manufacturing: 18,
                            logistics: 10,
                            usage: 10,
                            recycling: 12,
                            decomposition: 3
                        }
                    }
                ],
                'Product Design': [
                    {
                        icon: 'fas fa-microchip',
                        title: `${productTypeName} Intelligent Upgrade`,
                        timeImprovement: 'Reduce 45% processing time',
                        carbonReduction: 'Reduce 40% carbon emissions',
                        desc: `Adopt AI and IoT technologies for ${productTypeName} to optimize processes and achieve intelligent monitoring`,
                        subProject: 'Smart Sensor Integration',
                        carbonImprovements: {
                            procurement: 15,
                            manufacturing: 25,
                            logistics: 20,
                            usage: 30,
                            recycling: 10,
                            decomposition: 5
                        },
                        timeImprovements: {
                            procurement: 15,
                            manufacturing: 25,
                            logistics: 15,
                            usage: 20,
                            recycling: 15,
                            decomposition: 8
                        }
                    },
                    {
                        icon: 'fas fa-robot',
                        title: `${productTypeName} Automation Transformation`,
                        timeImprovement: 'Reduce 55% operation time',
                        carbonReduction: 'Reduce 35% energy consumption',
                        desc: `Introduce ${productTypeName} robots and automated production lines to reduce manual intervention`,
                        subProject: 'Automated Control System',
                        carbonImprovements: {
                            procurement: 8,
                            manufacturing: 30,
                            logistics: 15,
                            usage: 20,
                            recycling: 12,
                            decomposition: 3
                        },
                        timeImprovements: {
                            procurement: 10,
                            manufacturing: 35,
                            logistics: 15,
                            usage: 15,
                            recycling: 18,
                            decomposition: 5
                        }
                    },
                    {
                        icon: 'fas fa-brain',
                        title: `${productTypeName} Algorithm Optimization`,
                        timeImprovement: 'Improve 65% computational efficiency',
                        carbonReduction: 'Reduce 30% server emissions',
                        desc: `Optimize ${productTypeName} core algorithms to reduce computational resource requirements`,
                        subProject: 'Machine Learning Algorithm Optimization',
                        carbonImprovements: {
                            procurement: 5,
                            manufacturing: 15,
                            logistics: 10,
                            usage: 25,
                            recycling: 8,
                            decomposition: 2
                        },
                        timeImprovements: {
                            procurement: 8,
                            manufacturing: 15,
                            logistics: 10,
                            usage: 25,
                            recycling: 12,
                            decomposition: 3
                        }
                    }
                ],
                'Packaging Solution': [
                    {
                        icon: 'fas fa-box-open',
                        title: `${productTypeName} Minimalist Packaging Design`,
                        timeImprovement: 'Reduce 30% packaging time',
                        carbonReduction: 'Reduce 50% packaging materials',
                        desc: `Adopt minimalist packaging design for ${productTypeName} to reduce material usage`,
                        subProject: 'Minimalist Packaging Design',
                        carbonImprovements: {
                            procurement: 10,
                            manufacturing: 8,
                            logistics: 25,
                            usage: 5,
                            recycling: 15,
                            decomposition: 8
                        },
                        timeImprovements: {
                            procurement: 8,
                            manufacturing: 5,
                            logistics: 20,
                            usage: 3,
                            recycling: 20,
                            decomposition: 10
                        }
                    },
                    {
                        icon: 'fas fa-recycle',
                        title: `${productTypeName} Recyclable Packaging Materials`,
                        timeImprovement: 'Save 25% processing time',
                        carbonReduction: 'Reduce 40% packaging emissions',
                        desc: `Use ${productTypeName} recyclable packaging materials and establish packaging recycling system`,
                        subProject: 'Recyclable Packaging Materials',
                        carbonImprovements: {
                            procurement: 8,
                            manufacturing: 5,
                            logistics: 20,
                            usage: 3,
                            recycling: 25,
                            decomposition: 12
                        },
                        timeImprovements: {
                            procurement: 5,
                            manufacturing: 5,
                            logistics: 15,
                            usage: 2,
                            recycling: 30,
                            decomposition: 15
                        }
                    },
                    {
                        icon: 'fas fa-leaf',
                        title: `${productTypeName} Green Packaging Certification`,
                        timeImprovement: 'Improve 20% brand value',
                        carbonReduction: 'Reduce 25% environmental impact',
                        desc: `Obtain green packaging certification for ${productTypeName} to enhance brand image`,
                        subProject: 'Green Packaging Certification',
                        carbonImprovements: {
                            procurement: 5,
                            manufacturing: 3,
                            logistics: 15,
                            usage: 8,
                            recycling: 18,
                            decomposition: 10
                        },
                        timeImprovements: {
                            procurement: 3,
                            manufacturing: 3,
                            logistics: 10,
                            usage: 5,
                            recycling: 22,
                            decomposition: 12
                        }
                    }
                ]
            };

            return fallbackSuggestions[area] || fallbackSuggestions['产品设计'];
        }
        // 更新采纳建议后的数据变化函数
        window.updateDataAfterAcceptance = function(suggestionTitle) {
            // 查找对应的建议数据
            let suggestionData = null;
            if (window.lastSuggestionsCache && window.currentSelectedArea) {
                const suggestions = window.lastSuggestionsCache[window.currentSelectedArea];
                if (suggestions) {
                    suggestionData = suggestions.find(s => s.title === suggestionTitle);
                }
            }
            
            if (suggestionData && suggestionData.carbonImprovements && suggestionData.timeImprovements) {
                // 更新碳排放数据
                if (window.analysisData && window.analysisData.emissions) {
                    Object.keys(suggestionData.carbonImprovements).forEach(phase => {
                        if (window.analysisData.emissions[phase]) {
                            const improvement = suggestionData.carbonImprovements[phase];
                            const currentValue = window.analysisData.emissions[phase].value;
                            const newValue = Math.round(currentValue * (1 - improvement / 100));
                            window.analysisData.emissions[phase].value = newValue;
                            
                            // 更新显示
                            const emissionCard = document.querySelector(`[onclick*="${phase}"]`);
                            if (emissionCard) {
                                const valueElement = emissionCard.querySelector('.emission-value');
                                if (valueElement) {
                                    valueElement.textContent = newValue;
                                    valueElement.style.color = '#28a745'; // 绿色表示改进
                                }

                            }
                        }
                    });
                }
                
                // 更新时间数据
                if (window.analysisData && window.analysisData.timeline) {
                    Object.keys(suggestionData.timeImprovements).forEach(phase => {
                        if (window.analysisData.timeline[phase]) {
                            const improvement = suggestionData.timeImprovements[phase];
                            const currentValue = window.analysisData.timeline[phase].duration;
                            const newValue = Math.round(currentValue * (1 - improvement / 100));
                            window.analysisData.timeline[phase].duration = newValue;
                            window.analysisData.timeline[phase].improved = true;
                            window.analysisData.timeline[phase].reductionAmount = currentValue - newValue;
                            
                            // 更新显示
                            const timelineCard = document.querySelector(`[data-phase="${phase}"]`);
                            if (timelineCard) {
                                const valueElement = timelineCard.querySelector('.duration-value');
                                if (valueElement) {
                                    valueElement.textContent = `${newValue} (-${currentValue - newValue})`;
                                    valueElement.classList.add('improved');
                                    valueElement.style.color = '#28a745'; // 绿色表示改进
                                }
                            }
                        }
                    });
                }
            }
        };

        // 累积计算所有已采纳建议的效果
        window.calculateCumulativeImprovements = function() {
            if (!window.acceptedSuggestions || window.acceptedSuggestions.length === 0) {
                return { carbon: {}, time: {} };
            }

            const cumulativeCarbon = {
                procurement: 0,
                manufacturing: 0,
                logistics: 0,
                usage: 0,
                recycling: 0,
                decomposition: 0
            };
            
            const cumulativeTime = {
                procurement: 0,
                manufacturing: 0,
                logistics: 0,
                usage: 0,
                recycling: 0,
                decomposition: 0
            };

            // 遍历所有已采纳的建议
            window.acceptedSuggestions.forEach(suggestionTitle => {
                // 在所有缓存中查找建议数据
                Object.keys(window.acceptedSuggestionsByArea || {}).forEach(area => {
                    if (window.lastSuggestionsCache && window.lastSuggestionsCache[area]) {
                        const suggestions = window.lastSuggestionsCache[area];
                        const suggestionData = suggestions.find(s => s.title === suggestionTitle);
                        
                        if (suggestionData && suggestionData.carbonImprovements && suggestionData.timeImprovements) {
                            // 累积碳排放改进
                            Object.keys(suggestionData.carbonImprovements).forEach(phase => {
                                if (cumulativeCarbon.hasOwnProperty(phase)) {
                                    cumulativeCarbon[phase] += suggestionData.carbonImprovements[phase];
                                }
                            });
                            
                            // 累积时间改进
                            Object.keys(suggestionData.timeImprovements).forEach(phase => {
                                if (cumulativeTime.hasOwnProperty(phase)) {
                                    cumulativeTime[phase] += suggestionData.timeImprovements[phase];
                                }
                            });
                        }
                    }
                });
            });

            return { carbon: cumulativeCarbon, time: cumulativeTime };
        };

        // 更新所有数据卡片显示
        window.updateAllDataCards = function() {
            const improvements = window.calculateCumulativeImprovements();
            
            // 先更新碳排放与时间数据，再统一刷新UI，确保显示的是最新数据
            // 更新碳排放数据卡片（写入 originalValue 以便卡片重渲染时显示"新值 (±差)"）
            if (window.analysisData && window.analysisData.emissions) {
                const totalBefore = Object.values(window.analysisData.emissions).reduce((s, d) => s + (d.originalValue || d.value), 0);
                Object.keys(improvements.carbon).forEach(phase => {
                    if (window.analysisData.emissions[phase]) {
                        const originalValue = window.analysisData.emissions[phase].originalValue || window.analysisData.emissions[phase].value;
                        const improvement = improvements.carbon[phase];
                        const newValue = Math.round(originalValue * (1 - improvement / 100));
                        
                        // 更新数据
                        window.analysisData.emissions[phase].value = newValue;
                        window.analysisData.emissions[phase].originalValue = originalValue;
                        // 此处不直接更新DOM，交由 refreshLeanTimelineData()+生成卡片函数统一渲染
                    }
                });
                const totalAfter = Object.values(window.analysisData.emissions).reduce((s, d) => s + d.value, 0);
                window.__combinedCarbon__ = { before: Math.round(totalBefore), after: Math.round(totalAfter) };
            }
            
            // 更新时间数据卡片
            if (window.analysisData && window.analysisData.timeline) {
                const totalBeforeTime = Object.values(window.analysisData.timeline).reduce((s, d) => s + (d.originalDuration || d.duration), 0);
                Object.keys(improvements.time).forEach(phase => {
                    if (window.analysisData.timeline[phase]) {
                        const originalValue = window.analysisData.timeline[phase].originalDuration || window.analysisData.timeline[phase].duration;
                        const improvement = improvements.time[phase];
                        const newValue = Math.round(originalValue * (1 - improvement / 100));
                        
                        // 更新数据
                        window.analysisData.timeline[phase].duration = newValue;
                        window.analysisData.timeline[phase].originalDuration = originalValue;
                        window.analysisData.timeline[phase].improved = improvement > 0;
                        window.analysisData.timeline[phase].reductionAmount = originalValue - newValue;
                        
                        // DOM更新将通过refreshLeanTimelineData()统一处理
                    }
                });
                const totalAfterTime = Object.values(window.analysisData.timeline).reduce((s, d) => s + d.duration, 0);
                window.__combinedTime__ = { before: Math.round(totalBeforeTime), after: Math.round(totalAfterTime) };
            }
            
            // 最后刷新Lean模块的时间与碳排数据显示（此时analysisData已更新）
            if (typeof refreshLeanTimelineData === 'function') {
                refreshLeanTimelineData();
            }
            if (typeof refreshLeanEmissionData === 'function') {
                refreshLeanEmissionData();
            }
        };

        // 深度分析AI调用函数 - 使用真实AI API
        async function callSuggestionAI(question, suggestion) {
            try {
                // 获取当前文档和产品信息
                const documentContent = window.documentAIContent?.content || '';
                const supplementData = window.supplementData || {};
                const productType = window.currentAnalysis?.documentType || 'general';
                const productTypeName = getDocumentTypeName(productType);

                // 构建完整AI提示词（包含上下文，但要求回答简洁）
                const prompt = `As a carbon emission expert, answer the question based on the following complete information: "${question}"

【Product Information】:
Product Type: ${productTypeName}
Document Summary: ${documentContent.substring(0, 300)}...

【Supplementary Data】:
${Object.entries(supplementData).map(([key, value]) => `${key}: ${value}`).join('\n')}

【Current Recommendation】:
Title: ${suggestion.title}
Description: ${suggestion.description}

Requirements: Answer based on the above complete information, but keep the answer concise and clear, no more than 60 words, focusing on core points relevant to the question.`;

                // 控制台调试日志 - AI输入
                console.log('=================== AI Recommendation Consultation Call ===================');
                console.log('🔹 User question:', question);
                console.log('🔹 Consultation recommendation:', suggestion);
                console.log('🔹 Product type:', productTypeName);
                console.log('🔹 Document content length:', documentContent.length, 'characters');
                console.log('🔹 Supplementary data:', supplementData);
                console.log('🔹 API endpoint:', 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions');
                console.log('🔹 Model:', 'deepseek-v3');
                console.log('📤 Complete AI prompt:');
                console.log(prompt);
                const requestBody = {
                    model: 'deepseek-v3',
                    messages: [{
                        role: 'user',
                        content: prompt
                    }],
                    max_tokens: 200, // 减少token数量以控制回答长度
                    temperature: 0.7
                };
                console.log('📤 Request parameters:');
                console.log(JSON.stringify(requestBody, null, 2));

                // 调用真实AI API
                const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.AI_API_KEY || 'YOUR_API_KEY_HERE'}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                // 控制台调试日志 - API响应
                console.log('📥 API response status:', response.status, response.statusText);

                if (!response.ok) {
                    console.error('❌ AI API call failed:', response.status, response.statusText);
                    throw new Error('AI API call failed');
                }

                const data = await response.json();
                console.log('📥 AI complete response data:');
                console.log(JSON.stringify(data, null, 2));
                
                const aiResponse = data.choices[0].message.content;
                console.log('📄 AI response content:');
                console.log(aiResponse);
                console.log('📊 Response word count:', aiResponse.length);
                console.log('===============================================');
                
                return aiResponse;
            } catch (error) {
                console.error('Deep analysis AI call error:', error);
                throw error;
            }
        }

        // 备用深度分析AI回复（当真实AI API不可用时）
        function generateFallbackSuggestionAIResponse(question, suggestion) {
            const productTypeName = getDocumentTypeName(window.currentAnalysis?.documentType || 'general');
            
            return `🤖 **AI Deep Analysis** - ${suggestion.title}

Based on your question "${question}", I provide the following professional analysis:

**Product Background**:
Current analyzed product type: ${productTypeName}

**Core Points**:
${suggestion.description}

**Professional Recommendations**:
1. Recommend conducting feasibility assessment and pilot testing first
2. Develop detailed implementation plan and timeline
3. Establish monitoring and evaluation mechanisms
4. Focus on employee training and participation

**Expected Benefits**:
- Time Efficiency: ${suggestion.timeImprovement || 'Significant improvement'}
- Carbon Emissions: ${suggestion.carbonReduction || 'Substantial reduction'}
- Long-term Value: Enhance enterprise competitiveness

**Note**: Currently in fallback response mode, recommend re-asking when network is normal to get more precise AI analysis.

For more detailed analysis, please specifically ask questions about feasibility, implementation steps, effect evaluation, or risk assessment.`;
        }

        // 渲染对话历史
        function renderChatHistory(moduleType, emissionType) {
            const history = window.aiChatHistory[moduleType] || [];
            const relevantHistory = history.filter(item => item.emissionType === emissionType);
            
            if (relevantHistory.length === 0) {
                return '<p class="no-history">No conversation history yet, start your first inquiry!</p>';
            }
            
            return relevantHistory.map(item => `
                <div class="history-item">
                    <div class="history-question">
                        <i class="fas fa-user"></i> <strong>Q:</strong>${item.question}
                    </div>
                    <div class="history-answer">
                        <i class="fas fa-robot"></i> <strong>A:</strong>${item.answer}
                    </div>
                    <div class="history-time">${item.timestamp}</div>
                </div>
            `).join('');
        }

        // 保存AI对话记录
        function saveAIChatHistory(moduleType, emissionType, question, answer) {
            if (!window.aiChatHistory[moduleType]) {
                window.aiChatHistory[moduleType] = [];
            }
            
            window.aiChatHistory[moduleType].push({
                emissionType: emissionType,
                question: question,
                answer: answer,
                timestamp: new Date().toLocaleString()
            });
        }

        // 更新对话历史显示
        function updateChatHistoryDisplay(moduleType, emissionType) {
            const historyMessages = document.getElementById('historyMessages');
            if (historyMessages) {
                historyMessages.innerHTML = renderChatHistory(moduleType, emissionType);
            }
        }

        // 继续对话功能
        function continueConversation() {
            const aiQuestion = document.getElementById('aiQuestion');
            const aiResponse = document.getElementById('aiResponse');
            if (aiQuestion) {
                aiQuestion.value = '';
                aiQuestion.focus();
            }
            if (aiResponse) {
                aiResponse.style.display = 'none';
            }
        }

        console.log('Carbon emission management system improved features loaded');

        // ==================== Scrum模块功能 ====================
        
        // 动态日期计算函数(返回字符串格式)
        function getDateAfterDays(days) {
            const date = new Date();
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        }

        // 动态日期计算函数(返回Date对象)
        function getDateObjectAfterDays(days) {
            const date = new Date();
            date.setDate(date.getDate() + days);
            return new Date(date.getFullYear(), date.getMonth(), date.getDate());
        }

        // Scrum任务数据
        window.scrumTasks = {
            todo: [
                {
                    id: 'task-1',
                    title: 'Implement Green Supplier Screening',
                    description: 'Establish supplier environmental assessment standards, prioritize suppliers with low carbon emissions',
                    assignee: 'Zhang Ming',
                    priority: 'high',
                    storyPoints: 8,
                    startDate: getDateAfterDays(1),
                    endDate: getDateAfterDays(5),
                    tags: ['Procurement Optimization', 'Supply Chain']
                },
                {
                    id: 'task-2',
                    title: 'Optimize Logistics Transportation Routes',
                    description: 'Redesign transportation routes to reduce shipping distance and carbon emissions',
                    assignee: 'Li Hua',
                    priority: 'medium',
                    storyPoints: 5,
                    startDate: getDateAfterDays(2),
                    endDate: getDateAfterDays(4),
                    tags: ['Logistics Optimization']
                },
                {
                    id: 'task-3',
                    title: 'Introduce Bio-based Materials',
                    description: 'Adopt biodegradable materials to replace traditional materials, reducing environmental impact',
                    assignee: 'Wang Fang',
                    priority: 'high',
                    storyPoints: 13,
                    startDate: getDateAfterDays(3),
                    endDate: getDateAfterDays(10),
                    tags: ['Material Selection', 'Environmental']
                },
                {
                    id: 'task-4',
                    title: 'Establish Waste Heat Recovery System',
                    description: 'Install waste heat recovery equipment to improve energy utilization efficiency',
                    assignee: 'Chen Qiang',
                    priority: 'medium',
                    storyPoints: 8,
                    startDate: getDateAfterDays(6),
                    endDate: getDateAfterDays(12),
                    tags: ['Energy Optimization']
                }
            ],
            'in-progress': [
                {
                    id: 'task-5',
                    title: 'Clean Energy Conversion',
                    description: 'Convert production lines to use solar and wind energy',
                    assignee: 'Liu Yang',
                    priority: 'high',
                    storyPoints: 21,
                    startDate: getDateAfterDays(-5),
                    endDate: getDateAfterDays(7),
                    progress: 60,
                    tags: ['Clean Energy']
                },
                {
                    id: 'task-6',
                    title: 'Lean Production Process Improvement',
                    description: 'Eliminate production waste, optimize process flow',
                    assignee: 'Zhao Min',
                    priority: 'medium',
                    storyPoints: 13,
                    startDate: getDateAfterDays(-3),
                    endDate: getDateAfterDays(5),
                    progress: 80,
                    tags: ['Production Optimization']
                },
                {
                    id: 'task-7',
                    title: 'Smart Monitoring System Integration',
                    description: 'Deploy IoT sensors for real-time monitoring',
                    assignee: 'Sun Jie',
                    priority: 'medium',
                    storyPoints: 8,
                    startDate: getDateAfterDays(-2),
                    endDate: getDateAfterDays(2),
                    progress: 40,
                    tags: ['Intelligent Systems']
                }
            ],
            done: [
                {
                    id: 'task-8',
                    title: 'Eco-friendly Packaging Material Procurement',
                    description: 'Procure recyclable packaging materials, establish packaging recycling system',
                    assignee: 'Zhou Lin',
                    priority: 'low',
                    storyPoints: 5,
                    startDate: getDateAfterDays(-8),
                    endDate: getDateAfterDays(-3),
                    completedDate: getDateAfterDays(-3),
                    tags: ['Packaging Optimization']
                },
                {
                    id: 'task-9',
                    title: 'Team Environmental Training',
                    description: 'Conduct carbon emission management training for all employees',
                    assignee: 'Wu Qiong',
                    priority: 'medium',
                    storyPoints: 3,
                    startDate: getDateAfterDays(-13),
                    endDate: getDateAfterDays(-10),
                    completedDate: getDateAfterDays(-10),
                    tags: ['Training']
                },
                {
                    id: 'task-10',
                    title: 'Carbon Emission Baseline Measurement',
                    description: 'Establish product carbon emission baseline data',
                    assignee: 'Ma Qiang',
                    priority: 'high',
                    storyPoints: 8,
                    startDate: getDateAfterDays(-17),
                    endDate: getDateAfterDays(-12),
                    completedDate: getDateAfterDays(-12),
                    tags: ['Data Collection']
                },
                {
                    id: 'task-11',
                    title: 'Supplier Evaluation Standards Development',
                    description: 'Develop environmental supplier evaluation standards and processes',
                    assignee: 'Huang Li',
                    priority: 'medium',
                    storyPoints: 5,
                    startDate: getDateAfterDays(-15),
                    endDate: getDateAfterDays(-11),
                    completedDate: getDateAfterDays(-11),
                    tags: ['Standards Development']
                },
                {
                    id: 'task-12',
                    title: 'Environmental Certification Application',
                    description: 'Apply for ISO 14001 Environmental Management System certification',
                    assignee: 'Lin Feng',
                    priority: 'low',
                    storyPoints: 3,
                    startDate: getDateAfterDays(-19),
                    endDate: getDateAfterDays(-15),
                    completedDate: getDateAfterDays(-15),
                    tags: ['Certification']
                }
            ],
            __auto: false,          // 标记为非自动生成（预设数据）
            __aiGenerated: false    // 标记为非AI生成
        };

        // 团队成员数据（简化版，仅用于头像显示）
        window.teamMembers = [
            { name: '张明', avatar: '👨‍💼' },
            { name: '李华', avatar: '🚛' },
            { name: '王芳', avatar: '👩‍🔬' },
            { name: '陈强', avatar: '🔧' },
            { name: '刘洋', avatar: '⚡' },
            { name: '赵敏', avatar: '👩‍🏭' },
            { name: '孙杰', avatar: '💻' },
            { name: '周琳', avatar: '📦' },
            { name: '吴琼', avatar: '👩‍🏫' },
            { name: '马强', avatar: '📊' },
            { name: '黄丽', avatar: '📋' },
            { name: '林峰', avatar: '🎯' }
        ];

        // [ADDED] 根据上下文自动生成Scrum任务计划（AI优先，失败时使用规则回退）
        window.ensureScrumPlanReady = async function() {
            try {
                // 已生成且无需刷新则跳过（只有AI生成的任务才跳过）
                if (window.scrumTasks && window.scrumTasks.__auto === true && window.scrumTasks.__aiGenerated === true && !window.__scrumNeedsRefresh) {
                    return;
                }

                // 显示加载占位
                const kanbanContainer = document.getElementById('kanban-view');
                if (kanbanContainer) {
                    kanbanContainer.querySelectorAll('.task-list').forEach(list => list.innerHTML = '<div class="loading-suggestions" style="padding:20px 10px;">\n                        <i class="fas fa-spinner fa-spin"></i> Automatically generating Sprint tasks based on documents and analysis results...\n                    </div>');
                }

                await window.generateScrumPlanFromContext();
                window.__scrumNeedsRefresh = false;
            } catch (e) {
                console.error('Failed to generate Scrum plan:', e);
            }
        };

        window.generateScrumPlanFromContext = async function() {
            console.log('🚀 =================== Scrum AI Task Plan Generation Start ===================');
            
            // 汇总上下文
            const rawDocContent = (window.documentAIContent && window.documentAIContent.content) ? window.documentAIContent.content.slice(0, 2000) : '';
            // 清理文档内容中的多余换行符和空白字符
            const docContent = rawDocContent
                .replace(/\n{3,}/g, '\n\n')  // 将3个以上连续换行替换为2个
                .replace(/[ \t]+\n/g, '\n')   // 删除行尾空白
                .replace(/\n[ \t]+/g, '\n')   // 删除行首空白
                .replace(/[ \t]{2,}/g, ' ')   // 将多个空格替换为单个空格
                .trim();
            
            const supplementData = window.supplementData || {};
            const productType = window.currentAnalysis?.documentType || 'general';
            const productTypeName = (typeof getDocumentTypeName === 'function') ? getDocumentTypeName(productType) : productType;
            const analysis = window.analysisData || {};
            const accepted = Array.isArray(window.acceptedSuggestions) ? window.acceptedSuggestions : [];
            const acceptedByArea = window.acceptedSuggestionsByArea || {};

            // 将缓存建议拍平以便在提示中引用
            const cachedAreas = Object.keys(window.lastSuggestionsCache || {});
            const cachedSuggestions = cachedAreas.reduce((acc, area) => {
                const items = (window.lastSuggestionsCache[area] || []).map(s => ({ area, title: s.title, desc: s.desc }));
                return acc.concat(items);
            }, []);

            // 打印收集到的上下文数据
            console.log('📋 Collected Context Data:');
            console.log('  📄 Document Content Length:', docContent.length);
            console.log('  🏷️ Product Type:', productTypeName);
            console.log('  📊 Analysis Data:', analysis);
            console.log('  ✅ Accepted Suggestions:', accepted);
            console.log('  🎯 Suggestions Grouped by Area:', acceptedByArea);
            console.log('  💡 Cached Suggestions Count:', cachedSuggestions.length);
            console.log('  📝 Supplementary Information:', supplementData);

            // 构造提示词
            const prompt = `You are an agile project manager. Please generate an executable Sprint task plan (JSON) for the current product based on the following real context.\n\n` +
            `【Product Type】${productTypeName}\n` +
            `【Document Summary】${docContent}\n` +
            `【Supplementary Information】${JSON.stringify(supplementData)}\n` +
            `【Current Analysis Data - Carbon Emissions】${JSON.stringify(analysis.emissions || {})}\n` +
            `【Current Analysis Data - Timeline】${JSON.stringify(analysis.timeline || {})}\n` +
            `【Accepted Suggestions】${JSON.stringify(accepted)}\n` +
            `【Suggestion Cache Summary】${JSON.stringify(cachedSuggestions).slice(0, 2000)}\n\n` +
            `Please output an English task plan in strict JSON format: {\n  "sprint": {"name": "Sprint 1", "startDate": "YYYY-MM-DD", "endDate": "YYYY-MM-DD"},\n  "tasks": [\n    {"title":"Task Name","desc":"Task Description","aiExplanation":"Detailed AI explanation for this task, explaining main specific work content, estimated duration reasonableness, execution steps and expected effects","assignee":"(can be empty)","priority":"high|medium|low","storyPoints":8,"startDate":"YYYY-MM-DD","endDate":"YYYY-MM-DD","status":"todo|in-progress|done","tags":["Material Selection"],"relatedSuggestion":"(if any)"}\n  ]\n}\n` +
            `Requirements: \n1) All task titles and descriptions must use English;\n2) Tasks must be executable, covering key accepted suggestions or high-impact areas;\n3) All time in days as minimum unit, task duration 1-30 days;\n4) startDate and endDate must be valid YYYY-MM-DD format dates;\n5) For example: 3-day task starts today, continues to day 3; 7-day task continues from start date to day 7;\n6) If no clear assignee, leave assignee empty;\n7) **aiExplanation field must include**: \n   - Main work content breakdown (e.g.: (1) Work A (X days); (2) Work B (Y days))\n   - Duration reasonableness explanation (why this time is needed)\n   - Expected carbon reduction effects and value\n   Each explanation should be concise and practical, 80-120 characters long.\n8) **Important**: Return complete valid JSON only (no markdown/code fences/extra text). All content must be in English; do not include Chinese.`;

            // 打印完整的AI输入
            console.log('🤖 AI Input Prompt:');
            console.log('━'.repeat(80));
            console.log(prompt);
            console.log('━'.repeat(80));

            // 构建请求参数
            const requestData = {
                model: 'deepseek-v3',
                messages: [{ role: 'user', content: prompt }],
                max_tokens: 2500,
                temperature: 0.5
            };

            console.log('📤 AI API Request Parameters:');
            console.log('  🔗 URL: https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions');
            console.log('  📦 Request Body:', JSON.stringify(requestData, null, 2));

            let plan;
            try {
                console.log('⏳ Calling AI API...');
                const startTime = Date.now();
                
                const res = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.AI_API_KEY || 'YOUR_API_KEY_HERE'}`
                    },
                    body: JSON.stringify(requestData)
                });

                const responseTime = Date.now() - startTime;
                console.log(`⚡ AI API Response Time: ${responseTime}ms`);
                console.log('📥 AI API Response Status:', res.status, res.statusText);

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('❌ AI API Error Response:', errorText);
                    throw new Error(`AI API Failed: ${res.status} ${res.statusText}`);
                }

                const data = await res.json();
                console.log('📥 AI API Complete Response Data:');
                console.log(JSON.stringify(data, null, 2));

                const content = data.choices?.[0]?.message?.content || '';
                console.log('🔍 AI Returned Content:');
                console.log('━'.repeat(80));
                console.log(content);
                console.log('━'.repeat(80));

                // 提取JSON部分
                const match = content.match(/\{[\s\S]*\}/);
                if (match) {
                    const jsonString = match[0];
                    console.log('🔄 Extracted JSON String:');
                    console.log(jsonString);
                    
                    try {
                        plan = JSON.parse(jsonString);
                        console.log('✅ JSON Parsing Successful!');
                        console.log('📋 Parsed Plan Data:');
                        console.log(JSON.stringify(plan, null, 2));
                    } catch (parseError) {
                        console.error('❌ JSON Parsing Failed:', parseError);
                        console.error('🔤 Original JSON String:', jsonString);
                        throw new Error('AI returned JSON format error');
                    }
                } else {
                    console.error('❌ No JSON format data found in AI response');
                    console.error('📄 AI Complete Response:', content);
                    throw new Error('AI returned incorrect format, no JSON data included');
                }

            } catch (e) {
                console.error('❌ AI Call Failed:', e);
                console.warn('🔄 Using rule-based fallback to generate Scrum plan');
                plan = buildScrumPlanFallback(acceptedByArea, analysis);
                console.log('🛠️ Fallback Generated Plan:', plan);
            }

            // 分析AI返回的计划数据
            console.log('🔍 =================== AI Returned Data Analysis ===================');
            console.log('📋 Generated Plan Data:', plan);
            console.log('📊 Plan Data Type:', typeof plan);
            console.log('📝 Tasks Included in Plan:', plan?.tasks);
            console.log('🎯 Sprint Information:', plan?.sprint);

            // 映射到本地结构
            const buckets = { 'todo': [], 'in-progress': [], 'done': [] };
            const tasks = Array.isArray(plan?.tasks) ? plan.tasks : [];
            
            console.log('🔄 =================== Task Data Processing ===================');
            console.log('📦 Extracted Task Array:', tasks);
            console.log('🔢 Task Array Length:', tasks.length);
            
            // 如果没有任务，记录详细信息
            if (tasks.length === 0) {
                console.warn('⚠️ Warning: AI returned no task data');
                console.log('🔍 Original Plan Object:', JSON.stringify(plan, null, 2));
            }

            const normalizePriority = (p) => (p==='high'||p==='medium'||p==='low') ? p : 'medium';
            const normalizeStatus = (s) => (s==='todo'||s==='in-progress'||s==='done') ? s : 'todo';

            tasks.forEach((t, idx) => {
                console.log(`📋 Processing Task ${idx + 1}:`, t);
                
                const task = {
                    id: `ai-${Date.now()}-${idx}`,
                    title: t.title || `Task ${idx+1}`,
                    description: t.desc || '',
                    aiExplanation: t.aiExplanation || t.explain || t.explanation || t.reason || t.note || 'AI generated for this task: Specific execution items based on product and solution analysis, aimed at completion within the set cycle and bringing emission reduction or efficiency improvement.',
                    assignee: t.assignee || (window.teamMembers?.[idx % (window.teamMembers.length||1)]?.name || ''),
                    priority: normalizePriority(t.priority),
                    storyPoints: Number.isFinite(t.storyPoints) ? t.storyPoints : 5,
                    startDate: t.startDate || getDateAfterDays(0),
                    endDate: t.endDate || getDateAfterDays(3),
                    tags: Array.isArray(t.tags) ? t.tags : [],
                    progress: t.status==='in-progress' ? 30 : (t.status==='done'? 100 : undefined)
                };
                
                const normalizedStatus = normalizeStatus(t.status);
                console.log(`✅ Normalized Task ${idx + 1}:`, task);
                console.log(`📌 Assigned to Status: ${normalizedStatus}`);
                
                buckets[normalizedStatus].push(task);
            });

            // 确保每个任务具备aiExplanation
            Object.keys(buckets).forEach(st => {
                if (Array.isArray(buckets[st])) {
                    buckets[st] = buckets[st].map(task => ({
                        ...task,
                        aiExplanation: task.aiExplanation || 'Main Work: This task is generated based on system analysis, including (1) Current situation assessment and problem identification (1-2 days); (2) Develop detailed improvement plan and implementation plan (2-3 days); (3) Coordinate resource allocation and team arrangement (1 day); (4) Step-by-step implementation of improvement measures (3-5 days); (5) Effect verification and continuous optimization (1 day). Estimated duration of 7-12 days reason: Need to fully analyze the current situation to avoid omissions, plan development requires multi-party verification, implementation process needs to ensure normal operations are not affected. Expected to achieve significant carbon reduction effects and efficiency improvements through systematic improvements, investment payback period is about 6-12 months.'
                    }));
                }
            });

            window.scrumTasks = Object.assign(buckets, { __auto: true, __aiGenerated: true });

            console.log('🎯 =================== Final Task Data Structure ===================');
            console.log('📊 Complete scrumTasks Data Structure:', window.scrumTasks);
            
            // 详细分析每个状态的任务
            Object.keys(window.scrumTasks).forEach(status => {
                if (status !== '__auto' && status !== '__aiGenerated' && Array.isArray(window.scrumTasks[status])) {
                    const statusTasks = window.scrumTasks[status];
                    console.log(`📋 Task Details for Status "${status}":`);
                    console.log(`  📊 Task Count: ${statusTasks.length}`);
                    console.log(`  📦 Data Type: ${Array.isArray(statusTasks) ? 'Array' : typeof statusTasks}`);
                    console.log(`  📝 Task List:`, statusTasks);
                    
                    // 分析每个任务的关键属性
                    statusTasks.forEach((task, idx) => {
                        console.log(`    📋 Task ${idx + 1}: "${task.title}"`, {
                            id: task.id,
                            priority: task.priority,
                            storyPoints: task.storyPoints,
                            startDate: task.startDate,
                            endDate: task.endDate,
                            assignee: task.assignee,
                            tags: task.tags
                        });
                    });
                }
            });

            // 计算总任务数
            const totalTasks = Object.keys(window.scrumTasks)
                .filter(key => key !== '__auto' && key !== '__aiGenerated' && Array.isArray(window.scrumTasks[key]))
                .reduce((sum, status) => sum + window.scrumTasks[status].length, 0);
            console.log(`📊 Task Statistics: Total ${totalTasks} tasks`);
            
            // 验证数据完整性
            if (totalTasks === 0) {
                console.error('❌ Critical Error: No valid tasks generated!');
            } else {
                console.log('✅ Task data validation passed');
            }

            // 渲染
            console.log('🎨 =================== Starting Gantt Chart Rendering ===================');
            console.log('⏳ Calling renderGanttChart() function...');
            renderGanttChart();
            console.log('🎯 =================== Scrum AI Task Plan Generation Complete ===================');
        };
        function buildScrumPlanFallback(acceptedByArea, analysis) {
            const tasks = [];
            const today = new Date();
            let dayOffset = 0;
            Object.keys(acceptedByArea || {}).forEach(area => {
                (acceptedByArea[area] || []).forEach((title, idx) => {
                    const start = getDateAfterDays(dayOffset);
                    const end = getDateAfterDays(dayOffset + 2 + (idx%3));
                    tasks.push({
                        title: `${area} - Execute "${title}"`,
                        desc: 'Implement, verify and review based on accepted suggestions',
                        explain: `Main Work: (1) Deepen the "${title}" suggestion and develop detailed implementation plan (1-2 days); (2) Coordinate resource allocation, including personnel, equipment, and funding arrangements (1 day); (3) Phase-by-phase implementation to ensure normal operations are not affected (3-4 days); (4) Establish effect monitoring mechanism and track key indicators (1 day); (5) Continuously optimize and adjust based on implementation results (1 day). Estimated duration of 7-10 days reason: ${area} area improvement requires cross-departmental coordination, implementation process needs gradual advancement to avoid risks, effect verification requires data accumulation. Expected to achieve significant carbon reduction and efficiency improvement in ${area} stage, investment payback period is about 6-12 months.`,
                        priority: idx%2===0 ? 'high' : 'medium',
                        storyPoints: [3,5,8,13][idx%4],
                        startDate: start,
                        endDate: end,
                        status: idx%3===0 ? 'in-progress' : 'todo',
                        tags: [area]
                    });
                    dayOffset += 1;
                });
            });
            // 若尚未采纳建议，基于高值板块生成基本任务
            if (tasks.length === 0 && analysis?.emissions) {
                const sorted = Object.entries(analysis.emissions).sort((a,b)=> (b[1].value||0) - (a[1].value||0)).slice(0,3);
                sorted.forEach(([k,v],i)=>{
                    const start = getDateAfterDays(i);
                    const end = getDateAfterDays(i + 3);
                    tasks.push({
                        title: `Reduce "${k}" Stage Emissions`,
                        desc: 'Develop and execute carbon reduction measures, track indicators',
                        explain: `Main Work: (1) In-depth analysis of high emission causes in "${k}" stage, identify emission reduction opportunities (1 day); (2) Develop targeted improvement plans, including process optimization and energy substitution (1 day); (3) Step-by-step implementation of improvement measures to ensure production stability (1 day). Estimated duration of 3 days reason: "${k}" stage current emissions of ${v.value || 0} tCO₂e are high, requiring precise analysis of root causes, improvement plans need technical feasibility verification, implementation needs to avoid affecting production. Expected to achieve 25-40% carbon reduction in this stage, annual reduction of about ${Math.round((v.value || 0) * 0.3)} tons CO₂, cost savings of about ${Math.round((v.value || 0) * 0.3 * 2000)} yuan.`,
                        priority: i===0?'high':'medium',
                        storyPoints: [8,5,3][i] || 5,
                        startDate: start,
                        endDate: end,
                        status: 'todo',
                        tags: ['Carbon Reduction']
                    });
                });
            }
            return { sprint: {}, tasks };
        }

        // ==================== 甘特图提示工具 ====================
        (function setupGanttTooltipHelpers(){
            if (window.__ganttTooltipSetup) return;
            window.__ganttTooltipSetup = true;
            const tooltip = document.createElement('div');
            tooltip.className = 'gantt-tooltip';
            tooltip.id = 'ganttTooltip';
            document.body.appendChild(tooltip);

            window.showGanttTooltip = function(e){
                const el = e.currentTarget;
                const title = el.getAttribute('data-task-title') || '';
                const assignee = el.getAttribute('data-task-assignee') || '';
                const dates = el.getAttribute('data-task-dates') || '';
                const priority = el.getAttribute('data-task-priority') || '';
                const explain = el.getAttribute('data-task-explain') || '';
                const content = `
                    <div class="gt-title">${title}</div>
                    <div class="gt-row"><span class="gt-label">Duration</span>${dates}</div>
                    <div class="gt-row"><span class="gt-label">Priority</span>${priority}</div>
                    ${explain ? `<div class="gt-explain">${explain}</div>` : ''}
                `;
                tooltip.innerHTML = content;
                tooltip.style.display = 'block';
                moveGanttTooltip(e);
            };

            window.moveGanttTooltip = function(e){
                const pad = 12;
                const t = document.getElementById('ganttTooltip');
                if (!t || t.style.display === 'none') return;
                const vw = window.innerWidth;
                const vh = window.innerHeight;
                const rect = t.getBoundingClientRect();
                let x = e.clientX + pad;
                let y = e.clientY + pad;
                if (x + rect.width > vw - 8) x = e.clientX - rect.width - pad;
                if (y + rect.height > vh - 8) y = e.clientY - rect.height - pad;
                t.style.left = x + 'px';
                t.style.top = y + 'px';
            };

            window.hideGanttTooltip = function(){
                const t = document.getElementById('ganttTooltip');
                if (t) {
                    t.style.display = 'none';
                    t.innerHTML = '';
                }
            };
        })();

        // 切换Scrum视图
        window.switchScrumView = function(viewType) {
            // 更新按钮状态
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-view="${viewType}"]`).classList.add('active');
            
            // 隐藏所有视图
            document.querySelectorAll('.scrum-view').forEach(view => {
                view.style.display = 'none';
            });
            
            // 显示选中视图
            const viewElement = document.getElementById(`${viewType}-view`);
            if (viewElement) {
                viewElement.style.display = 'block';
            }
            
            // 根据视图类型渲染相应内容
            switch(viewType) {
                case 'kanban':
                    // 取消看板渲染，仅保留甘特图
                    break;
                case 'gantt':
                    renderGanttChart();
                    break;
            }
        };

        // 渲染Kanban看板
        window.renderKanbanBoard = function() {
            // 检查数据结构
            if (!window.scrumTasks || typeof window.scrumTasks !== 'object') {
                console.warn('scrumTasks data does not exist or format error');
                return;
            }
            
            Object.keys(window.scrumTasks).forEach(status => {
                // 跳过特殊标记
                if (status === '__auto') return;
                
                const taskList = document.getElementById(`${status === 'in-progress' ? 'in-progress' : status}-tasks`);
                if (!taskList) {
                    console.warn(`Cannot find task list container with status ${status}`);
                    return;
                }
                
                const tasks = window.scrumTasks[status];
                
                // 确保 tasks 是数组
                if (!Array.isArray(tasks)) {
                    console.warn(`Tasks with status ${status} is not an array:`, tasks);
                    taskList.innerHTML = '<div class="no-tasks">暂无任务</div>';
                    return;
                }
                
                taskList.innerHTML = tasks.map(task => {
                    const priorityColor = {
                        high: '#dc3545',
                        medium: '#ffc107',
                        low: '#28a745'
                    };
                    
                    const progressBar = task.progress ? `
                        <div class="task-progress">
                            <div class="progress-bar-task">
                                <div class="progress-fill-task" style="width: ${task.progress}%"></div>
                            </div>
                            <span class="progress-text">${task.progress}%</span>
                        </div>
                    ` : '';
                    
                    return `
                        <div class="task-card" data-task-id="${task.id}" draggable="true" 
                             ondragstart="handleTaskDragStart(event)" 
                             ondragend="handleTaskDragEnd(event)">
                            <div class="task-header">
                                <div class="task-priority" style="background-color: ${priorityColor[task.priority]}"></div>
                                <div class="task-points">${task.storyPoints} SP</div>
                            </div>
                            <h4 class="task-title">${task.title}</h4>
                            <p class="task-description">${task.description}</p>
                            <div class="task-tags">
                                ${task.tags.map(tag => `<span class="task-tag">${tag}</span>`).join('')}
                            </div>
                            ${progressBar}
                            <div class="task-footer">
                                <div class="task-assignee">
                                    <span class="assignee-avatar">${getTeamMemberAvatar(task.assignee)}</span>
                                    <span class="assignee-name">${task.assignee}</span>
                                </div>
                                <div class="task-dates">
                                    <small>${task.startDate} - ${task.endDate}</small>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // 更新任务计数
                const column = taskList.closest('.kanban-column');
                const countElement = column.querySelector('.task-count');
                countElement.textContent = tasks.length;
            });
            
            // 设置拖拽区域
            setupKanbanDragAndDrop();
        };

        // 获取团队成员头像
        function getTeamMemberAvatar(memberName) {
            const member = window.teamMembers.find(m => m.name === memberName);
            return member ? member.avatar : '👤';
        }

        // 设置Kanban拖拽功能
        function setupKanbanDragAndDrop() {
            // 为每个列设置拖拽目标
            document.querySelectorAll('.task-list').forEach(list => {
                list.addEventListener('dragover', handleDragOver);
                list.addEventListener('drop', handleDrop);
            });
        }

        // 拖拽开始
        window.handleTaskDragStart = function(event) {
            event.dataTransfer.setData('text/plain', event.target.dataset.taskId);
            event.target.classList.add('dragging');
        };

        // 拖拽结束
        window.handleTaskDragEnd = function(event) {
            event.target.classList.remove('dragging');
        };

        // 拖拽悬停
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        // 放置任务
        function handleDrop(event) {
            event.preventDefault();
            const taskId = event.dataTransfer.getData('text/plain');
            const targetStatus = event.currentTarget.id.replace('-tasks', '').replace('in-progress', 'in-progress');
            
            // 移动任务到新状态
            moveTask(taskId, targetStatus);
            
            // 重新渲染看板
            // 取消看板渲染，仅保留甘特图
            
            // 移除拖拽样式
            event.currentTarget.classList.remove('drag-over');
        }

        // 移动任务
        function moveTask(taskId, newStatus) {
            let taskToMove = null;
            let fromStatus = null;
            
            // 找到任务并从原位置移除
            Object.keys(window.scrumTasks).forEach(status => {
                if (status !== '__auto' && status !== '__aiGenerated' && Array.isArray(window.scrumTasks[status])) {
                    const taskIndex = window.scrumTasks[status].findIndex(task => task.id === taskId);
                    if (taskIndex !== -1) {
                        taskToMove = window.scrumTasks[status].splice(taskIndex, 1)[0];
                        fromStatus = status;
                    }
                }
            });
            
            // 添加到新位置
            if (taskToMove) {
                // 如果移动到已完成，添加完成日期
                if (newStatus === 'done' && !taskToMove.completedDate) {
                    taskToMove.completedDate = new Date().toISOString().split('T')[0];
                }
                
                if (Array.isArray(window.scrumTasks[newStatus])) {
                    window.scrumTasks[newStatus].push(taskToMove);
                } else {
                    console.error(`Target status ${newStatus} is not an array, cannot move task`);
                    return;
                }
                
                // 显示移动提示
                showTaskMoveNotification(taskToMove.title, fromStatus, newStatus);
            }
        }

        // 显示任务移动提示
        function showTaskMoveNotification(taskTitle, fromStatus, toStatus) {
            const statusNames = {
                'todo': 'To Do',
                'in-progress': 'In Progress',
                'done': 'Done'
            };
            
            // 创建提示元素
            const notification = document.createElement('div');
            notification.className = 'task-move-notification';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                "${taskTitle}" moved from ${statusNames[fromStatus]} to ${statusNames[toStatus]}
            `;
            
            // 添加到页面
            document.body.appendChild(notification);
            
            // 显示动画
            setTimeout(() => notification.classList.add('show'), 100);
            
            // 自动隐藏
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // 初始化Scrum模块
        function initializeScrumModule() {
            // 默认显示Kanban视图
            // 取消看板渲染，仅保留甘特图
            
            // 初始化甘特图默认为日视图
            window.ganttConfig.currentZoom = 'day';
            
            // 强制验证和修复任务日期
            console.log('🔄 Initializing Scrum module - validating task dates...');
            validateAndFixTaskDates();
            
            console.log('Scrum module initialized');
        }



        // 渲染甘特图
        window.renderGanttChart = function() {
            console.log('📊 =================== Gantt Chart Rendering Start ===================');
            
            // 强制验证和修复任务日期
            console.log('🔄 Force validating and fixing task dates...');
            validateAndFixTaskDates();
            
            try {
                const ganttChart = document.getElementById('ganttChart');
                if (!ganttChart) {
                    console.warn('❌ Cannot find Gantt chart container element #ganttChart');
                    return;
                }
                console.log('✅ Gantt chart container element found');
                // 页面提示：正在生成甘特图
                try {
                    ganttChart.innerHTML = '<div style="padding: 16px; text-align:center; color:#555;">⏳ Generating Gantt chart...</div>';
                    if (window.addScrumProgress) {
                        window.addScrumProgress('Generating Gantt chart...');
                    }
                } catch (e) {}
                
                // 检查数据
                console.log('🔍 Checking Scrum task data...');
                console.log('📦 window.scrumTasks:', window.scrumTasks);
                console.log('📊 Data type:', typeof window.scrumTasks);
                
                if (!window.scrumTasks || typeof window.scrumTasks !== 'object') {
                    console.warn('❌ Scrum task data is invalid or does not exist');
                    ganttChart.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center;">No task data available, please generate Scrum plan first</div>';
                    return;
                }
                console.log('✅ Scrum task data check passed');
                
                // 获取所有任务
                console.log('🔄 =================== Task Data Extraction ===================');
                console.log('📦 Original scrumTasks data:', window.scrumTasks);
                const allTasks = [];
                
                // 安全地提取所有任务
                console.log('🔍 Starting to extract tasks from various statuses...');
                Object.keys(window.scrumTasks).forEach(status => {
                    if (status !== '__auto' && status !== '__aiGenerated') {
                        console.log(`📋 Checking status "${status}":`, window.scrumTasks[status]);
                        console.log(`  📊 Is array: ${Array.isArray(window.scrumTasks[status])}`);
                        console.log(`  🔢 Task count: ${window.scrumTasks[status]?.length || 0}`);
                        
                        if (Array.isArray(window.scrumTasks[status])) {
                            const statusTasks = window.scrumTasks[status];
                            console.log(`  ✅ Extracted ${statusTasks.length} tasks from "${status}"`);
                            statusTasks.forEach((task, idx) => {
                                console.log(`    📝 Task ${idx + 1}:`, {
                                    id: task.id,
                                    title: task.title,
                                    startDate: task.startDate,
                                    endDate: task.endDate
                                });
                            });
                            allTasks.push(...statusTasks);
                        } else {
                            console.warn(`  ⚠️ Data for status "${status}" is not an array:`, window.scrumTasks[status]);
                        }
                    }
                });
                
                console.log('📊 =================== Task Extraction Results ===================');
                console.log('🔢 Total extracted tasks:', allTasks.length);
                console.log('📋 All task details:', allTasks);
                
                // 检查是否有任务
                if (allTasks.length === 0) {
                    console.warn('❌ No task data extracted');
                    console.log('🔍 Debug info:');
                    console.log('  - scrumTasks object:', window.scrumTasks);
                    console.log('  - scrumTasks keys:', Object.keys(window.scrumTasks));
                    
                    ganttChart.innerHTML = `
                        <div class="empty-state" style="padding: 20px; text-align: center;">
                            <h3>❌ No Tasks Available</h3>
                            <p>Please generate Scrum task plan first</p>
                            <p style="color: #666; font-size: 12px;">Debug: Detected scrumTasks object, but no valid tasks found</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('✅ Task data extraction successful');
                
                // 验证任务数据格式
                console.log('🔍 =================== Task Data Validation ===================');
                console.log('📊 Starting task data format validation...');
                
                const validTasks = allTasks.filter((task, idx) => {
                    const isValid = task && task.startDate && task.endDate && task.title;
                    console.log(`📋 Task ${idx + 1} validation:`, {
                        title: task?.title,
                        startDate: task?.startDate,
                        endDate: task?.endDate,
                        isValid: isValid
                    });
                    
                    if (!isValid) {
                        console.warn(`⚠️ Task ${idx + 1} data incomplete:`, task);
                    }
                    
                    return isValid;
                });
                
                console.log('📊 Validation results:');
                console.log(`  🔢 Original task count: ${allTasks.length}`);
                console.log(`  ✅ Valid task count: ${validTasks.length}`);
                console.log(`  ❌ Invalid task count: ${allTasks.length - validTasks.length}`);
                
                if (validTasks.length === 0) {
                    console.error('❌ All task data formats are incorrect!');
                    console.log('🔍 Invalid task details:');
                    allTasks.forEach((task, idx) => {
                        console.log(`  Task ${idx + 1}:`, {
                            hasTask: !!task,
                            hasTitle: !!task?.title,
                            hasStartDate: !!task?.startDate,
                            hasEndDate: !!task?.endDate,
                            task: task
                        });
                    });
                    
                    ganttChart.innerHTML = `
                        <div class="empty-state" style="padding: 20px; text-align: center;">
                            <h3>❌ Task Data Format Error</h3>
                            <p>Detected ${allTasks.length} tasks, but data format is incorrect</p>
                            <p style="color: #666; font-size: 12px;">Please check console for detailed information</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('✅ Task data validation passed');
                
                // 按开始日期排序
                console.log('🔄 =================== Task Sorting and Date Calculation ===================');
                console.log('📅 Sorting tasks by start date...');
                
                validTasks.sort((a, b) => {
                    const dateA = new Date(a.startDate);
                    const dateB = new Date(b.startDate);
                    console.log(`📋 Comparing tasks: "${a.title}" (${a.startDate}) vs "${b.title}" (${b.startDate})`);
                    return dateA - dateB;
                });
                
                console.log('✅ Task sorting completed');
                console.log('📋 Task order after sorting:');
                validTasks.forEach((task, idx) => {
                    console.log(`  ${idx + 1}. "${task.title}" (${task.startDate} ~ ${task.endDate})`);
                    console.log(`    startDate type: ${typeof task.startDate}, value: "${task.startDate}"`);
                    console.log(`    endDate type: ${typeof task.endDate}, value: "${task.endDate}"`);
                });
                
                // 计算时间范围
                console.log('📅 Calculating Gantt chart time range...');
                let minDate, maxDate;
                try {
                    const startDates = validTasks.map(task => {
                        const date = new Date(task.startDate);
                        console.log(`📅 Parsing start date: ${task.startDate} -> ${date} (valid: ${!isNaN(date)})`);
                        return date;
                    }).filter(date => !isNaN(date));
                    
                    const endDates = validTasks.map(task => {
                        const date = new Date(task.endDate);
                        console.log(`📅 Parsing end date: ${task.endDate} -> ${date} (valid: ${!isNaN(date)})`);
                        return date;
                    }).filter(date => !isNaN(date));
                    
                    console.log(`📊 Valid start date count: ${startDates.length}`);
                    console.log(`📊 Valid end date count: ${endDates.length}`);
                    
                    if (startDates.length === 0 || endDates.length === 0) {
                        throw new Error('No valid date data');
                    }
                    
                    minDate = new Date(Math.min(...startDates));
                    maxDate = new Date(Math.max(...endDates));
                    
                    console.log(`📅 Calculated time range: ${minDate} ~ ${maxDate}`);
                    console.log(`📅 minDate details: ${minDate.getFullYear()}-${(minDate.getMonth()+1).toString().padStart(2,'0')}-${minDate.getDate().toString().padStart(2,'0')}`);
                    console.log(`📅 maxDate details: ${maxDate.getFullYear()}-${(maxDate.getMonth()+1).toString().padStart(2,'0')}-${maxDate.getDate().toString().padStart(2,'0')}`);
                    console.log(`📊 Time span: ${Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24))} days`);
                    
                    // 确保日期有效
                    if (isNaN(minDate) || isNaN(maxDate)) {
                        throw new Error('Date calculation failed');
                    }
                    
                    console.log('✅ Time range calculation successful');
                    
                } catch (dateError) {
                    console.error('❌ Date calculation error:', dateError);
                    console.log('🔍 Date calculation debug info:');
                    validTasks.forEach((task, idx) => {
                        console.log(`  Task ${idx + 1}: ${task.title}`);
                        console.log(`    Start date: ${task.startDate} -> ${new Date(task.startDate)}`);
                        console.log(`    End date: ${task.endDate} -> ${new Date(task.endDate)}`);
                    });
                    
                    ganttChart.innerHTML = `
                        <div class="error-state" style="padding: 20px; text-align: center; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                            <h3><i class="fas fa-exclamation-triangle" style="color: #856404;"></i> Date Data Error</h3>
                            <p>Task start or end date format is incorrect</p>
                            <p style="color: #666; font-size: 14px;">Error details: ${dateError.message}</p>
                        </div>
                    `;
                    return;
                }
                
                // 根据当前缩放级别生成日期列
                console.log('📅 =================== Date Column Generation ===================');
                let dateColumns;
                try {
                    const currentZoom = window.ganttConfig?.currentZoom || 'day';
                    console.log(`🔍 Current zoom level: ${currentZoom}`);
                    console.log(`📅 Time range: ${minDate} to ${maxDate}`);
                    
                    console.log('⏳ Calling generateDateColumnsWithZoom...');
                    dateColumns = generateDateColumnsWithZoom(minDate, maxDate, currentZoom);
                    
                    console.log('📅 Generated date columns:');
                    console.log(`  🔢 Date column count: ${dateColumns?.length || 0}`);
                    console.log(`  📊 Is array: ${Array.isArray(dateColumns)}`);
                    console.log('  📋 Date column details:', dateColumns);
                    
                    // 显示前几个日期列的内容
                    if (Array.isArray(dateColumns) && dateColumns.length > 0) {
                        console.log('📅 First few date column examples:');
                        dateColumns.slice(0, 5).forEach((col, idx) => {
                            console.log(`  ${idx + 1}. ${col.displayText} (${col.type}) - ${col.fullDate}`);
                        });
                        if (dateColumns.length > 5) {
                            console.log(`  ... ${dateColumns.length - 5} more date columns`);
                        }
                    }
                    
                    if (!Array.isArray(dateColumns) || dateColumns.length === 0) {
                        throw new Error('Date column generation failed - returned empty array or non-array');
                    }
                    
                    console.log('✅ Date column generation successful');
                    
                } catch (columnError) {
                    console.error('❌ Date column generation error:', columnError);
                    console.log('🔍 Date column generation debug info:');
                    console.log('  - minDate:', minDate);
                    console.log('  - maxDate:', maxDate);
                    console.log('  - currentZoom:', window.ganttConfig?.currentZoom);
                    console.log('  - ganttConfig:', window.ganttConfig);
                    
                    ganttChart.innerHTML = `
                        <div class="error-state" style="padding: 20px; text-align: center; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                            <h3><i class="fas fa-exclamation-triangle" style="color: #721c24;"></i> Date Column Generation Error</h3>
                            <p>Unable to generate Gantt chart timeline</p>
                            <p style="color: #666; font-size: 14px;">Error details: ${columnError.message}</p>
                        </div>
                    `;
                    return;
                }
                
                // 渲染甘特图
                console.log('🎨 =================== Gantt Chart HTML Rendering ===================');
                try {
                    console.log('📋 Starting to render task rows...');
                    console.log(`🔢 Number of tasks to render: ${validTasks.length}`);
                    // 计算横向总宽度，保证可滚动区域完整渲染
                    const zoomForWidth = (window.ganttConfig && window.ganttConfig.currentZoom) ? window.ganttConfig.currentZoom : 'day';
                    const baseColWidth = (zoomForWidth === 'week') ? 140 : 100;
                    const timelineWidthPx = Math.max(800, (dateColumns?.length || 0) * baseColWidth);
                    
                    const taskRows = validTasks.map((task, idx) => {
                        console.log(`📋 Rendering task ${idx + 1}: "${task.title}"`);
                        try {
                            const taskHtml = renderGanttTaskWithZoom(task, minDate, maxDate, dateColumns, timelineWidthPx);
                            console.log(`  ✅ Task ${idx + 1} rendered successfully`);
                            return taskHtml;
                        } catch (taskError) {
                            console.error(`  ❌ Task ${idx + 1} rendering error:`, taskError, task);
                            return `
                                <div class="gantt-task-row" style="background: #fff3cd; border: 1px solid #ffeaa7;">
                                    <div class="task-info" style="padding: 15px;">
                                        <div style="color: #856404;">
                                            <strong>Task Rendering Error:</strong> ${task.title || 'Unknown Task'}
                                            <br><small>${taskError.message}</small>
                                        </div>
                                    </div>
                                    <div class="timeline-content" style="padding: 15px; background: #fff3cd;">
                                        <small style="color: #856404;">Rendering Failed</small>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    console.log('✅ All task rows rendering completed');
                    console.log(`📊 Generated HTML rows count: ${taskRows.length}`);
                    
                    // 生成日期列标题HTML
                    console.log('📅 Generating date column header HTML...');
                    const dateHeaderHtml = dateColumns.map(dateInfo => `
                        <div class="date-column" style="width: ${baseColWidth}px;" title="${dateInfo.fullDate || dateInfo.displayText}">${dateInfo.displayText}</div>
                    `).join('');
                    console.log(`📅 Date column header HTML length: ${dateHeaderHtml.length} characters`);
                    
                    // 组装完整的甘特图HTML
                    console.log('🎨 Assembling complete Gantt chart HTML...');
                    const totalGridWidthPx = 300 + timelineWidthPx;
                    const ganttHtml = `
                        <div class="gantt-timeline">
                            <div class="gantt-tasks" style="width: ${totalGridWidthPx}px;">
                                <div class="gantt-header-row">
                                    <div class="task-info-header">Task Information</div>
                                    <div class="timeline-header" style="width: ${timelineWidthPx}px">
                                        ${dateHeaderHtml}
                                    </div>
                                </div>
                                ${taskRows.join('')}
                            </div>
                        </div>
                    `;
                    
                    console.log(`🎨 Complete Gantt chart HTML length: ${ganttHtml.length} characters`);
                    console.log('⏳ Inserting HTML into DOM...');
                    
                    ganttChart.innerHTML = ganttHtml;
                    
                    console.log('✅ Gantt chart HTML insertion successful');
                    
                    // 保存当前日期范围
                    if (window.ganttConfig) {
                        window.ganttConfig.startDate = minDate;
                        window.ganttConfig.endDate = maxDate;
                        console.log('💾 Gantt chart configuration updated:', window.ganttConfig);
                    }
                    
                    console.log('🎯 =================== Gantt Chart Rendering Complete ===================');
                    console.log(`✅ Gantt chart rendering successful!`);
                    console.log(`  📊 Task count: ${validTasks.length}`);
                    console.log(`  📅 Date column count: ${dateColumns.length}`);
                    console.log(`  📈 Time span: ${Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24))} days`);
                    console.log(`  🔍 Zoom level: ${window.ganttConfig?.currentZoom || 'day'}`);
                    
                } catch (renderError) {
                    console.error('❌ Gantt chart rendering error:', renderError);
                    console.log('🔍 Rendering error debug info:');
                    console.log('  - validTasks:', validTasks);
                    console.log('  - dateColumns:', dateColumns);
                    console.log('  - minDate:', minDate);
                    console.log('  - maxDate:', maxDate);
                    
                    ganttChart.innerHTML = `
                        <div class="error-state" style="padding: 20px; text-align: center; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                            <h3><i class="fas fa-exclamation-triangle" style="color: #721c24;"></i> Gantt Chart Rendering Failed</h3>
                            <p>Detected ${validTasks.length} valid tasks, but rendering process encountered an error</p>
                            <p style="color: #666; font-size: 14px;">Error details: ${renderError.message}</p>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="location.reload()">
                                    <i class="fas fa-refresh"></i> Reload Page
                                </button>
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('❌ Gantt chart overall rendering failed:', error);
                console.log('🔍 Overall rendering failure debug info:');
                console.log('  - error.stack:', error.stack);
                console.log('  - window.scrumTasks:', window.scrumTasks);
                console.log('  - window.ganttConfig:', window.ganttConfig);
                
                const ganttChart = document.getElementById('ganttChart');
                if (ganttChart) {
                    ganttChart.innerHTML = `
                        <div class="error-state" style="padding: 20px; text-align: center; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                            <h3><i class="fas fa-times-circle" style="color: #721c24;"></i> Gantt Chart Loading Failed</h3>
                            <p>Gantt chart component encountered a serious error and cannot display normally</p>
                            <p style="color: #666; font-size: 14px;">Technical error: ${error.message || error}</p>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="location.reload()">
                                    <i class="fas fa-refresh"></i> Reload Page
                                </button>
                                <button class="btn btn-secondary" onclick="console.log('Debug Info:', {scrumTasks: window.scrumTasks, ganttConfig: window.ganttConfig})" style="margin-left: 10px;">
                                    <i class="fas fa-bug"></i> Debug Info
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
        };

        // 生成日期列（原始版本，保持向后兼容）
        function generateDateColumns(startDate, endDate) {
            const dates = [];
            const currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return dates;
        }
        // 根据缩放级别生成日期列
        function generateDateColumnsWithZoom(startDate, endDate, zoomLevel) {
            try {
                const dateColumns = [];
                
                // 确保输入参数有效
                if (!startDate || !endDate || isNaN(startDate) || isNaN(endDate)) {
                    throw new Error('Invalid start or end date');
                }
                
                if (startDate > endDate) {
                    throw new Error('Start date cannot be later than end date');
                }
                
                // 防止无限循环的安全检查
                const maxDays = 365; // 最多一年的日期范围
                const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                if (daysDiff > maxDays) {
                    throw new Error(`Date range too large: ${daysDiff} days, maximum supported ${maxDays} days`);
                }
                
                if (zoomLevel === 'day') {
                    // 日视图：显示每一天
                    const currentDate = new Date(startDate);
                    let loopCount = 0;
                    const maxLoops = 400; // 防止无限循环
                    
                    while (currentDate <= endDate && loopCount < maxLoops) {
                        try {
                            dateColumns.push({
                                date: new Date(currentDate),
                                displayText: formatDateShort ? formatDateShort(currentDate) : `${currentDate.getMonth()+1}/${currentDate.getDate()}`,
                                fullDate: formatDateFull ? formatDateFull(currentDate) : currentDate.toDateString(),
                                type: 'day'
                            });
                            currentDate.setDate(currentDate.getDate() + 1);
                        } catch (e) {
                            console.error('Day view date processing error:', e);
                            break;
                        }
                        loopCount++;
                    }
                    
                    if (loopCount >= maxLoops) {
                        console.warn('Day view date generation loop count too high, possible issue');
                    }
                    
                } else if (zoomLevel === 'week') {
                    // 周视图：从"计划第一天"开始，每7天为一列，并在尾部额外扩展若干周
                    const firstDay = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                    const extraWeeksAfter = 2; // 末尾额外展示的周数
                    const endWithPadding = new Date(endDate);
                    endWithPadding.setDate(endWithPadding.getDate() + (extraWeeksAfter * 7));
                    
                    let weekStart = new Date(firstDay);
                    let weekNumber = 1;
                    let loopCount = 0;
                    const maxWeeks = 60; // 防止无限循环
                    
                    while (weekStart <= endWithPadding && loopCount < maxWeeks) {
                        try {
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekStart.getDate() + 6);
                            
                            const startText = formatDateShort ? formatDateShort(weekStart) : `${weekStart.getMonth()+1}/${weekStart.getDate()}`;
                            const endText = formatDateShort ? formatDateShort(weekEnd) : `${weekEnd.getMonth()+1}/${weekEnd.getDate()}`;
                            
                            dateColumns.push({
                                date: new Date(weekStart),
                                displayText: `Week ${weekNumber}`,
                                fullDate: `${startText} - ${endText}`,
                                type: 'week',
                                weekStart: new Date(weekStart),
                                weekEnd: new Date(weekEnd)
                            });
                            
                            weekStart.setDate(weekStart.getDate() + 7);
                            weekNumber++;
                        } catch (e) {
                            console.error('Week view date processing error:', e);
                            break;
                        }
                        loopCount++;
                    }
                    
                    if (loopCount >= maxWeeks) {
                        console.warn('Week view date generation loop count too high, possible issue');
                    }
                    
                } else if (zoomLevel === 'month') {
                    // 月视图：显示每一月
                    const currentDate = new Date(startDate);
                    // 找到第一个月的开始
                    const firstMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                    
                    let monthStart = new Date(firstMonth);
                    let loopCount = 0;
                    const maxMonths = 24; // 防止无限循环，最多24个月
                    
                    while (monthStart <= endDate && loopCount < maxMonths) {
                        try {
                            const monthEnd = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0); // 月末最后一天
                            
                            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                              'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            const monthName = monthNames[monthStart.getMonth()];
                            const year = monthStart.getFullYear();
                            
                            dateColumns.push({
                                date: new Date(monthStart),
                                displayText: `${monthName} ${year}`,
                                fullDate: `${monthName} ${year} (${monthStart.getMonth()+1}/1 - ${monthEnd.getMonth()+1}/${monthEnd.getDate()})`,
                                type: 'month',
                                monthStart: new Date(monthStart),
                                monthEnd: new Date(monthEnd)
                            });
                            
                            // 移动到下一个月
                            monthStart.setMonth(monthStart.getMonth() + 1);
                        } catch (e) {
                            console.error('Month view date processing error:', e);
                            break;
                        }
                        loopCount++;
                    }
                    
                    if (loopCount >= maxMonths) {
                        console.warn('Month view date generation loop count too high, possible issue');
                    }
                } else {
                    // 默认返回简单的日期列
                    console.warn('Unknown zoom level:', zoomLevel, 'using default processing');
                    const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                    const step = Math.max(1, Math.ceil(daysDiff / 20)); // 最多20列
                    
                    for (let i = 0; i <= daysDiff; i += step) {
                        const date = new Date(startDate.getTime() + i * 24 * 60 * 60 * 1000);
                        dateColumns.push({
                            date: date,
                            displayText: `${date.getMonth()+1}/${date.getDate()}`,
                            fullDate: date.toDateString(),
                            type: 'day'
                        });
                    }
                }
                
                if (dateColumns.length === 0) {
                    // 确保至少有一列
                    dateColumns.push({
                        date: new Date(startDate),
                        displayText: 'No Data',
                        fullDate: 'No Valid Date Data',
                        type: 'day'
                    });
                }
                
                return dateColumns;
                
            } catch (error) {
                console.error('generateDateColumnsWithZoom error:', error);
                // 返回最基本的结构以避免完全失败
                return [{
                    date: new Date(),
                    displayText: 'Error',
                    fullDate: error.message || 'Date generation error',
                    type: 'error'
                }];
            }
        }

        // 格式化日期（短格式）
        function formatDateShort(date) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}/${day}`;
        }

        // 格式化日期（完整格式）
        function formatDateFull(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const weekday = weekdays[date.getDay()];
            return `${year}-${month}-${day} ${weekday}`;
        }

        // 验证和修复任务日期
        function validateAndFixTaskDates() {
            console.log('🔍 Validating and fixing task dates...');
            
            if (!window.scrumTasks || typeof window.scrumTasks !== 'object') {
                console.log('❌ No scrumTasks found, skipping date validation');
                return;
            }
            
            let totalFixed = 0;
            const currentYear = new Date().getFullYear();
            
            Object.keys(window.scrumTasks).forEach(status => {
                if (status !== '__auto' && status !== '__aiGenerated' && Array.isArray(window.scrumTasks[status])) {
                    window.scrumTasks[status].forEach((task, idx) => {
                        let needsFix = false;
                        
                        // 检查开始日期
                        if (task.startDate && typeof task.startDate === 'string') {
                            const startYear = parseInt(task.startDate.split('-')[0]);
                            if (startYear < currentYear) {
                                console.log(`🔧 Fixing old start date: ${task.startDate} -> current date based`);
                                task.startDate = getDateAfterDays(idx); // 使用索引作为偏移
                                needsFix = true;
                            }
                        }
                        
                        // 检查结束日期
                        if (task.endDate && typeof task.endDate === 'string') {
                            const endYear = parseInt(task.endDate.split('-')[0]);
                            if (endYear < currentYear) {
                                console.log(`🔧 Fixing old end date: ${task.endDate} -> current date based`);
                                task.endDate = getDateAfterDays(idx + 3); // 开始日期后3天
                                needsFix = true;
                            }
                        }
                        
                        if (needsFix) {
                            totalFixed++;
                            console.log(`✅ Fixed dates for task: ${task.title} (${task.startDate} ~ ${task.endDate})`);
                        }
                    });
                }
            });
            
            console.log(`🔧 Total tasks with fixed dates: ${totalFixed}`);
        }

        // 渲染甘特图任务行（兼容性函数，默认按天计算）
        function renderGanttTask(task, minDate, maxDate, totalDays) {
            const taskStartDate = new Date(task.startDate);
            const taskEndDate = new Date(task.endDate);
            
            // 计算任务在时间轴上的位置和宽度（按天计算）
            const startOffset = Math.floor((taskStartDate - minDate) / (1000 * 60 * 60 * 24));
            const duration = Math.floor((taskEndDate - taskStartDate) / (1000 * 60 * 60 * 24)) + 1;
            
            const statusColors = {
                'todo': '#6c757d',
                'in-progress': '#ffc107',
                'done': '#28a745'
            };
            
            // 找到任务状态
            let taskStatus = 'todo';
            Object.keys(window.scrumTasks).forEach(status => {
                if (status !== '__auto' && status !== '__aiGenerated' && Array.isArray(window.scrumTasks[status])) {
                    if (window.scrumTasks[status].find(t => t.id === task.id)) {
                        taskStatus = status;
                    }
                }
            });
            
            // 分段（已完成/今天/未开始）计算
            const DAY_MS = 24 * 60 * 60 * 1000;
            const normalize = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
            const normStart = normalize(new Date(taskStartDate));
            const normEnd = normalize(new Date(taskEndDate));
            const daysDuration = Math.max(1, Math.round((normEnd - normStart) / DAY_MS) + 1);
            const today = normalize(new Date());
            let pastDays = 0, todayDays = 0, futureDays = daysDuration;
            if (today < normStart) {
                pastDays = 0; todayDays = 0; futureDays = daysDuration;
            } else if (today > normEnd) {
                pastDays = daysDuration; todayDays = 0; futureDays = 0;
            } else {
                pastDays = Math.max(0, Math.round((today - normStart) / DAY_MS));
                todayDays = 1;
                futureDays = Math.max(0, daysDuration - pastDays - todayDays);
            }
            const pastPct = Math.max(0, Math.min(100, (pastDays / daysDuration) * 100));
            const todayPct = Math.max(0, Math.min(100, (todayDays / daysDuration) * 100));
            const futurePct = Math.max(0, 100 - pastPct - todayPct);
            
            return `
                <div class="gantt-task-row">
                    <div class="task-info">
                        <div class="task-info-content">
                            <div class="task-title-gantt">${task.title}</div>
                            <div class="task-meta">
                                <span class="task-priority priority-${task.priority}">Priority: ${task.priority}</span>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-content">
                        <div class="gantt-bar-container" style="position: relative;">
                            <div class="gantt-bar charging" 
                                 style="left: ${(startOffset / totalDays) * 100}%; 
                                        width: ${(duration / totalDays) * 100}%; 
                                        background: transparent; overflow: hidden;">
                                <div class="gantt-segments">
                                    ${pastDays > 0 ? `<div class="gantt-segment segment-past" style="width: ${pastPct}%;"></div>` : ''}
                                    ${todayDays > 0 ? `<div class="gantt-segment segment-today quick-charge" style="width: ${todayPct}%;"></div>` : ''}
                                    ${futureDays > 0 ? `<div class="gantt-segment segment-future" style="width: ${futurePct}%;"></div>` : ''}
                                </div>
                                <span class="gantt-bar-text" style="z-index:2;">${task.title}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 支持缩放的甘特图任务渲染
        function renderGanttTaskWithZoom(task, minDate, maxDate, dateColumns, timelineWidthPx) {
            try {
                // 参数验证
                if (!task || !task.startDate || !task.endDate || !task.title) {
                    throw new Error('Task data incomplete');
                }
                
                if (!minDate || !maxDate || !Array.isArray(dateColumns)) {
                    throw new Error('Date parameters invalid');
                }
                
                if (!timelineWidthPx || isNaN(timelineWidthPx)) {
                    throw new Error('Timeline width parameter invalid');
                }
                
                const taskStartDate = new Date(task.startDate);
                const taskEndDate = new Date(task.endDate);
                const DAY_MS = 24 * 60 * 60 * 1000;
                const normalize = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
                const normMin = normalize(new Date(minDate));
                const normStart = normalize(taskStartDate);
                const normEnd = normalize(taskEndDate);
                
                // 验证日期有效性
                if (isNaN(taskStartDate) || isNaN(taskEndDate)) {
                    throw new Error('Task date format invalid');
                }
                
                const statusColors = {
                    'todo': '#6c757d',
                    'in-progress': '#ffc107',
                    'done': '#28a745'
                };
                
                // 找到任务状态
                let taskStatus = 'todo';
                try {
                    if (window.scrumTasks && typeof window.scrumTasks === 'object') {
                        Object.keys(window.scrumTasks).forEach(status => {
                            if (status !== '__auto' && status !== '__aiGenerated' && Array.isArray(window.scrumTasks[status])) {
                                if (window.scrumTasks[status].find(t => t && t.id === task.id)) {
                                    taskStatus = status;
                                }
                            }
                        });
                    }
                } catch (statusError) {
                    console.warn('Failed to get task status:', statusError);
                    // 使用默认状态
                }
                
                const zoomLevel = window.ganttConfig?.currentZoom || 'day';
                let startOffset, duration;
                
                try {
                    if (zoomLevel === 'day') {
                        // 日视图：按天计算（零点对齐，避免时区偏差）
                        startOffset = Math.max(0, Math.round((normStart - normMin) / DAY_MS));
                        duration = Math.max(1, Math.round((normEnd - normStart) / DAY_MS) + 1);
                    } else if (zoomLevel === 'week') {
                        // 周视图：以"天"为最小刻度进行定位和宽度计算，但表头仍以周列显示
                        const DAY_MS = 24 * 60 * 60 * 1000;
                        const getAlignedMonday = (base) => {
                            const d = new Date(base);
                            const dow = d.getDay();
                            const daysToMonday = dow === 0 ? 6 : dow - 1;
                            d.setDate(d.getDate() - daysToMonday);
                            return new Date(d.getFullYear(), d.getMonth(), d.getDate());
                        };

                        // 表头的第一列起点：现在从"计划第一天"开始，不强制对齐周一
                        let baseStart;
                        if (Array.isArray(dateColumns) && dateColumns.length > 0) {
                            const firstCol = dateColumns[0];
                            baseStart = new Date(firstCol.date || firstCol.weekStart || normMin);
                        } else {
                            baseStart = new Date(normMin);
                        }
                        baseStart = new Date(baseStart.getFullYear(), baseStart.getMonth(), baseStart.getDate());

                        const totalDaysAll = Math.max(1, (dateColumns.length || 1) * 7);
                        const leftDays = Math.max(0, Math.floor((normStart - baseStart) / DAY_MS));
                        const widthDays = Math.max(1, Math.floor((normEnd - normStart) / DAY_MS) + 1);

                        // 将"天"映射为相对整段的百分比，以避免 3天/7天 被放大为整周
                        startOffset = leftDays; // 仅用于日志，不再直接用于百分比
                        duration = widthDays;

                        // 覆盖下面的百分比计算使用 totalDaysAll
                        var __weekly_totalDaysAll = totalDaysAll;
                        var __weekly_leftDays = leftDays;
                        var __weekly_widthDays = widthDays;
                    } else {
                        // 默认处理：按天计算
                        startOffset = Math.max(0, Math.round((normStart - normMin) / DAY_MS));
                        duration = Math.max(1, Math.round((normEnd - normStart) / DAY_MS) + 1);
                    }
                    
                    // 确保偏移量和持续时间为有效值
                    startOffset = Math.max(0, startOffset || 0);
                    duration = Math.max(1, duration || 1);
                    
                } catch (dateCalcError) {
                    console.warn('Date calculation failed:', dateCalcError);
                    startOffset = 0;
                    duration = 1;
                }
                
                const totalColumns = Math.max(1, dateColumns.length);
                const daysDuration = Math.max(1, Math.round((normEnd - normStart) / DAY_MS) + 1);
                
                // 安全地处理各种属性
                const safeTitle = (task.title || 'Unnamed Task').toString();
                const safeAssignee = (task.assignee || 'Unassigned').toString();
                const safeStoryPoints = isNaN(task.storyPoints) ? 0 : Number(task.storyPoints);
                const safePriority = ['high', 'medium', 'low'].includes(task.priority) ? task.priority : 'medium';
                const safeProgress = (task.progress && !isNaN(task.progress)) ? Math.min(100, Math.max(0, Number(task.progress))) : null;
                
                // 计算安全的百分比值
                let leftPercent;
                let widthPercent;
                if (zoomLevel === 'week' && typeof __weekly_totalDaysAll !== 'undefined') {
                    // 使用基于"天"的映射比例，保证 3天/7天 不会被放大为整周
                    leftPercent = Math.max(0, Math.min(100, (__weekly_leftDays / __weekly_totalDaysAll) * 100));
                    widthPercent = Math.max(1, Math.min(100, (__weekly_widthDays / __weekly_totalDaysAll) * 100));
                } else {
                    leftPercent = Math.max(0, Math.min(100, (startOffset / totalColumns) * 100));
                    widthPercent = Math.max(1, Math.min(100, (duration / totalColumns) * 100));
                }
                // 防溢出：确保条形不会超出容器
                widthPercent = Math.min(widthPercent, 100 - leftPercent);
                
                // 分段（已完成/今天/未开始）计算
                const today = normalize(new Date());
                let pastDays = 0, todayDays = 0, futureDays = daysDuration;
                if (today < normStart) {
                    pastDays = 0; todayDays = 0; futureDays = daysDuration;
                } else if (today > normEnd) {
                    pastDays = daysDuration; todayDays = 0; futureDays = 0;
                } else {
                    pastDays = Math.max(0, Math.round((today - normStart) / DAY_MS));
                    todayDays = 1;
                    futureDays = Math.max(0, daysDuration - pastDays - todayDays);
                }
                const pastPct = Math.max(0, Math.min(100, (pastDays / daysDuration) * 100));
                const todayPct = Math.max(0, Math.min(100, (todayDays / daysDuration) * 100));
                const futurePct = Math.max(0, 100 - pastPct - todayPct);
                
                return `
                    <div class="gantt-task-row" style="display:flex; align-items: stretch; gap: 8px; margin-bottom: 8px;">
                        <div class="task-info" style="flex: 0 0 300px; max-width: 300px;">
                            <div class="task-info-content" style="display:flex; flex-direction: column; gap:4px;">
                                <div class="task-title-gantt" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${safeTitle}</div>
                                <div class="task-meta" style="display:flex; gap:8px; flex-wrap: wrap;">
                                    <span class="task-priority priority-${safePriority}">Priority: ${safePriority}</span>
                                </div>
                                <div class="task-dates" style="font-size: 11px; color: #666;">
                                    ${task.startDate} ~ ${task.endDate} (${daysDuration} days)
                                </div>
                            </div>
                        </div>
                        <div class="timeline-content" style="flex:1; width: ${timelineWidthPx}px;">
                            <div class="gantt-bar-container" style="position: relative; height: 28px;">
                                <div class="gantt-bar charging" 
                                     data-task-id="${task.id || ''}"
                                     data-task-title="${safeTitle.replace(/"/g,'&quot;')}"
                                     data-task-assignee="${safeAssignee.replace(/"/g,'&quot;')}"
                                     data-task-dates="${task.startDate} ~ ${task.endDate} (${daysDuration} days)"
                                     data-task-priority="${safePriority}"
                                     data-task-explain="${(task.aiExplanation || '').toString().replace(/"/g,'&quot;')}"
                                     onmouseenter="showGanttTooltip(event)" 
                                     onmouseleave="hideGanttTooltip()"
                                     onmousemove="moveGanttTooltip(event)"
                                     style="position: absolute; top:0; bottom:0; left: ${leftPercent}%; 
                                            width: ${widthPercent}%; 
                                            background: transparent; border-radius: 4px; overflow: hidden;">
                                    <div class="gantt-segments">
                                        ${pastDays > 0 ? `<div class="gantt-segment segment-past" style="width: ${pastPct}%;"></div>` : ''}
                                        ${todayDays > 0 ? `<div class="gantt-segment segment-today quick-charge" style="width: ${todayPct}%;"></div>` : ''}
                                        ${futureDays > 0 ? `<div class="gantt-segment segment-future" style="width: ${futurePct}%;"></div>` : ''}
                                    </div>
                                    <span class="gantt-bar-text" style="position:absolute; left:8px; top:50%; transform: translateY(-50%); font-size:12px; white-space:nowrap; z-index:2;">${daysDuration} days</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('renderGanttTaskWithZoom error:', error, task);
                // 返回错误显示的任务行
                const errorTitle = task?.title || 'Error Task';
                return `
                    <div class="gantt-task-row" style="background: #fff3cd; border: 1px solid #ffeaa7;">
                        <div class="task-info" style="padding: 15px;">
                            <div style="color: #856404;">
                                <strong>Task Rendering Error:</strong> ${errorTitle}
                                <br><small>${error.message || error}</small>
                            </div>
                        </div>
                        <div class="timeline-content" style="padding: 15px; background: #fff3cd;">
                            <small style="color: #856404;">Rendering Failed</small>
                        </div>
                    </div>
                `;
            }
        }

        // 计算任务在周视图中的周索引
        function getWeekIndex(taskDate, startDate) {
            try {
                if (!taskDate || !startDate || isNaN(taskDate) || isNaN(startDate)) {
                    console.warn('getWeekIndex: Invalid date parameters', { taskDate, startDate });
                    return 0;
                }
                
                const msPerWeek = 7 * 24 * 60 * 60 * 1000;
                const diffMs = taskDate - startDate;
                
                if (isNaN(diffMs)) {
                    console.warn('getWeekIndex: Date difference calculation failed');
                    return 0;
                }
                
                const weekIndex = Math.floor(diffMs / msPerWeek);
                
                // 确保返回非负数
                return Math.max(0, weekIndex);
                
            } catch (error) {
                console.error('getWeekIndex error:', error);
                return 0;
            }
        }



        // 甘特图全局配置
        window.ganttConfig = {
            currentZoom: 'day', // 'day' 或 'week'
            startDate: null,
            endDate: null
        };

        // 调整甘特图缩放
        window.adjustGanttZoom = function(zoomLevel) {
            console.log('Adjusting Gantt chart zoom level:', zoomLevel);
            window.ganttConfig.currentZoom = zoomLevel;
            
            // 更新按钮状态
            document.querySelectorAll('.gantt-controls .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            const activeBtn = document.querySelector(`[onclick="adjustGanttZoom('${zoomLevel}')"]`);
            if (activeBtn) {
                activeBtn.classList.remove('btn-secondary');
                activeBtn.classList.add('btn-primary');
            }
            
            // 重新渲染甘特图
            renderGanttChart();
        };



        // 显示添加任务模态框
        window.showAddTaskModal = function(status) {
            console.log('Show add task modal:', status);
            // 这里可以实现添加任务的功能
            alert(`Add new task to "${status}" column feature is under development...`);
        };
        // 进入Scrum执行（仅甘特图）：调用AI/回退生成计划并显示甘特图
        window.goToScrumExecution = async function() {
            try {
                // 控制台打印（不再在页面输出详细调试项）
                const log = (msg, detail) => {
                    console.log('[Scrum]', `[${new Date().toLocaleTimeString()}]`, msg, detail || '');
                };

                // 轻量进度提示（仅显示关键步骤）
                function ensureScrumProgressPanel() {
                    const container = document.querySelector('#gantt-view .gantt-container');
                    if (!container) return null;
                    let panel = document.getElementById('scrumProgressPanel');
                    if (!panel) {
                        panel = document.createElement('div');
                        panel.id = 'scrumProgressPanel';
                        panel.className = 'scrum-progress';
                        panel.style.margin = '8px 0';
                        panel.style.background = '#f8f9fa';
                        panel.style.border = '1px solid #e9ecef';
                        panel.style.borderRadius = '8px';
                        panel.style.padding = '8px 10px';
                        panel.style.fontSize = '12px';
                        panel.style.color = '#333';
                        const label = document.createElement('div');
                        label.className = 'scrum-progress-label';
                        label.textContent = '甘特图生成中...';
                        panel.appendChild(label);
                        const ganttChartEl = document.getElementById('ganttChart');
                        container.insertBefore(panel, ganttChartEl || container.firstChild);
                    }
                    return panel;
                }

                function addScrumProgress(message) {
                    const panel = ensureScrumProgressPanel();
                    if (!panel) return;
                    const label = panel.querySelector('.scrum-progress-label');
                    if (label) {
                        // 如果是甘特图生成相关的消息，显示"正在生成甘特图"
                        if (message.includes('甘特图') || message.includes('ensureScrumPlanReady') || message.includes('生成')) {
                            label.textContent = 'Generating Gantt chart...';
                            panel.style.display = 'block';
                        } else {
                            label.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                        }
                    }
                }

                function hideScrumProgressPanel() {
                    const panel = document.getElementById('scrumProgressPanel');
                    if (panel) {
                        panel.style.display = 'none';
                        // 清空进度标签内容
                        const label = panel.querySelector('.scrum-progress-label');
                        if (label) {
                            label.textContent = '';
                        }
                    }
                }

                log('Starting Scrum execution');
                addScrumProgress('Starting Scrum execution');
                
                // 强制验证和修复任务日期（确保没有旧日期）
                console.log('🔄 Scrum execution - validating task dates...');
                validateAndFixTaskDates();
                
                // 初始化甘特图配置（确保配置存在）
                if (!window.ganttConfig) {
                    window.ganttConfig = {
                        currentZoom: 'day',
                        startDate: null,
                        endDate: null
                    };
                    log('Initialize Gantt chart configuration');
                }
                
                // 切换到Scrum模块
                if (typeof switchModule === 'function') {
                    log('Call switchModule("scrum")');
                    addScrumProgress('Call switchModule("scrum")');
                    switchModule('scrum');
                } else {
                    log('fallback switch to scrum module');
                    document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
                    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                    const sm = document.getElementById('scrum-module');
                    const scrumTab = document.querySelector('[data-module="scrum"]');
                    if (sm) sm.classList.add('active');
                    if (scrumTab) scrumTab.classList.add('active');
                }

                // 检查是否已有AI生成的任务数据（排除预设的默认数据）
                const hasAIGeneratedTasks = window.scrumTasks && window.scrumTasks.__auto && window.scrumTasks.__aiGenerated &&
                    Object.keys(window.scrumTasks).some(key => 
                        key !== '__auto' && key !== '__aiGenerated' && Array.isArray(window.scrumTasks[key]) && window.scrumTasks[key].length > 0
                    );
                
                if (hasAIGeneratedTasks) {
                    log('Detected existing AI-generated task data, skipping regeneration');
                    log(`Current task statistics: ${Object.keys(window.scrumTasks).filter(k => k !== '__auto' && k !== '__aiGenerated').map(k => `${k}(${window.scrumTasks[k].length})`).join(', ')}`);
                } else {
                    // 清除预设数据，强制AI重新生成
                    log('Clear preset task data, prepare for AI generation');
                    window.scrumTasks = {
                        todo: [],
                        'in-progress': [],
                        done: [],
                        __auto: false,
                        __aiGenerated: false
                    };
                    // 调用自动生成（AI优先，失败回退）
                    if (typeof window.ensureScrumPlanReady === 'function') {
                        log('Call ensureScrumPlanReady()');
                        addScrumProgress('Call ensureScrumPlanReady()');
                        await window.ensureScrumPlanReady();
                    } else if (typeof window.generateScrumPlanFromContext === 'function') {
                        log('Call generateScrumPlanFromContext()');
                        await window.generateScrumPlanFromContext();
                    } else {
                        log('Generation function not found, using default task data');
                        // 如果生成函数不存在，确保有基本的任务数据
                        if (!window.scrumTasks || !window.scrumTasks.__auto) {
                            window.scrumTasks = {
                                todo: [
                                    {
                                        id: 'fallback-1',
                                        title: 'Material Procurement Optimization',
                                        description: 'Implement eco-friendly material procurement strategy',
                                        assignee: 'Procurement Dept',
                                        priority: 'high',
                                        storyPoints: 8,
                                        startDate: getDateAfterDays(0),
                                        endDate: getDateAfterDays(7),
                                        tags: ['Procurement', 'Environmental']
                                    }
                                ],
                                'in-progress': [],
                                done: [],
                                __auto: true,
                                __aiGenerated: false    // 标记为回退方案，非AI生成
                            };
                        }
                    }
                }

                // 确保甘特图视图存在
                const ganttView = document.getElementById('gantt-view');
                if (!ganttView) {
                    log('Gantt view container not found');
                    throw new Error('Gantt view container does not exist');
                }

                // 显示甘特图视图
                log('Switch to Gantt view');
                addScrumProgress('Switch to Gantt view');
                ganttView.style.display = 'block';
                
                // 隐藏其他视图
                const allViews = document.querySelectorAll('.scrum-view');
                allViews.forEach(view => {
                    if (view.id !== 'gantt-view') {
                        view.style.display = 'none';
                    }
                });

                // 检查甘特图是否需要重新渲染
                const ganttChart = document.getElementById('ganttChart');
                const needsGanttRender = !ganttChart || !ganttChart.innerHTML || ganttChart.innerHTML.trim() === '' ||
                                       ganttChart.innerHTML.includes('暂无任务数据') || 
                                       ganttChart.innerHTML.includes('甘特图加载中');
                
                if (needsGanttRender) {
                    log('Gantt chart needs rendering, calling renderGanttChart()');
                    try {
                        if (typeof window.renderGanttChart === 'function') {
                            window.renderGanttChart();
                            log('Gantt chart rendering function call completed');
                            // 甘特图渲染完成，隐藏进度面板
                            setTimeout(() => {
                                hideScrumProgressPanel();
                            }, 500); // 延迟500ms确保渲染完成
                        } else {
                            log('renderGanttChart function does not exist, using simplified rendering');
                            if (ganttChart) {
                                ganttChart.innerHTML = `
                                    <div style="padding: 20px; text-align: center;">
                                        <h3>Gantt Chart Loading...</h3>
                                        <p>Task data is ready, rendering Gantt chart interface</p>
                                        <div style="margin-top: 20px;">
                                            <i class="fas fa-chart-gantt" style="font-size: 48px; color: #007bff;"></i>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    } catch (renderError) {
                        log('Gantt chart rendering error', renderError);
                        // 提供备用渲染
                        if (ganttChart) {
                            const taskCount = Object.values(window.scrumTasks || {}).reduce((count, tasks) => {
                                return count + (Array.isArray(tasks) ? tasks.length : 0);
                            }, 0);
                            
                            ganttChart.innerHTML = `
                                <div style="padding: 20px; text-align: center; background: #f8f9fa; border-radius: 8px;">
                                    <h3><i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i> Gantt Chart Rendering Issue</h3>
                                    <p>Detected ${taskCount} tasks, but Gantt chart rendering encountered technical issues</p>
                                    <p style="color: #666; font-size: 14px;">Error details: ${renderError.message || renderError}</p>
                                    <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 15px;">
                                        <i class="fas fa-refresh"></i> Reload Page
                                    </button>
                                </div>
                            `;
                        }
                    }
                } else {
                    log('Gantt chart already has valid content, skipping duplicate rendering');
                    log('Current Gantt chart content length:', ganttChart ? ganttChart.innerHTML.length : 0);
                    // 甘特图已存在，直接隐藏进度面板
                    setTimeout(() => {
                        hideScrumProgressPanel();
                    }, 200);
                }

                // 检查最终结果
                const gantt = document.getElementById('ganttChart');
                if (!gantt) {
                    log('#ganttChart container not found');
                    throw new Error('Gantt chart container element does not exist');
                } else if (!gantt.innerHTML || gantt.innerHTML.trim() === '') {
                    log('Gantt container is empty, tasks may not have been generated or rendering failed');
                    gantt.innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <h3>Gantt Chart is Empty</h3>
                            <p>Please check if task data was generated correctly</p>
                        </div>
                    `;
                } else {
                    log('Gantt chart rendering completed');
                    // 甘特图渲染完成，隐藏进度面板
                    setTimeout(() => {
                        hideScrumProgressPanel();
                    }, 300);
                    // 滚动到甘特图位置
                    gantt.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                log('Scrum execution module loading completed');
                addScrumProgress('Scrum execution module loading completed');
                
            } catch (e) {
                console.error('Scrum execution entry failed:', e);
                const debugPanel = document.getElementById('scrumDebugPanel');
                if (debugPanel) {
                    debugPanel.style.display = 'block';
                    const err = document.createElement('div');
                    err.style.color = '#721c24';
                    err.style.background = '#f8d7da';
                    err.style.border = '1px solid #f5c6cb';
                    err.style.padding = '8px';
                    err.style.borderRadius = '6px';
                    err.style.marginTop = '6px';
                    err.textContent = `Error: ${e && e.message ? e.message : e}`;
                    err.innerHTML += `<br><small>Stack: ${e.stack ? e.stack.slice(0,200) : 'None'}</small>`;
                    debugPanel.appendChild(err);
                }
                
                // 即使出错也尝试显示Scrum模块
                try {
                    document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
                    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                    const sm = document.getElementById('scrum-module');
                    const scrumTab = document.querySelector('[data-module="scrum"]');
                    if (sm) sm.classList.add('active');
                    if (scrumTab) scrumTab.classList.add('active');
                    
                    const gantt = document.getElementById('ganttChart');
                    if (gantt) {
                        gantt.innerHTML = `
                            <div style="padding: 20px; text-align: center; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
                                <h3><i class="fas fa-exclamation-triangle" style="color: #856404;"></i> Loading Encountered Issues</h3>
                                <p>Scrum module encountered technical issues during loading, but you can still view the basic interface</p>
                                <p style="color: #666; font-size: 14px;">For detailed error information, please check the debug panel below</p>
                                <button class="btn btn-warning" onclick="location.reload()" style="margin-top: 15px;">
                                    <i class="fas fa-refresh"></i> Reload Page
                                </button>
                            </div>
                        `;
                    }
                } catch (fallbackError) {
                    console.error('Fallback display also failed:', fallbackError);
                }
                
                alert('Scrum execution entry failed, please check the debug panel for detailed information. It is recommended to refresh the page and try again.');
            }
        };

        // 页面加载时初始化Scrum模块
        document.addEventListener('DOMContentLoaded', function() {
            initializeScrumModule();
        });

        // 重新渲染Lean模块的时间数据
        function refreshLeanTimelineData() {
            const timelineCardsContainer = document.querySelector('.timeline-cards-lean');
            if (timelineCardsContainer && typeof generateTimelineCardsHtml === 'function') {
                timelineCardsContainer.innerHTML = generateTimelineCardsHtml();
            }
        }
        
        // 重新渲染Lean模块的碳排放数据
        function refreshLeanEmissionData() {
            const emissionCardsContainer = document.querySelector('.emission-cards-lean');
            if (emissionCardsContainer && typeof generateEmissionCardsForLean === 'function') {
                emissionCardsContainer.innerHTML = generateEmissionCardsForLean();
            }
        }
        
        // 渲染时间和碳排放数据卡片
        function renderDataCards() {
            // 刷新Lean模块的时间数据显示
            refreshLeanTimelineData();
            const emissionsData = window.analysisData?.emissions || {};
            const timelineData = window.analysisData?.timeline || {};
            
            // 计算累积改进效果
            const improvements = window.calculateCumulativeImprovements ? window.calculateCumulativeImprovements() : { carbon: {}, time: {} };
            
            // 注意：原本的碳排放和时间数据渲染逻辑已移除，
            // 因为相应的DOM容器(emissionsData, timelineData)在当前页面中不存在
            // 实际的数据展示通过其他方式处理
        }

        // 获取碳排放阶段图标
        function getEmissionIcon(phase) {
            const icons = {
                procurement: 'fa-shopping-cart',
                manufacturing: 'fa-industry',
                logistics: 'fa-truck',
                usage: 'fa-user',
                recycling: 'fa-recycle',
                decomposition: 'fa-leaf'
            };
            return icons[phase] || 'fa-chart-bar';
        }

        // 获取碳排放阶段名称
        function getEmissionPhaseName(phase) {
            const names = {
                procurement: 'Raw Material Procurement',
                manufacturing: 'Manufacturing',
                logistics: 'Logistics',
                usage: 'Product Usage',
                recycling: 'Recycling Processing',
                decomposition: 'Natural Decomposition'
            };
            return names[phase] || phase;
        }

        // 获取时间阶段图标
        function getTimelineIcon(phase) {
            const icons = {
                procurement: 'fa-shopping-cart',
                manufacturing: 'fa-industry',
                logistics: 'fa-truck',
                usage: 'fa-user',
                recycling: 'fa-recycle',
                decomposition: 'fa-leaf'
            };
            return icons[phase] || 'fa-clock';
        }

        // 获取时间阶段名称
        function getTimelinePhaseName(phase) {
            const names = {
                procurement: 'Raw Material Procurement',
                manufacturing: 'Manufacturing',
                logistics: 'Logistics',
                usage: 'Product Usage',
                recycling: 'Recycling Processing',
                decomposition: 'Natural Decomposition'
            };
            return names[phase] || phase;
        }

        // 获取fallback建议
        function getFallbackSuggestions(area) {
            const fallbackData = {
                'Raw Material Procurement': [
                    {
                        icon: 'fas fa-truck',
                        title: 'Optimize Supplier Selection',
                        timeImprovement: 'Reduce 3 months',
                        carbonReduction: 'Reduce 15%',
                        desc: 'Choose closer suppliers to reduce transportation distance and carbon emissions',
                        subProject: 'Supplier Management',
                        carbonImprovements: { procurement: 15, manufacturing: 0, logistics: 10, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 3, manufacturing: 0, logistics: 0, usage: 0, recycling: 0, decomposition: 0 }
                    },
                    {
                        icon: 'fas fa-recycle',
                        title: 'Improve Material Recycling Rate',
                        timeImprovement: 'Increase 2 months',
                        carbonReduction: 'Reduce 25%',
                        desc: 'Use more recycled materials, which may increase procurement time but significantly reduce carbon emissions',
                        subProject: 'Material Selection',
                        carbonImprovements: { procurement: 25, manufacturing: 0, logistics: 0, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: -2, manufacturing: 0, logistics: 0, usage: 0, recycling: 0, decomposition: 0 }
                    }
                ],
                'Key Component Manufacturing': [
                    {
                        icon: 'fas fa-cogs',
                        title: 'Optimize Production Process',
                        timeImprovement: 'Reduce 5 months',
                        carbonReduction: 'Reduce 20%',
                        desc: 'Improve manufacturing processes to increase efficiency and reduce energy consumption',
                        subProject: 'Process Optimization',
                        carbonImprovements: { procurement: 0, manufacturing: 20, logistics: 0, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 0, manufacturing: 5, logistics: 0, usage: 0, recycling: 0, decomposition: 0 }
                    },
                    {
                        icon: 'fas fa-industry',
                        title: 'Use Rapid Prototyping Technology',
                        timeImprovement: 'Reduce 8 months',
                        carbonReduction: 'Increase 10%',
                        desc: 'Adopt rapid prototyping technology to shorten production cycle, but may increase energy consumption',
                        subProject: 'Technology Upgrade',
                        carbonImprovements: { procurement: 0, manufacturing: -10, logistics: 0, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 0, manufacturing: 8, logistics: 0, usage: 0, recycling: 0, decomposition: 0 }
                    }
                ],
                'Supply Chain Management': [
                    {
                        icon: 'fas fa-route',
                        title: 'Optimize Logistics Routes',
                        timeImprovement: 'Reduce 4 months',
                        carbonReduction: 'Reduce 18%',
                        desc: 'Redesign transportation routes to reduce shipping time and carbon emissions',
                        subProject: 'Logistics Optimization',
                        carbonImprovements: { procurement: 0, manufacturing: 0, logistics: 18, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 0, manufacturing: 0, logistics: 4, usage: 0, recycling: 0, decomposition: 0 }
                    },
                    {
                        icon: 'fas fa-shipping-fast',
                        title: 'Express Transportation Solution',
                        timeImprovement: 'Reduce 6 months',
                        carbonReduction: 'Increase 12%',
                        desc: 'Adopt express transportation methods to shorten delivery time, but will increase carbon emissions',
                        subProject: 'Transportation Strategy',
                        carbonImprovements: { procurement: 0, manufacturing: 0, logistics: -12, usage: 0, recycling: 0, decomposition: 0 },
                        timeImprovements: { procurement: 0, manufacturing: 0, logistics: 6, usage: 0, recycling: 0, decomposition: 0 }
                    }
                ]
            };
            
            return fallbackData[area] || [];
        }
    </script>
    <script>
        // 页面加载后，为防止初次无痕，轻量初始化底部面板
        document.addEventListener('DOMContentLoaded', function() {
            const panel = document.getElementById('bottomAIChat');
            if (panel) {
                panel.style.display = 'none';
            }
        });
    </script>
    <style>
        /* 甘特图悬浮提示 */
        .gantt-tooltip {
            position: fixed;
            z-index: 3000;
            background: #1f2937;
            color: #f9fafb;
            padding: 10px 12px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
            font-size: 12px;
            line-height: 1.5;
            max-width: 320px;
            pointer-events: none;
            display: none;
        }
        .gantt-tooltip .gt-title { font-weight: 600; margin-bottom: 4px; color: #93c5fd; }
        .gantt-tooltip .gt-row { margin-top: 4px; color: #e5e7eb; }
        .gantt-tooltip .gt-label { color: #9ca3af; margin-right: 4px; }
        .gantt-tooltip .gt-explain { margin-top: 6px; color: #fef3c7; }
        .improvement-notice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .improvement-badge {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .nav-brand span {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
        }

        /* 深度分析模态框样式 */
        .deep-analysis-modal .modal-content {
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
        }

        .analysis-progress {
            padding: 20px;
        }

        .progress-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #ddd;
            transition: all 0.3s ease;
        }

        .progress-item.active {
            background: #e3f2fd;
            border-left-color: #2196f3;
            animation: pulse 1.5s infinite;
        }

        .progress-item.completed {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }

        .progress-item i {
            margin-right: 15px;
            font-size: 18px;
            color: #666;
        }

        .progress-item.active i {
            color: #2196f3;
        }

        .progress-item.completed i {
            color: #4caf50;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .analysis-summary {
            padding: 20px;
        }

        .analysis-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analysis-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }

        .analysis-card.risk-assessment {
            border-left-color: #dc3545;
        }

        .analysis-card.optimization-potential {
            border-left-color: #28a745;
        }

        .analysis-card.recommendations {
            border-left-color: #ffc107;
        }

        .analysis-card h5 {
            margin: 0 0 15px 0;
            color: #333;
            display: flex;
            align-items: center;
        }

        .analysis-card h5 i {
            margin-right: 10px;
        }

        .risk-item, .potential-item, .recommendation-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .risk-item:last-child, .potential-item:last-child, .recommendation-item:last-child {
            border-bottom: none;
        }

        .risk-item.high {
            color: #dc3545;
            font-weight: 500;
        }

        .risk-item.medium {
            color: #ffc107;
            font-weight: 500;
        }

        .risk-item.low {
            color: #28a745;
            font-weight: 500;
        }

        .analysis-chat {
            border-top: 1px solid #eee;
            padding: 20px;
        }

        #deepChatMessages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .large-modal {
            max-width: 900px !important;
            width: 90% !important;
        }

        /* 新增样式：个性化建议和状态持久化 */
        .solution-area-card {
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .solution-area-card.selected {
            border: 2px solid #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
        }

        /* 移除has-accepted样式，方案内容分析区域不因采纳建议而变色 */
        .solution-area-card.has-accepted {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
        }

        .accepted-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* 建议卡片样式优化 */
        .suggestion-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .suggestion-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .suggestion-card.accepted {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
        }

        .suggestion-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .suggestion-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .suggestion-icon i {
            color: white;
            font-size: 20px;
        }

        .suggestion-title {
            flex: 1;
        }

        .suggestion-title h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
        }

        .improvement-metrics {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .metric {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .metric.improvement {
            background: #e8f5e8;
            color: #28a745;
            border: 1px solid #c3e6c3;
        }

        .metric.tradeoff {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .metric i {
            font-size: 12px;
        }

        .suggestion-content {
            margin-bottom: 20px;
        }

        .suggestion-desc {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .suggestion-details {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .sub-project {
            background: #f8f9fa;
            color: #6c757d;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            border: 1px solid #e9ecef;
        }

        .suggestion-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .accepted-status {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #28a745;
            font-weight: 500;
            font-size: 14px;
        }

        .accepted-status i {
            font-size: 16px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* 数据卡片样式优化 */
        .data-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }

        .data-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .data-card .card-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .data-card .card-icon i {
            color: white;
            font-size: 16px;
        }

        .data-card .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .data-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }

        .emission-value, .duration-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .unit {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .data-card .progress-bar {
            margin-top: auto;
        }

        .improvement-indicator {
            color: #28a745;
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .timeline-change-badge,
        .emission-change-badge {
            font-size: 12px;
            font-weight: 500;
            margin-left: 6px;
        }

        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* 深度分析AI助手样式 */
        .suggestion-consult-header {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .suggestion-consult-header h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }

        .suggestion-description {
            background: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .ai-consult-guide {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .ai-consult-guide h5 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .consult-options {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .consult-options li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .consult-options li i {
            width: 20px;
            text-align: center;
        }

        .ai-welcome-message {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .ai-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message-content {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            flex: 1;
            line-height: 1.5;
        }

        /* 加载状态样式 */
        .loading-suggestions {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .loading-suggestions i {
            font-size: 24px;
            margin-bottom: 10px;
            color: #007bff;
        }



        .metric-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .metric-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }

        .metric-values {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .metric-values .before {
            color: #666;
        }

        .metric-values .after {
            color: #28a745;
            font-weight: bold;
        }

        .metric-values .after.pending {
            color: #ffc107;
            font-style: italic;
        }

        .improvement-rate {
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .improvement-rate.positive {
            background: #d4edda;
            color: #155724;
        }

        .improvement-rate.pending {
            background: #fff3cd;
            color: #856404;
        }

        /* AI分析助手弹窗高度优化 */
        .modal-content {
            max-height: 85vh !important;
            height: auto !important;
            overflow-y: auto;
        }

        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .ai-response {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
        }

        /* 对话历史样式优化 */
        .history-messages {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .history-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #007bff;
        }

        .history-question {
            margin-bottom: 8px;
            color: #333;
        }

        .history-answer {
            margin-bottom: 5px;
            color: #666;
            line-height: 1.4;
        }

        .history-time {
            font-size: 12px;
            color: #999;
            text-align: right;
        }

        /* ==================== Scrum模块样式 ==================== */
        
        /* Scrum控制面板 */
        .scrum-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .view-switcher {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .view-btn:hover {
            border-color: #007bff;
            color: #007bff;
        }

        .view-btn.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }

        .sprint-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .sprint-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .sprint-name {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .sprint-dates {
            color: #666;
            font-size: 14px;
        }

        .sprint-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar-scrum {
            width: 200px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill-scrum {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        /* Scrum内容布局 */
        /* 仅在切换到Scrum模块时显示，由styles.css里的 .module/.module.active 控制 */
        /* [MODIFIED][Impact: 仅影响显示控制][Backward Compatibility: 不影响其他样式] */

        #scrum-module .module-header {
            margin-bottom: 20px;
        }

        #scrum-module .scrum-controls {
            margin-bottom: 20px;
        }

        /* Kanban看板样式 */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            min-height: 600px;
        }

        .kanban-column {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px dashed #e0e0e0;
            transition: all 0.3s ease;
        }

        .kanban-column.drag-over {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .column-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .task-count {
            background: #007bff;
            color: white;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: bold;
        }

        .add-task-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-task-btn:hover {
            background: #218838;
            transform: scale(1.1);
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 400px;
        }

        /* 任务卡片样式 */
        .task-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #e0e0e0;
            cursor: grab;
            transition: all 0.3s ease;
        }

        .task-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .task-card.dragging {
            opacity: 0.6;
            transform: rotate(5deg);
            cursor: grabbing;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-priority {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .task-points {
            background: #f8f9fa;
            color: #666;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .task-title {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .task-description {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .task-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .task-tag {
            background: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .task-progress {
            margin-bottom: 10px;
        }

        .progress-bar-task {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill-task {
            height: 100%;
            background: #28a745;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .task-assignee {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .assignee-avatar {
            font-size: 16px;
        }

        .assignee-name {
            color: #666;
            font-weight: 500;
        }

        .task-dates {
            color: #999;
        }

        /* 甘特图样式 */
        .gantt-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .gantt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .gantt-controls {
            display: flex;
            gap: 10px;
        }

        .gantt-timeline {
            overflow-x: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .gantt-header-row {
            display: grid;
            grid-template-columns: 300px 1fr;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            font-weight: bold;
        }

        .task-info-header {
            padding: 15px;
            border-right: 1px solid #e0e0e0;
            color: #333;
        }

        .timeline-header {
            display: flex;
            /* 移除固定min-width，使用动态计算的宽度 */
        }

        .date-column {
            /* 使用动态宽度，通过内联样式设置具体宽度 */
            min-width: 60px;
            padding: 15px 5px;
            text-align: center;
            border-right: 1px solid #e0e0e0;
            color: #666;
            font-size: 12px;
            flex-shrink: 0; /* 防止列被压缩 */
        }

        .gantt-task-row {
            display: grid;
            grid-template-columns: 300px 1fr;
            border-bottom: 1px solid #e0e0e0;
            min-height: 60px;
        }

        .task-info {
            padding: 15px;
            border-right: 1px solid #e0e0e0;
            background: white;
            overflow: hidden; /* 防止内容溢出 */
        }

        .task-info-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
            max-width: 270px; /* 确保内容不会超出容器 */
        }

        .task-title-gantt {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .task-meta {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap; /* 允许换行 */
            max-width: 100%;
        }

        .task-priority {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap; /* 防止文字换行 */
            flex-shrink: 0; /* 防止被压缩 */
        }

        .task-story-points {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: #6c757d;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }

        .task-dates {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .priority-high {
            background: #f8d7da;
            color: #721c24;
        }

        .priority-medium {
            background: #fff3cd;
            color: #856404;
        }

        .priority-low {
            background: #d4edda;
            color: #155724;
        }

        .timeline-content {
            padding: 10px;
            background: #fafafa;
            /* 移除固定min-width，使用动态宽度 */
        }

        .gantt-bar-container {
            height: 40px;
            position: relative;
        }

        .gantt-bar {
            position: absolute;
            height: 24px;
            top: 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            color: #111;
            font-size: 12px;
            font-weight: 500;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .gantt-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            border-radius: 4px;
        }

        .gantt-bar-text {
            position: relative;
            z-index: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }





        /* 任务移动通知 */
        .task-move-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .task-move-notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .task-move-notification i {
            font-size: 18px;
        }

        /* 响应式设计 */

        @media (max-width: 768px) {
            .suggestions-grid {
                grid-template-columns: 1fr;
            }
            
            .suggestion-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .suggestion-icon {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .improvement-metrics {
                justify-content: center;
            }
            
            .suggestion-actions {
                justify-content: center;
            }
            
            .scrum-controls {
                flex-direction: column;
                gap: 20px;
            }
            
            .kanban-board {
                grid-template-columns: 1fr;
            }
            
            .gantt-timeline {
                font-size: 12px;
            }
            
            .timeline-header {
                /* 移除固定min-width，使用动态宽度 */
                overflow-x: hidden;
            }
        }
    </style>

    <script>
        (function () {
            // Three-phase aggregation configuration
            const DIMENSION_MAPPING_3P = {
                production: {
                    name: 'Production Phase',
                    icon: 'fas fa-industry',
                    color: '#667eea',
                    components: ['procurement', 'manufacturing'],
                    desc: 'Raw Material Procurement + Manufacturing'
                },
                circulation: {
                    name: 'Circulation Phase',
                    icon: 'fas fa-truck',
                    color: '#764ba2',
                    components: ['logistics', 'usage'],
                    desc: 'Logistics Transportation + Product Usage'
                },
                endoflife: {
                    name: 'End-of-Life Phase',
                    icon: 'fas fa-recycle',
                    color: '#f093fb',
                    components: ['recycling', 'decomposition'],
                    desc: 'Recycling Processing + Natural Decomposition'
                }
            };

            const original = {
                renderTimeline: window.renderTimeline,
                renderEmissionCards: window.renderEmissionCards,
                openAIModal: window.openAIModal,
                generateEmissionCardsForLean: window.generateEmissionCardsForLean,
                generateTimelineCardsHtml: window.generateTimelineCardsHtml
            };

            // 子环节名称与图标映射（用于明细显示）
            const COMPONENT_NAME_MAP = {
                procurement:'Raw Material Procurement', manufacturing:'Manufacturing', logistics:'Logistics Transportation', usage:'Product Usage', recycling:'Recycling Processing', decomposition:'Natural Decomposition'
            };
            const COMPONENT_ICON_MAP = {
                procurement:'fas fa-shopping-cart', manufacturing:'fas fa-industry', logistics:'fas fa-truck', usage:'fas fa-user-check', recycling:'fas fa-recycle', decomposition:'fas fa-seedling'
            };

            // ========= 更智能的子环节生成（AI优先，带缓存，三大环节不变，细分随产品变化） =========
            function getProductTypeFromContext() {
                try {
                    const t = (window.currentAnalysis && window.currentAnalysis.documentType) || (window.analysisData && window.analysisData.documentType);
                    return (typeof t === 'string' && t.trim()) ? t.trim().toLowerCase() : 'general';
                } catch { return 'general'; }
            }

            function safeParseJSON(text) {
                if (!text || typeof text !== 'string') return null;
                // 尝试截取第一个 JSON 数组/对象
                const start = text.indexOf('{');
                const end = text.lastIndexOf('}');
                if (start >= 0 && end > start) {
                    try { return JSON.parse(text.slice(start, end + 1)); } catch {}
                }
                try { return JSON.parse(text); } catch { return null; }
            }

            function allocateByWeights(total, items, weightKey) {
                if (!(total > 0)) total = Math.round(Math.random()*200 + 60);
                const weights = items.map(i => Math.max(1, Number(i[weightKey]) || 1));
                const sum = weights.reduce((a,b)=>a+b,0);
                let remaining = total;
                return items.map((it, idx) => {
                    if (idx === items.length - 1) return Math.max(1, remaining);
                    const ideal = total * (weights[idx] / sum);
                    const jitter = ideal * (Math.random() - 0.5) * 0.15; // ±15% 抖动
                    const val = Math.max(1, Math.round(ideal + jitter));
                    remaining -= val;
                    return val;
                });
            }

            function generateHeuristicTemplate(productType, phaseKey, n = 6) {
                // 基于文档关键词与常识动态组合，避免死板预设
                const doc = (typeof getOriginalDocumentContent === 'function') ? (getOriginalDocumentContent() || '') : '';
                const kw = (doc.toLowerCase().match(/[a-z]{4,}/g) || []).slice(0, 50);
                const tokenBank = {
                    production: ['Design', 'Sourcing', 'Pre-assembly', 'Assembly', 'Calibration', 'Testing', 'Packaging', 'Quality'],
                    circulation: ['International Shipping', 'Domestic Shipping', 'Warehousing', 'Distribution', 'Retail', 'User Operation', 'Standby'],
                    endoflife: ['Collection', 'Dismantling', 'Sorting', 'Material Recovery', 'Hazardous Handling', 'Recycling', 'Disposal']
                };
                const iconBank = {
                    production: ['fas fa-drafting-compass','fas fa-shopping-cart','fas fa-tools','fas fa-industry','fas fa-balance-scale','fas fa-vial','fas fa-box','fas fa-clipboard-check'],
                    circulation: ['fas fa-ship','fas fa-truck','fas fa-warehouse','fas fa-route','fas fa-store','fas fa-bolt','fas fa-plug'],
                    endoflife: ['fas fa-recycle','fas fa-tools','fas fa-tasks','fas fa-coins','fas fa-biohazard','fas fa-sync','fas fa-trash']
                };
                const base = tokenBank[phaseKey] || tokenBank.production;
                const icons = iconBank[phaseKey] || iconBank.production;
                const items = [];
                for (let i = 0; i < n; i++) {
                    const k = base[i % base.length];
                    const extra = kw[i % Math.max(1, kw.length)] || productType;
                    const label = `${k}`;
                    items.push({ id: `${phaseKey}_${i}`, label, icon: icons[i % icons.length], timeWeight: Math.round(10 + Math.random()*40), carbonWeight: Math.round(10 + Math.random()*40) });
                }
                return items;
            }

            async function fetchAISubstagesTemplate(productType, phaseKey) {
                try {
                    window.__substageCache = window.__substageCache || {};
                    const cacheKey = `${productType}:${phaseKey}`;
                    if (window.__substageCache[cacheKey]) return window.__substageCache[cacheKey];

                    const aiPrompt = `You are an expert in lifecycle analysis. Generate 5-8 substages for the phase "${phaseKey}" (phases are fixed to production, circulation, endoflife) for a product type "${productType}". Also generate 2-3 concrete improvement suggestions mapping to these substages.
For each suggestion, provide explicit six-stage after-values for time (day) and carbon (kgCO2e), human-readable deltas, target KPIs, and 3-5 actionable steps. Return STRICT JSON:
{
  "items": [ { "id": string, "label": string, "icon": string, "timeWeight": number, "carbonWeight": number, "timeImpactPct": number, "carbonImpactPct": number } ],
  "suggestions": [ { "title": string, "desc": string, "targets": [string], "kpis": [string], "actions": [string], "timeAfter": {"procurement": number, "manufacturing": number, "logistics": number, "usage": number, "recycling": number, "decomposition": number}, "carbonAfter": {"procurement": number, "manufacturing": number, "logistics": number, "usage": number, "recycling": number, "decomposition": number}, "delta": {"time": string, "carbon": string} } ]
}
Use Font Awesome icon for icons. timeAfter uses day (positive integer), carbonAfter uses kgCO2e (>=0, 1 decimal). Ensure keys cover six stages.`;
                    let aiResp = null;
                    if (typeof window.callAI === 'function') {
                        try { aiResp = await window.callAI(aiPrompt, null); } catch {}
                    }
                    let parsed = safeParseJSON(aiResp);
                    if (!parsed || !Array.isArray(parsed.items)) {
                        // 回退：基于上下文的启发式生成
                        parsed = { items: generateHeuristicTemplate(productType, phaseKey), suggestions: [] };
                    }
                    window.__substageCache[cacheKey] = parsed.items;
                    // 也缓存建议供后续使用
                    window.__substageSuggestionCache = window.__substageSuggestionCache || {};
                    window.__substageSuggestionCache[phaseKey] = parsed.suggestions || [];
                    return parsed.items;
                } catch (e) {
                    console.warn('AI template fetch failed, fallback to heuristic:', e);
                    return generateHeuristicTemplate(productType, phaseKey);
                }
            }

            async function getSubstageItems(type, phaseKey) {
                const productType = getProductTypeFromContext();
                const template = await fetchAISubstagesTemplate(productType, phaseKey);
                const weightKey = type === 'time' ? 'timeWeight' : 'carbonWeight';
                // 计算总量
                const cfg = DIMENSION_MAPPING_3P[phaseKey];
                const tl = (window.analysisData && window.analysisData.timeline) || {};
                const em = (window.analysisData && window.analysisData.emissions) || {};
                const total = (type === 'time')
                    ? cfg.components.reduce((s,k)=>s+(tl[k]?.duration||0),0)
                    : cfg.components.reduce((s,k)=>s+(em[k]?.value||0),0);
                const values = allocateByWeights(total, template, weightKey);
                return template.map((it, idx) => ({
                    key: it.id || `${phaseKey}_${idx}`,
                    label: it.label,
                    icon: it.icon || COMPONENT_ICON_MAP[cfg.components[idx % cfg.components.length]],
                    value: Math.max(1, values[idx]),
                    unit: type === 'time' ? 'day' : 'kgCO2e',
                    timeImpactPct: typeof it.timeImpactPct === 'number' ? it.timeImpactPct : 0,
                    carbonImpactPct: typeof it.carbonImpactPct === 'number' ? it.carbonImpactPct : 0
                }));
            }

            // 渲染子环节明细（支持异步生成；可指定容器）
            window.renderSubphaseDetails = async function(type, phaseKey, containerOverrideId) {
                try {
                    const cfg = DIMENSION_MAPPING_3P[phaseKey];
                    const containerId = containerOverrideId || (type === 'time' ? 'timePhaseDetails' : 'carbonPhaseDetails');
                    const target = document.getElementById(containerId);
                    if (!target) return;
                    target.innerHTML = `<div class="phase-details"><h4><i class="${type==='time' ? 'fas fa-stopwatch' : 'fas fa-leaf'}"></i> ${cfg.name} — ${type==='time' ? 'Time breakdown' : 'Carbon breakdown'}</h4><div class="details-grid"><div class="detail-card"><div class="detail-icon"><i class="fas fa-spinner fa-spin"></i></div><div class="detail-content"><div class="detail-title">Loading...</div></div></div></div></div>`;
                    const items = await getSubstageItems(type, phaseKey);
                    target.innerHTML = `
                        <div class="phase-details">
                            <h4><i class="${type==='time' ? 'fas fa-stopwatch' : 'fas fa-leaf'}"></i> ${cfg.name} — ${type==='time' ? 'Time breakdown' : 'Carbon breakdown'}</h4>
                            <div class="details-grid">
                                ${items.map(it => `
                                    <div class="detail-card" data-type="${type}" data-phase="${phaseKey}" data-sub-label="${(it.label+'').replace(/"/g,'&quot;')}" onclick="window.onSubstageClick && window.onSubstageClick('${type}','${phaseKey}','${(it.label+'').replace(/"/g,'&quot;')}')">
                                        <div class="detail-icon"><i class="${it.icon}"></i></div>
                                        <div class="detail-content">
                                            <div class="detail-title">${it.label}</div>
                                            <div class="detail-value">${it.value} <span class="unit">${it.unit}</span></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } catch(e) {
                    console.warn('Render subphase details failed:', e);
                }
            };

            

            function getDurationDays(item) {
                if (!item) return 0;
                if (typeof item.duration === 'number') return item.duration;
                if (typeof item.originalDuration === 'number') return item.originalDuration;
                if (typeof item.duration === 'string') {
                    const s = item.duration;
                    if (s.includes('天')) return parseInt(s) || 0;
                    if (s.includes('个月')) return (parseInt(s) || 0) * 30;
                    if (s.includes('年')) return (parseInt(s) || 0) * 365;
                }
                return 0;
            }

            function aggregateTimeline(timeline) {
                // 已是三阶段则直接返回
                if (timeline && (timeline.production || timeline.circulation || timeline.endoflife)) return timeline;
                
                // 使用window.analysisData中的timeline数据
                const inputTimeline = window.analysisData?.timeline || {};
                const result = {};
                
                // 直接从DIMENSION_MAPPING_3P配置中聚合数据
                Object.entries(DIMENSION_MAPPING_3P).forEach(([phaseKey, config]) => {
                    const total = config.components.reduce((sum, componentKey) => {
                        const component = inputTimeline[componentKey];
                        if (component) {
                            // 使用originalDuration或duration，确保数据一致性
                            const duration = component.originalDuration || component.duration || 0;
                            console.log(`${componentKey}: ${duration} days`);
                            return sum + duration;
                        }
                        return sum;
                    }, 0);
                    
                    result[phaseKey] = { 
                        duration: total, 
                        unit: 'day', 
                        description: config.desc, 
                        components: config.components 
                    };
                });
                
                console.log('Final timeline aggregation:', result);
                return result;
            }

            function aggregateEmissions(emissions) {
                const totals = {};
                Object.entries(DIMENSION_MAPPING_3P).forEach(([k, cfg]) => {
                    const breakdown = {};
                    const value = cfg.components.reduce((sum, c) => {
                        const v = (emissions && emissions[c] && typeof emissions[c].value === 'number') ? emissions[c].value : 0;
                        breakdown[c] = v;
                        return sum + v;
                    }, 0);
                    totals[k] = {
                        value,
                        kpiName: cfg.name,
                        components: cfg.components,
                        breakdown
                    };
                });
                // 计算等级
                const maxV = Math.max(1, ...Object.values(totals).map(o => o.value || 0));
                Object.keys(totals).forEach(k => {
                    const r = (totals[k].value || 0) / maxV;
                    totals[k].level = r >= 0.66 ? 'high' : (r >= 0.33 ? 'medium' : 'low');
                });
                return totals;
            }

            // 将六阶段键聚合为三阶段
            function aggregateSixToThree(map) {
                const safe = map || {};
                const v = (k) => {
                    const n = safe[k];
                    return typeof n === 'number' && isFinite(n) ? n : 0;
                };
                return {
                    production: v('procurement') + v('manufacturing'),
                    circulation: v('logistics') + v('usage'),
                    endoflife: v('recycling') + v('decomposition')
                };
            }

            // 覆盖：时间改进汇总（按三阶段聚合）
            window.computeTimeChangeSummary = function (suggestion) {
                try {
                    const tl = (window.analysisData && window.analysisData.timeline) || {};
                    const baseSix = {
                        procurement: tl.procurement?.duration || 0,
                        manufacturing: tl.manufacturing?.duration || 0,
                        logistics: tl.logistics?.duration || 0,
                        usage: tl.usage?.duration || 0,
                        recycling: tl.recycling?.duration || 0,
                        decomposition: tl.decomposition?.duration || 0
                    };
                    // 计算after（优先timeAfter，其次timeImprovements）
                    let afterSix = { ...baseSix };
                    if (suggestion?.timeAfter && typeof suggestion.timeAfter === 'object') {
                        Object.keys(afterSix).forEach(k => {
                            const raw = suggestion.timeAfter[k];
                            if (typeof raw === 'number' && isFinite(raw) && raw > 0) afterSix[k] = Math.max(1, Math.round(raw));
                        });
                    } else if (suggestion?.timeImprovements && typeof suggestion.timeImprovements === 'object') {
                        Object.keys(afterSix).forEach(k => {
                            const pct = suggestion.timeImprovements[k];
                            if (typeof pct === 'number' && isFinite(pct)) {
                                const factor = 1 - pct / 100;
                                afterSix[k] = Math.max(1, Math.round(baseSix[k] * factor));
                            }
                        });
                    }

                    const before3 = aggregateSixToThree(baseSix);
                    const after3 = aggregateSixToThree(afterSix);
                    const totalBefore = Object.values(before3).reduce((a, b) => a + b, 0);
                    const totalAfter = Object.values(after3).reduce((a, b) => a + b, 0);
                    const delta = Math.round(totalBefore - totalAfter);
                    return { isImprovement: delta >= 0, displayText: `Time: ${delta >= 0 ? 'Reduce' : 'Increase'} ${Math.abs(delta)} days` };
                } catch {
                    return { isImprovement: true, displayText: 'Time: No Change' };
                }
            };

            // 覆盖：碳排放改进汇总（按三阶段聚合）
            window.computeCarbonChangeSummary = function (suggestion) {
                try {
                    const em = (window.analysisData && window.analysisData.emissions) || {};
                    const baseSix = {
                        procurement: em.procurement?.value || 0,
                        manufacturing: em.manufacturing?.value || 0,
                        logistics: em.logistics?.value || 0,
                        usage: em.usage?.value || 0,
                        recycling: em.recycling?.value || 0,
                        decomposition: em.decomposition?.value || 0
                    };
                    let afterSix = { ...baseSix };
                    if (suggestion?.carbonAfter && typeof suggestion.carbonAfter === 'object') {
                        Object.keys(afterSix).forEach(k => {
                            const raw = suggestion.carbonAfter[k];
                            if (typeof raw === 'number' && isFinite(raw) && raw >= 0) afterSix[k] = Math.round(raw);
                        });
                    } else if (suggestion?.carbonImprovements && typeof suggestion.carbonImprovements === 'object') {
                        Object.keys(afterSix).forEach(k => {
                            const pct = suggestion.carbonImprovements[k];
                            if (typeof pct === 'number' && isFinite(pct)) {
                                const factor = 1 - pct / 100;
                                afterSix[k] = Math.max(0, Math.round(baseSix[k] * factor));
                            }
                        });
                    }
                    const before3 = aggregateSixToThree(baseSix);
                    const after3 = aggregateSixToThree(afterSix);
                    const totalBefore = Object.values(before3).reduce((a, b) => a + b, 0);
                    const totalAfter = Object.values(after3).reduce((a, b) => a + b, 0);
                    const deltaPct = totalBefore > 0 ? Math.round(((totalBefore - totalAfter) / totalBefore) * 100) : 0;
                    return { isImprovement: deltaPct >= 0, displayText: `Carbon Emissions: ${deltaPct >= 0 ? 'Reduce' : 'Increase'} ${Math.abs(deltaPct)}%` };
                } catch {
                    return { isImprovement: true, displayText: 'Carbon Emissions: No Change' };
                }
            };

            // 覆盖：逐阶段明细（按三阶段聚合显示）
            window.computePhaseChangeDetails = function (suggestion) {
                try {
                    const em = (window.analysisData && window.analysisData.emissions) || {};
                    const tl = (window.analysisData && window.analysisData.timeline) || {};
                    const baseCarbonSix = {
                        procurement: em.procurement?.value || 0,
                        manufacturing: em.manufacturing?.value || 0,
                        logistics: em.logistics?.value || 0,
                        usage: em.usage?.value || 0,
                        recycling: em.recycling?.value || 0,
                        decomposition: em.decomposition?.value || 0
                    };
                    const baseTimeSix = {
                        procurement: tl.procurement?.duration || 0,
                        manufacturing: tl.manufacturing?.duration || 0,
                        logistics: tl.logistics?.duration || 0,
                        usage: tl.usage?.duration || 0,
                        recycling: tl.recycling?.duration || 0,
                        decomposition: tl.decomposition?.duration || 0
                    };
                    let afterCarbonSix = { ...baseCarbonSix };
                    let afterTimeSix = { ...baseTimeSix };
                    if (suggestion?.carbonAfter) {
                        Object.keys(afterCarbonSix).forEach(k => {
                            const raw = suggestion.carbonAfter[k];
                            if (typeof raw === 'number' && isFinite(raw) && raw >= 0) afterCarbonSix[k] = Math.round(raw);
                        });
                    } else if (suggestion?.carbonImprovements) {
                        Object.keys(afterCarbonSix).forEach(k => {
                            const pct = suggestion.carbonImprovements[k];
                            if (typeof pct === 'number' && isFinite(pct)) afterCarbonSix[k] = Math.max(0, Math.round(baseCarbonSix[k] * (1 - pct / 100)));
                        });
                    }
                    if (suggestion?.timeAfter) {
                        Object.keys(afterTimeSix).forEach(k => {
                            const raw = suggestion.timeAfter[k];
                            if (typeof raw === 'number' && isFinite(raw) && raw > 0) afterTimeSix[k] = Math.max(1, Math.round(raw));
                        });
                    } else if (suggestion?.timeImprovements) {
                        Object.keys(afterTimeSix).forEach(k => {
                            const pct = suggestion.timeImprovements[k];
                            if (typeof pct === 'number' && isFinite(pct)) afterTimeSix[k] = Math.max(1, Math.round(baseTimeSix[k] * (1 - pct / 100)));
                        });
                    }

                    const beforeCarbon3 = aggregateSixToThree(baseCarbonSix);
                    const afterCarbon3 = aggregateSixToThree(afterCarbonSix);
                    const beforeTime3 = aggregateSixToThree(baseTimeSix);
                    const afterTime3 = aggregateSixToThree(afterTimeSix);

                    const label = { production: 'Production Phase', circulation: 'Circulation Phase', endoflife: 'End-of-Life Phase' };
                    const carbonHtml = ['production','circulation','endoflife'].map(k => {
                        const b = beforeCarbon3[k];
                        const a = afterCarbon3[k];
                        const deltaPct = b > 0 ? Math.round(((b - a) / b) * 100) : 0;
                        const arrow = deltaPct > 0 ? '↓' : (deltaPct < 0 ? '↑' : '');
                        const pctText = deltaPct === 0 ? '0%' : `${arrow}${Math.abs(deltaPct)}%`;
                        return `${label[k]}: ${b}→${a} (${pctText})`;
                    }).join(', ');
                    const timeHtml = ['production','circulation','endoflife'].map(k => {
                        const b = beforeTime3[k];
                        const a = afterTime3[k];
                        const deltaPct = b > 0 ? Math.round(((b - a) / b) * 100) : 0;
                        const arrow = deltaPct > 0 ? '↓' : (deltaPct < 0 ? '↑' : '');
                        const pctText = deltaPct === 0 ? '0%' : `${arrow}${Math.abs(deltaPct)}%`;
                        return `${label[k]}: ${b}→${a} (${pctText})`;
                    }).join(', ');

                    return { carbonHtml, timeHtml };
                } catch {
                    return { carbonHtml: '', timeHtml: '' };
                }
            };

            // 覆盖时间线渲染为三阶段 - 比例时间轴版本
            window.renderTimeline = function (timelineData) {
                try {
                    const timeline = document.getElementById('reverseTimeline');
                    if (!timeline) return original.renderTimeline && original.renderTimeline(timelineData);
                    const data3 = aggregateTimeline(timelineData);
                    
                    // 逆时间轴顺序：从结束到开始 (End-of-Life → Circulation → Production)
                    const order = ['endoflife', 'circulation', 'production'];
                    
                    // 计算总时间和比例
                    const totalDuration = order.reduce((sum, key) => sum + (data3[key].duration || 0), 0);
                    
                    // 提供给后续模块使用
                    window.currentTimelineData = order.map(key => ({
                        phase: DIMENSION_MAPPING_3P[key].name,
                        icon: DIMENSION_MAPPING_3P[key].icon,
                        color: DIMENSION_MAPPING_3P[key].color,
                        description: DIMENSION_MAPPING_3P[key].desc,
                        duration: `${data3[key].duration}${data3[key].unit}`,
                        percentage: totalDuration > 0 ? ((data3[key].duration || 0) / totalDuration * 100).toFixed(1) : 0
                    }));

                    // 生成新的简洁时间轴HTML结构
                    timeline.innerHTML = `
                        <div class="proportional-timeline is-active">
                            <div class="timeline-title"><i class="fas fa-clock"></i> Time</div>
                            <div class="timeline-bar-container">
                                ${order.map(key => {
                                    const cfg = DIMENSION_MAPPING_3P[key];
                                    const val = data3[key];
                                    const percentage = totalDuration > 0 ? (val.duration / totalDuration * 100) : (100 / order.length);
                                    
                                    return `
                                        <div class="timeline-bar-segment ${key}" 
                                             style="width: ${percentage}%;" 
                                             data-phase="${key}"
                                             data-duration="${val.duration}"
                                             data-percentage="${percentage.toFixed(1)}">
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div class="timeline-labels">
                                ${order.map(key => {
                                    const cfg = DIMENSION_MAPPING_3P[key];
                                    const val = data3[key];
                                    const percentage = totalDuration > 0 ? ((val.duration / totalDuration) * 100).toFixed(1) : 0;
                                    return `
                                        <div class="timeline-label ${key}" data-phase="${key}">
                                            <div class="timeline-label-icon">
                                                <i class="${cfg.icon}"></i>
                                            </div>
                                            <div class="timeline-label-title">${cfg.name}</div>
                                            <div class="timeline-label-duration">${val.duration} day</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div id="timePhaseDetails" class="phase-details-container"></div>
                        </div>
                    `;

                    // 为条形图和标签添加点击事件
                    order.forEach(key => {
                        const barSegment = timeline.querySelector(`.timeline-bar-segment[data-phase="${key}"]`);
                        const labelSegment = timeline.querySelector(`.timeline-label[data-phase="${key}"]`);
                        
                        const clickHandler = () => {
                            // 展示细分详情
                            const fakeEmission = { value: 0, breakdown: {} };
                            if (window.analysisData && window.analysisData.emissions) {
                                const br = {};
                                DIMENSION_MAPPING_3P[key].components.forEach(c => { 
                                    br[c] = window.analysisData.emissions[c]?.value || 0; 
                                });
                                fakeEmission.breakdown = br;
                                fakeEmission.value = Object.values(br).reduce((a,b)=>a+b,0);
                            }
                            openAIModal(key, fakeEmission);
                        };
                        
                        if (barSegment) barSegment.addEventListener('click', () => { clickHandler(); window.renderSubphaseDetails('time', key); });
                        if (labelSegment) labelSegment.addEventListener('click', () => { clickHandler(); window.renderSubphaseDetails('time', key); });
                    });

                } catch (e) {
                    console.error('渲染比例时间轴时出错:', e);
                    // 回退到原始渲染方式
                    if (original.renderTimeline) return original.renderTimeline(timelineData);
                }
            };

            // 覆盖排放卡片渲染为三阶段
            window.renderEmissionCards = function () {
                try {
                    const container = document.getElementById('emissionCards');
                    if (!container) return original.renderEmissionCards && original.renderEmissionCards();
                    container.innerHTML = '';

                    const emissions = (window.analysisData && window.analysisData.emissions) || {};
                    const grouped = aggregateEmissions(emissions);
                    const order = ['production', 'circulation', 'endoflife'];
                    const totalValue = order.reduce((sum, k) => sum + (grouped[k]?.value || 0), 0);

                    // 生成比例条 + 标签结构（与时间轴一致）
                    container.innerHTML = `
                        <div class="proportional-timeline is-active">
                            <div class="timeline-title"><i class=\"fas fa-leaf\"></i> Carbon Emissions</div>
                            <div class="timeline-bar-container">
                                ${order.map(key => {
                                    const e = grouped[key] || { value: 0 };
                                    const pct = totalValue > 0 ? (e.value / totalValue * 100) : (100 / order.length);
                                    return `
                                        <div class=\"timeline-bar-segment ${key}\" style=\"width: ${pct}%\" data-phase=\"${key}\" data-value=\"${e.value}\"></div>
                                    `;
                                }).join('')}
                            </div>
                            <div class="timeline-labels">
                                ${order.map(key => {
                                    const cfg = DIMENSION_MAPPING_3P[key];
                                    const e = grouped[key] || { value: 0 };
                                    const pct = totalValue > 0 ? ((e.value / totalValue) * 100).toFixed(1) : '0.0';
                                    return `
                                        <div class=\"timeline-label ${key}\" data-phase=\"${key}\"> 
                                            <div class=\"timeline-label-icon\"><i class=\"${cfg.icon}\"></i></div>
                                            <div class=\"timeline-label-title\">${cfg.name}</div>
                                            <div class=\"timeline-label-duration\">${e.value} kgCO2e</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div id=\"carbonPhaseDetails\" class=\"phase-details-container\"></div>
                        </div>
                    `;

                    // 点击条或标签弹出细分（Kanban下已抑制弹窗，这里保留一致行为）
                    order.forEach(key => {
                        const bar = container.querySelector(`.timeline-bar-segment.${key}`);
                        const label = container.querySelector(`.timeline-label.${key}`);
                        const handler = () => {
                            const e = grouped[key] || { value: 0, breakdown: {} };
                            openAIModal(key, e);
                            window.renderSubphaseDetails('carbon', key);
                        };
                        if (bar) bar.addEventListener('click', handler);
                        if (label) label.addEventListener('click', handler);
                    });
                } catch (e) {
                    if (original.renderEmissionCards) return original.renderEmissionCards();
                }
            };

            // 兼容三阶段的AI弹窗
            window.openAIModal = function (emissionType, emissionData) {
                const is3Phase = ['production','circulation','endoflife'].includes(emissionType);
                if (!is3Phase && typeof original.openAIModal === 'function') {
                    return original.openAIModal(emissionType, emissionData);
                }

                // 在Kanban模块中抑制弹窗
                const currentModule = document.querySelector('.nav-tab.active')?.dataset.module || 'kanban';
                if (currentModule === 'kanban') {
                    return;
                }

                try {
                    window.selectedEmissionData = { type: emissionType, data: emissionData };
                    const modal = document.getElementById('aiModal');
                    const selectedDataDiv = document.getElementById('selectedData');
                    const cfg = DIMENSION_MAPPING_3P[emissionType];
                    const nameMap = {
                        procurement:'Raw Material Procurement',manufacturing:'Manufacturing',logistics:'Logistics Transportation',usage:'Product Usage',recycling:'Recycling Processing',decomposition:'Natural Decomposition'
                    };
                    const moduleType = document.querySelector('.nav-tab.active')?.dataset.module || 'kanban';

                    // 细分明细
                    let breakdown = emissionData && emissionData.breakdown;
                    if (!breakdown && window.analysisData && window.analysisData.emissions) {
                        breakdown = {};
                        cfg.components.forEach(c => breakdown[c] = window.analysisData.emissions[c]?.value || 0);
                    }

                    const brHTML = breakdown ? (
                        '<ul style="margin-top:8px; line-height:1.6">' +
                        cfg.components.map(c => `<li>${nameMap[c] || c}: <strong>${breakdown[c] ?? 0}</strong></li>`).join('') +
                        '</ul>'
                    ) : '';

                    selectedDataDiv.innerHTML = `
                        <h4>Selected Data: ${cfg.name}</h4>
                        <p>Stage Total Carbon Emissions: <strong>${(emissionData && emissionData.value) ?? '-'}</strong></p>
                        <p>Included Stages: ${cfg.desc}</p>
                        ${brHTML}
                        <div class="chat-history" id="chatHistory" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                            <h5><i class="fas fa-history"></i> Conversation History</h5>
                            <div class="history-messages" id="historyMessages" style="max-height: 200px; overflow-y: auto;">
                                ${(typeof window.renderChatHistory === 'function') ? window.renderChatHistory(moduleType, emissionType) : ''}
                            </div>
                        </div>
                    `;

                    modal.setAttribute('data-module', moduleType);
                    modal.setAttribute('data-emission-type', emissionType);
                    modal.style.display = 'flex';
                } catch (e) {
                    if (typeof original.openAIModal === 'function') return original.openAIModal(emissionType, emissionData);
                }
            };

            // 覆盖Lean模块的卡片生成为三阶段聚合
            window.generateEmissionCardsForLean = function () {
                try {
                    const emissions = (window.analysisData && window.analysisData.emissions) || {};
                    const grouped = aggregateEmissions(emissions);
                    const order = ['production','circulation','endoflife'];
                    return order.map(key => {
                        const cfg = DIMENSION_MAPPING_3P[key];
                        const e = grouped[key];
                        return `
                            <div class="data-card" data-phase="${key}" onclick="openAIModal('${key}', ${JSON.stringify({ value: 0 })})">
                                <div class="card-icon"><i class="${cfg.icon}"></i></div>
                                <div class="card-content">
                                    <h4>${cfg.name}</h4>
                                    <div class="emission-value">${e.value}<span class="unit"> kgCO2e</span></div>
                                    <div class="improvement-indicator">Aggregated: ${cfg.desc}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (e) {
                    if (typeof original.generateEmissionCardsForLean === 'function') return original.generateEmissionCardsForLean();
                    return '';
                }
            };

            window.generateTimelineCardsHtml = function () {
                try {
                    const timeline = (window.analysisData && window.analysisData.timeline) || {};
                    const t3 = aggregateTimeline(timeline);
                    const order = ['production','circulation','endoflife'];
                    return order.map(key => {
                        const cfg = DIMENSION_MAPPING_3P[key];
                        const t = t3[key];
                        return `
                            <div class="data-card" data-phase="${key}">
                                <div class="card-icon"><i class="${cfg.icon}"></i></div>
                                <div class="card-content">
                                    <h4>${cfg.name}</h4>
                                    <div class="duration-value">${t.duration}<span class="unit"> ${t.unit}</span></div>
                                    <div class="improvement-indicator">Aggregated: ${cfg.desc}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (e) {
                    if (typeof original.generateTimelineCardsHtml === 'function') return original.generateTimelineCardsHtml();
                    return '';
                }
            };

            // 首屏：若Kanban模块已展示，刷新为三阶段视图
            try {
                if (document.getElementById('kanban-module')?.classList.contains('active')) {
                    if (typeof window.analysisData !== 'undefined') {
                        window.renderTimeline(window.analysisData.timeline);
                        window.renderEmissionCards();
                    }
                }
            } catch (_) {}
        })();
    </script>
</body>
</html>